<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="PANJU's Note" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="笔记——记录工作和学习中的点点滴滴">
<meta property="og:type" content="website">
<meta property="og:title" content="PANJU's Note">
<meta property="og:url" content="http://panzeyong.com/page/5/index.html">
<meta property="og:site_name" content="PANJU's Note">
<meta property="og:description" content="笔记——记录工作和学习中的点点滴滴">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PANJU's Note">
<meta name="twitter:description" content="笔记——记录工作和学习中的点点滴滴">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://panzeyong.com/page/5/"/>





  <title>PANJU's Note</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">PANJU's Note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">故不积跬步，无以至千里；不积小流，无以成江海。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://panzeyong.com/2017/07/25/第八章-BOM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="PANJU">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PANJU's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/第八章-BOM/" itemprop="url">第八章 BOM</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-25T07:42:23+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/25/第八章-BOM/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/07/25/第八章-BOM/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/25/第八章-BOM/" class="leancloud_visitors" data-flag-title="第八章 BOM">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、window-对象"><a href="#一、window-对象" class="headerlink" title="一、window 对象"></a>一、window 对象</h2><h3 id="1、全局作用域"><a href="#1、全局作用域" class="headerlink" title="1、全局作用域"></a>1、全局作用域</h3><p>window 对象具有双重角色</p>
<ul>
<li><p>通过 JavaScript 访问浏览器窗口的一个接口；</p>
</li>
<li><p>ECMAScript 规定的 Global 对象。</p>
</li>
</ul>
<p>定义全局变量与在 window 对象上直接定义属性区别：全局变量不能通过 delete 操作符删除，而直接在 window 对象上定义的属性可以。</p>
<p>尝试访问未声明的变量会抛出错误，但是通过查询 window 对象，可以知道某个可能未声明的变量是否存在。</p>
<p>书中例子如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义全局变量</span></div><div class="line"><span class="keyword">var</span> age = <span class="number">29</span>;</div><div class="line"></div><div class="line"><span class="comment">// 在 window 对象上定义属性</span></div><div class="line"><span class="built_in">window</span>.color = <span class="string">"Green"</span>;</div><div class="line"></div><div class="line"><span class="comment">// 在 IE &lt; 9 时抛出错误，在其他所以浏览器中都返回 false</span></div><div class="line">alert(<span class="keyword">delete</span> <span class="built_in">window</span>.age);</div><div class="line"></div><div class="line"><span class="comment">// 在 IE &lt; 9 时抛出错误，在其他所以浏览器中都返回 true</span></div><div class="line">alert(<span class="keyword">delete</span> <span class="built_in">window</span>.color);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayAge</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	alert(<span class="keyword">this</span>.age);</div><div class="line">&#125;</div><div class="line"></div><div class="line">alert(age);</div><div class="line">alert(<span class="built_in">window</span>.age);</div><div class="line"></div><div class="line">sayAge();</div><div class="line"><span class="built_in">window</span>.sayAge();</div><div class="line"></div><div class="line">alert(<span class="built_in">window</span>.color);</div></pre></td></tr></table></figure>
<h3 id="2、窗口关系以及框架"><a href="#2、窗口关系以及框架" class="headerlink" title="2、窗口关系以及框架"></a>2、窗口关系以及框架</h3><p>每个框架（frame）都拥有自己的 window 对象，并且保存在 frames 集合钟；每个 window 对象都有一个 name 属性，包含框架名称。</p>
<p>top 对象：始终指向最高（最外）层的框架，也就是浏览器窗口；使用它可以确保在一个框架中正确第访问另外一个框架。（当网页有框架的情况下，window 对象指向的是每个框架特定的实例，与 top 对象不相等；反之，则相同。）</p>
<p>parent 对象：始终指向当前框架的直接上层框架。（当网页有框架的情况下，parent 不一定等于 top；反之，则一定相等。）</p>
<p>self 对象：始终指向 window，可以与 window 对象互换使用。引入该对象的目的只是为了与 top 和 parent 对象对应起来。</p>
<p>top、parent、self 等对象其实都是 window 的属性，也就是说，可以通过 window.top、window.parent 等访问。</p>
<p>访问框架的方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 不推荐，因为在有框架的网页中，每个 window 对象都是指向框架的特定实例，而非指向最外层框架。</span></div><div class="line"><span class="built_in">window</span>.frames[index]</div><div class="line"><span class="built_in">window</span>.frames[<span class="string">"框架名称"</span>]</div><div class="line"></div><div class="line"><span class="comment">// 推荐，因为始终指向最高（最外）层的框架，也就是浏览器窗口</span></div><div class="line">top.frames[index]</div><div class="line">top.frames[<span class="string">"框架名称"</span>]</div><div class="line"></div><div class="line"><span class="comment">// 通过集合访问</span></div><div class="line">frames[index]</div><div class="line">frames[<span class="string">"框架名称"</span>]</div></pre></td></tr></table></figure>
<h3 id="3、窗口位置"><a href="#3、窗口位置" class="headerlink" title="3、窗口位置"></a>3、窗口位置</h3><p>screenLeft、screenTop、screenX、screenY 这四个属性在各个浏览器中使用情况：</p>
<table><tr align="center"><td width="25%" align="center">浏览器 / 属性</td><td width="15%" align="center">IE</td><td width="15%" align="center">Chrome</td><td width="15%" align="center">Sarari</td><td width="15%" align="center">Opera</td><td width="15%" align="center">Firefox</td></tr><tr align="center"><td>screenLeft</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td><td>不支持</td></tr><tr align="center"><td>screenTop</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td><td>不支持</td></tr><tr align="center"><td>screenX</td><td>不支持</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr align="center"><td>screenY</td><td>不支持</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr></table>

<p>跨浏览器获取窗口左边和上边的位置的示例代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> leftPos = (<span class="keyword">typeof</span> <span class="built_in">window</span>.screenLeft == <span class="string">"number"</span>) ? <span class="built_in">window</span>.screenLeft : <span class="built_in">window</span>.screenX;</div><div class="line"><span class="keyword">var</span> topPos = (<span class="keyword">typeof</span> <span class="built_in">window</span>.screenTop == <span class="string">"number"</span> )? <span class="built_in">window</span>.screenTop : <span class="built_in">window</span>.screenY;</div></pre></td></tr></table></figure>
<h3 id="4、窗口大小"><a href="#4、窗口大小" class="headerlink" title="4、窗口大小"></a>4、窗口大小</h3><p>innerWidth、innerHeight、outerWidth、outerHegiht 这四个属性在以下浏览器是支持的，不同的是获取的值，具体情况如下：</p>
<table><tr align="center"><td width="25%">浏览器 / 属性</td><td width="15%">IE9+</td><td width="15%">Chrome</td><td width="15%">Sarari</td><td width="15%">Opera</td><td width="15%">Firefox</td></tr><tr align="center"><td>innerWidth</td><td>页面视图区的大小（减去边框宽度）</td><td>视口（viewport）大小而非浏览器窗口的大小</td><td>页面视图区的大小（减去边框宽度）</td><td>页面视图区的大小（减去边框宽度）</td><td>页面视图区的大小（减去边框宽度）支持</td></tr><tr align="center"><td>innerHeight</td><td>页面视图区的大小（减去边框宽度）</td><td>视口（viewport）大小而非浏览器窗口的大小</td><td>页面视图区的大小（减去边框宽度）</td><td>页面视图区的大小（减去边框宽度）</td><td>不页面视图区的大小（减去边框宽度）</td></tr><tr align="center"><td>outerWidth</td><td>返回浏览器本身窗口的大小</td><td>视口（viewport）大小而非浏览器窗口的大小</td><td>返回浏览器本身窗口的大小</td><td>页面视图容器大小（单个标签页对应的浏览器窗口）</td><td>返回浏览器本身窗口的大小</td></tr><tr align="center"><td>outerHeight</td><td>返回浏览器本身窗口的大小</td><td>视口（viewport）大小而非浏览器窗口的大小</td><td>返回浏览器本身窗口的大小</td><td>页面视图容器大小（单个标签页对应的浏览器窗口）</td><td>返回浏览器本身窗口的大小</td></tr></table>

<p>document.documentElement.clientWidth、document.documentElement.clientHeight、document.body.clientWidth、document.body.clientHeight 这四个属性作用主要是保存页面视口信息，在不同浏览器使用情况如下：</p>
<table><tr align="center"><td width="50%">浏览器 / 属性</td><td width="10%">IE</td><td width="10%">Chrome</td><td width="10%">Sarari</td><td width="10%">Opera</td><td width="10%">Firefox</td></tr><tr align="center"><td>document.documentElement.clientWidth</td><td>支持（IE6 中标准模式）</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr align="center"><td>document.documentElement.clientHeight</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr align="center"><td>document.body.clientWidth</td><td>支持（混杂模式）</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr align="center"><td>document.body.clientHeight</td><td>支持（混杂模式）</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr></table>

<p>获取页面视口大小示例代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> pageWidth = <span class="built_in">window</span>.innerWidth;</div><div class="line"><span class="keyword">var</span> pageHeight = <span class="built_in">window</span>.innerHeight;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> pageWidth != <span class="string">"number"</span>) &#123;</div><div class="line">	<span class="keyword">if</span> (<span class="built_in">document</span>.compatMode == <span class="string">"CSS1Compat"</span>) &#123;</div><div class="line">		pageWidth = <span class="built_in">document</span>.documentElement.clientWidth;</div><div class="line">		pageHeight = <span class="built_in">document</span>.documentElement.clientHeight;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		pageWidth = <span class="built_in">document</span>.body.clientWidth;</div><div class="line">		pageHeight = <span class="built_in">document</span>.body.clientHeight;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5、导航和打开窗口"><a href="#5、导航和打开窗口" class="headerlink" title="5、导航和打开窗口"></a>5、导航和打开窗口</h3><p><strong>window.open()：</strong>既可以导航到特定的 URL，也可以打开一个新的浏览器窗口。接收 4 个参数，具体如下：</p>
<ul>
<li><p>加载的 URL；</p>
</li>
<li><p>窗口目标：_self、_parent、_top、_blank（指定窗口的话就在该窗口打开 URL；没有的话就根据浏览器设置打开新标签页或者打开新的窗口）；</p>
</li>
<li><p>特性字符串：不允许出现空格；</p>
</li>
<li><p>布尔值（表示新页面是否取代浏览器历史记录中当前加载页面）</p>
</li>
</ul>
<p>第三个参数设置窗口特性，具体如下：</p>
<table><tr align="center"><td width="20%">设置</td><td width="20%">值</td><td width="60%">说明</td></tr><tr align="center"><td width="20%">fullscreen</td><td width="20%">yes / no</td><td width="60%">表示浏览器窗口是否最大化。仅限 IE</td></tr><tr align="center"><td width="20%">height</td><td width="20%">数值</td><td width="60%">表示新窗口的高度。不能小于 100</td></tr><tr align="center"><td width="20%">left</td><td width="20%">数值</td><td width="60%">表示新窗口的左坐标。不能是负值</td></tr><tr align="center"><td width="20%">location</td><td width="20%">yes / no</td><td width="60%">表示是否在浏览器窗口中显示地址栏。不同浏览器的默认值不同。如果设置为 no，地址栏可能会隐藏，也可能会被禁止（取决于浏览器）</td></tr><tr align="center"><td width="20%">menubar</td><td width="20%">yes / no</td><td width="60%">表示是否在浏览器窗口中显示菜单栏。默认值为 no</td></tr><tr align="center"><td width="20%">resizeable</td><td width="20%">yes / no</td><td width="60%">表示是否可以通过拖动浏览器窗口的边框改变其大小。默认值为 no</td></tr><tr align="center"><td width="20%">scrollbars</td><td width="20%">yes / no</td><td width="60%">表示如果内容在视口中显示不下，是否允许滚动。默认值为 no</td></tr><tr align="center"><td width="20%">status</td><td width="20%">yes / no</td><td width="60%">表示是否在浏览器窗口中显示状态栏。默认值 no</td></tr><tr align="center"><td width="20%">toolbar</td><td width="20%">yes / no</td><td width="60%">表示是否在浏览器窗口中显示工具栏。默认值为 no</td></tr><tr align="center"><td width="20%">top</td><td width="20%">数值</td><td width="60%">表示新窗口的上坐标。不能是负值</td></tr><tr align="center"><td width="20%">width</td><td width="20%">数值</td><td width="60%">表示新窗口的宽度。不能小于 100</td></tr></table>

<p><strong>opener</strong>：新创建窗口属性，保存着打开它的原始窗口对象。opener 设置为 null，表示在单独的进程中运行新标签页。（Chrome）</p>
<p><strong>屏蔽弹出窗口方式：</strong></p>
<ul>
<li><p>浏览器内置的屏蔽程序阻止的弹出窗口，window.open 很可能返回 null。</p>
</li>
<li><p>浏览器扩展或者其它程序阻止的弹出窗口，window.open() 通常会抛出一个错误。</p>
</li>
</ul>
<p>示例代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> blocked = <span class="literal">false</span>;</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">	<span class="keyword">var</span> baiduWin = <span class="built_in">window</span>.open(<span class="string">"http://www.baidu.com"</span>, <span class="string">"topFrame"</span>, <span class="string">"height=400,widht=600,left=25,top=25,location=no,menubar=no,resizable=true,scrollbars=yes,status=no,toolbar=no"</span>);</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (<span class="literal">null</span> == baiduWin) &#123;</div><div class="line">		blocked = <span class="literal">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125; <span class="keyword">catch</span> (ex) &#123;</div><div class="line">	blocked = <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (blocked) &#123;</div><div class="line">	alert(<span class="string">"The popup was blocked !"</span>);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	alert(<span class="string">"The popup was not blocked !"</span>);</div><div class="line">	alert(baiduWin);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6、间歇调用和超时调用"><a href="#6、间歇调用和超时调用" class="headerlink" title="6、间歇调用和超时调用"></a>6、间歇调用和超时调用</h3><p>一般认为，使用超时调用来模拟间歇调用的是一种最佳模式。在开发环境下，很少使用真正的间歇调用，原因是后一个间歇调用可能会在前一个间歇调用结束之前启动。</p>
<p><strong>setTimeout()</strong>：超时调用,返回一个数值 ID，表示唯一标识。接收两个参数：要执行的代码和以毫秒表示的时间（即在执行代码前需要等待多时毫秒）</p>
<p><strong>setInterval()</strong>：间歇调用。接收两个参数：要执行的代码和每次执行之前需要等待的毫秒数。</p>
<p><strong>clearTimeout()</strong>：根据相应的 id 取消调用。</p>
<p>示例代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	alert(<span class="string">"Hello World !"</span>);</div><div class="line">&#125;, <span class="number">1000</span>);</div><div class="line"></div><div class="line">setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	alert(<span class="string">"Hello World"</span>);</div><div class="line">&#125;, <span class="number">1000</span>);</div></pre></td></tr></table></figure>
<h3 id="7、系统对话框"><a href="#7、系统对话框" class="headerlink" title="7、系统对话框"></a>7、系统对话框</h3><p><strong>alert()：</strong>警告框。</p>
<p><strong>comfirm()：</strong>确认对话框。</p>
<p><strong>prompt()：</strong>提示对话框。</p>
<p><strong>window.print()：</strong>打印。</p>
<p><strong>window.find()：</strong>查找。</p>
<p>示例代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">alert(<span class="string">"Hello World !"</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (confirm(<span class="string">"Are you sure ?"</span>)) &#123;</div><div class="line">	alert(<span class="string">"I'm so glad you're sure !"</span>);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	alert(<span class="string">"I'm sorry to hear you're not sure ."</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> result = prompt(<span class="string">"What is your name ? "</span>, <span class="string">""</span>);</div><div class="line"><span class="keyword">if</span> (<span class="literal">null</span> != result) &#123;</div><div class="line">	alert(<span class="string">"Welcome, "</span> + result);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="二、location-对象"><a href="#二、location-对象" class="headerlink" title="二、location 对象"></a>二、location 对象</h2><p>location 对象不仅提供与当前窗口中加载的文档有关的信息，还提供了一些导航功能以及将 URL 解析为独立的片段。window.location 和 document.location 引用的同是一个对象，即 location 对象。</p>
<p>location 对象所有属性如下表：</p>
<table><tr align="center"><td width="25%">属性名</td><td width="25%">例子</td><td width="50%">说明</td></tr><tr align="center"><td>hash</td><td>“#contents”</td><td>返回 URL 中的 hash（# 号后跟或多个字符），如果 URL 中不包含散列，则返回空字符串</td></tr><tr align="center"><td>host</td><td>“www.wrox.com:80”</td><td>返回服务器名称和端口号（如果有）</td></tr><tr align="center"><td>hostname</td><td>“www.wrox.com”</td><td>返回不带端口号的服务器名称</td></tr><tr align="center"><td>href</td><td>“<a href="http://www.wrox.com" target="_blank" rel="external">http://www.wrox.com</a>“</td><td>返回当前加载页面的完整 URL。而 location 对象的 toString() 方法也返回这个值</td></tr><tralign="center"><td>pathname</td><td>“/WileyCDA”</td><td>返回 URL 中的目录和（或）文件名</td><tr align="center"><td>port</td><td>“8080”</td><td>返回 URL 中指定的端口号。如果 URL 中不包含端口号，则这个属性返回空字符串</td></tr><tr align="center"><td>protocol</td><td>“http”</td><td>返回页面使用的协议。通常是 http: 或 https:</td></tr><tr align="center"><td>search</td><td>“?q=javascript”</td><td>返回 URL 的查询字符串。这个字符串以问号开头</td></tr></tralign="center"></table>

<p>查询参数示例代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getQueryStringArgs</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> qs = (location.search.length &gt; <span class="number">0</span> ? location.search.substring(<span class="number">1</span>) : <span class="string">""</span>);</div><div class="line"></div><div class="line">	args = &#123;&#125;;</div><div class="line"></div><div class="line">	items = qs.length ? qs.split(<span class="string">"&amp;"</span>) : [];</div><div class="line">	item = <span class="literal">null</span>;</div><div class="line">	name = <span class="literal">null</span>;</div><div class="line">	value = <span class="literal">null</span>;</div><div class="line"></div><div class="line">	i = <span class="number">0</span>;</div><div class="line">	len = items.length;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">		item = items[i].split(<span class="string">"="</span>);</div><div class="line">		name = <span class="built_in">decodeURIComponent</span>(item[<span class="number">0</span>]);</div><div class="line">		value = <span class="built_in">decodeURIComponent</span>(item[<span class="number">1</span>]);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (name.length) &#123;</div><div class="line">			args[name] = value;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> args;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>位置操作方法：</p>
<ul>
<li><p><strong>location.assign(url)</strong>：立即打开新 URL 并在浏览器的历史记录中生成一条记录。<strong>location.href</strong> 与 <strong>window.location</strong> 效果与之一样。</p>
</li>
<li><p><strong>location.replace(url)</strong>：打开新 URL，但是不会下历史记录中生成新记录。</p>
</li>
<li><p><strong>location.reload()</strong>：重新加载当前显示的页面。可接收参数，比如 true，表示从服务器加载。</p>
</li>
</ul>
<h2 id="三、navigator-对象"><a href="#三、navigator-对象" class="headerlink" title="三、navigator 对象"></a>三、navigator 对象</h2><p>navigator 对象属性如下表：</p>
<table><tr align="center"><th width="20%">属性或方法</th><th width="34%">说明</th><th width="8%">IE</th><th width="10%">Firefox</th><th width="18%">Safari/Chrome</th><th width="10%">Opera</th></tr><tr align="center"><td>appCodeName</td><td>浏览器的名称。通常都是 Mozilla，即使在非 Mozilla 浏览器也是如此</td><td>3.0+</td><td>1.0+</td><td>1.0+</td><td>7.0+</td></tr><tr align="center"><td>appMinorVersion</td><td>此版本信息</td><td>4.0+</td><td>-</td><td>-</td><td>9.5+</td></tr><tr align="center"><td>appName</td><td>完整的浏览器名称</td><td>3.0+</td><td>1.0+</td><td>1.0+</td><td>7.0+</td></tr><tr align="center"><td>appVersion</td><td>浏览器的版本。一般不与实际的浏览器版本对应</td><td>3.0+</td><td>1.0+</td><td>1.0+</td><td>7.0+</td></tr><tr align="center"><td>buildId</td><td>浏览器编译版本</td><td>-</td><td>2.0+</td><td>-</td><td>-</td></tr><tr align="center"><td>cookieEnabled</td><td>表示 cookie 是否启用</td><td>4.0+</td><td>1.0+</td><td>1.0+</td><td>7.0+</td></tr><tr align="center"><td>cpuClass</td><td>客户端计算机中使用的 CPU 类型（x86、68K、Alpha、PPC 或 Other）</td><td>4.0+</td><td>-</td><td>-</td><td>-</td></tr><tr align="center"><td>javaEnabled()</td><td>表示当前浏览器中是否启用了 Java</td><td>4.0+</td><td>1.0+</td><td>1.0+</td><td>7.0+</td></tr><tr align="center"><td>language</td><td>浏览器的主语言</td><td>4.0+</td><td>1.0+</td><td>1.0+</td><td>7.0+</td></tr><tr align="center"><td>mimeTypes</td><td>在浏览器中注册的 MIME 类型数组</td><td>4.0+</td><td>1.0+</td><td>1.0+</td><td>7.0+</td></tr><tr align="center"><td>onLine</td><td>表示浏览器是否连接到因特网</td><td>4.0+</td><td>1.0+</td><td>-</td><td>9.5+</td></tr><tr align="center"><td>oscpu</td><td>客户端计算机的操作系统或使用的 CPU</td><td>-</td><td>1.0+</td><td>-</td><td>-</td></tr><tr align="center"><td>platform</td><td>浏览器所在的系统平台</td><td>4.0+</td><td>1.0+</td><td>1.0+</td><td>7.0+</td></tr><tr align="center"><td>plugins</td><td>浏览器中安装的插件信息的数组</td><td>4.0+</td><td>1.0+</td><td>1.0+</td><td>7.0+</td></tr><tr align="center"><td>preference()</td><td>设置用户的首选项</td><td>-</td><td>1.5+</td><td>-</td><td>-</td></tr><tr align="center"><td>product</td><td>产品名称（如 Gecko）</td><td>-</td><td>1.0+</td><td>1.0+</td><td>-</td></tr><tr align="center"><td>productSub</td><td>关于产品的次要信息（如 Gecko 版本）</td><td>-</td><td>1.0+</td><td>1.0+</td><td>-</td></tr><br><tr align="center"><td>systemLanguage</td><td>操作系统的语言</td><td>4.0+</td><td>-</td><td>-</td><td>-</td></tr><tr align="center"><td>userAgent</td><td>浏览器的用户代理字符串</td><td>3.0+</td><td>1.0+</td><td>1.0+</td><td>7.0+</td></tr><tr align="center"><td>userLanguage</td><td>操作系统的默认语言</td><td>4.0+</td><td>-</td><td>-</td><td>7.0+</td></tr><tr align="center"><td>userProfile</td><td>借以访问用户个人信息的对象</td><td>4.0+</td><td>-</td><td>-</td><td>-</td></tr><tr align="center"><td>vendor</td><td>浏览器的品牌</td><td>-</td><td>1.0+</td><td>1.0+</td><td>-</td></tr><tr align="center"><td>vendorSub</td><td>有关供应商的次要信息</td><td>-</td><td>1.0+</td><td>1.0+</td><td>-</td></tr></table>

<h3 id="检测插件"><a href="#检测插件" class="headerlink" title="检测插件"></a>检测插件</h3><p>对于非 IE 浏览器，可以使用 navigator 对象提供的 plugins 属性来检测浏览器插件信息，返回的是数组。该数组中的每一项都包含以下属性：</p>
<ul>
<li><p>name：插件的名字。</p>
</li>
<li><p>description：插件的描述。</p>
</li>
<li><p>filename：插件的文件名。</p>
</li>
<li><p>length：插件所处理的 MIME 类型数量。</p>
</li>
</ul>
<p>检测插件示例代码（在 IE 中无效）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasPlugin</span>(<span class="params">name</span>) </span>&#123;</div><div class="line">	name = name.toLowerCase();</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; navigator.plugins.length; i++) &#123;</div><div class="line">		<span class="keyword">if</span> (navigator.plugins[i].name.toLowerCase().indexOf(name) &gt; <span class="number">-1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>检测插件示例代码（只在 IE 中有效）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasIEPlugin</span>(<span class="params">name</span>) </span>&#123;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">new</span> ActiveXObject(name);</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">	&#125; <span class="keyword">catch</span> (ex) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="四、screen-对象"><a href="#四、screen-对象" class="headerlink" title="四、screen 对象"></a>四、screen 对象</h2><p>用来表明客户端的能力，其中包括浏览器窗口外部的显示器信息，比如像素宽度和高度。</p>
<p>screen 对象各种属性如下表：</p>
<table><tr><th width="30%">属性</th><th width="30%">说明</th><th width="10%">IE</th><th width="10%">Firefox</th><th width="10%">Safari / Chrome</th><th width="10%">Opera</th></tr><tr align="center"><td>availHeight</td><td>屏幕的像素高度减系统部件高度之后的值（只读）</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr align="center"><td>availLeft</td><td>未被系统部件占用的最左侧的像素值（只读）</td><td>不支持</td><td>支持</td><td>支持</td><td>不支持</td></tr><tr align="center"><td>availTop</td><td>未被系统部件占用的最上方的像素值（只读）</td><td>不支持</td><td>支持</td><td>支持</td><td>不支持</td></tr><tr align="center"><td>availWidth</td><td>屏幕的像素宽度减去系统部件宽度之后的值（只读）</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr align="center"><td>bufferDepth</td><td>读、写用于呈现屏外位图的位数</td><td>支持</td><td>不支持</td><td>不支持</td><td>不支持</td></tr><tr align="center"><td>colorDepth</td><td>用于表现颜色的位数；多数系统是 32（只读）</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>deviceXDPI</td><td>屏幕实际的水平 DPI（只读）</td><td>支持</td><td>不支持</td><td>不支持</td><td>不支持</td></tr><tr align="center"><td>deviceYDPI</td><td>屏幕实际的垂直 DPI（只读）</td><td>支持</td><td>不支持</td><td>不支持</td><td>不支持</td></tr><tr align="center"><td>fontSmooth / ingEnabled</td><td>表示是否启用字体平滑（只读）</td><td>支持</td><td>不支持</td><td>不支持</td><td>不支持</td></tr><tr align="center"><td>height</td><td>屏幕的像素高度</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr align="center"><td>left</td><td>当前屏幕距离左边的像素距离</td><td>不支持</td><td>支持</td><td>不支持</td><td>不支持</td></tr><tr align="center"><td>logicalXDPI</td><td>屏幕逻辑的水平 DPI（只读）</td><td>支持</td><td>不支持</td><td>不支持</td><td>不支持</td></tr><tr align="center"><td>logicalYDPI</td><td>屏幕逻辑的垂直 DPI（只读）</td><td>支持</td><td>不支持</td><td>不支持</td><td>不支持</td></tr><tr align="center"><td>pixelDepth</td><td>屏幕的位深</td><td>不支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr align="center"><td>top</td><td>当前屏幕距上边的像素距离</td><td>不支持</td><td>支持</td><td>不支持</td><td>不支持</td></tr><tr align="center"><td>updateInterval</td><td>读、写以毫秒表示的屏幕刷新时间间隔</td><td>支持</td><td>不支持</td><td>不支持</td><td>不支持</td></tr><tr align="center"><td>width</td><td>屏幕的像素宽度</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr></table>

<h2 id="history-对象"><a href="#history-对象" class="headerlink" title="history 对象"></a>history 对象</h2><p>history 对象保存着用户上网的的历史记录。</p>
<p><strong>go()</strong>：在用户的历史记录中任意跳转，可以向其也可以向后。该方法接收一个参数，正数表示向前，负数表示向后。</p>
<p><strong>back()</strong>：后退。</p>
<p><strong>forward()</strong>：前进。</p>
<p>以上是在学习 《JavaScript 高级程序设计》（第 3 版）这本书第八章的学习笔记，主要把书中讲到的要点记录下来，方便自己查找。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://panzeyong.com/2017/07/10/第七章-函数表达式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="PANJU">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PANJU's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/10/第七章-函数表达式/" itemprop="url">第七章 函数表达式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-10T07:11:07+08:00">
                2017-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/10/第七章-函数表达式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/07/10/第七章-函数表达式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/10/第七章-函数表达式/" class="leancloud_visitors" data-flag-title="第七章 函数表达式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、创建函数方式"><a href="#一、创建函数方式" class="headerlink" title="一、创建函数方式"></a>一、创建函数方式</h2><h3 id="1、函数声明"><a href="#1、函数声明" class="headerlink" title="1、函数声明"></a>1、函数声明</h3><p>声明函数使用的关键字是 function，紧接着是指定函数名及函数体。每个函数都定义一个非标准的 <strong>name</strong> 属性，通过该属性可以访问到给函数指定的名字。对于函数声明来说，有一个重要特征就是<strong>函数提升</strong>，即在执行代码之前会先读取函数声明。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	alert(<span class="string">"函数声明"</span>);</div><div class="line">	alert(create.name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2、函数表达式（匿名函数、拉姆达函数）"><a href="#2、函数表达式（匿名函数、拉姆达函数）" class="headerlink" title="2、函数表达式（匿名函数、拉姆达函数）"></a>2、函数表达式（匿名函数、拉姆达函数）</h3><p>创建一个函数并将其赋值给一个变量，这样的创建的函数也可以称为匿名函数或者拉达姆函数。匿名函数的 name 属性是空字符串。使用这种方式创建函数时，必须<strong>先赋值才可以使用</strong>，否则会报错。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> create = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	alert(<span class="string">"函数表达式"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="二、闭包"><a href="#二、闭包" class="headerlink" title="二、闭包"></a>二、闭包</h2><p>闭包是指有权访问另一个函数作用域中的变量的函数。而创建闭包的常用方式，就是在一个函数内部创建另一个函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComparisonFunction</span>(<span class="params">propertyName</span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"create Comparison Function"</span>);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">object1, object2</span>) </span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">"Any"</span>);</div><div class="line">		<span class="keyword">var</span> value1 = object1[propertyName];</div><div class="line">		<span class="keyword">var</span> value2 = object2[propertyName];</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (value1 &lt; value2) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (value1 &gt; value2) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="1、理解作用域链"><a href="#1、理解作用域链" class="headerlink" title="1、理解作用域链"></a>1、理解作用域链</h3><p>当某个函数被调用时，系统会创建一个<strong>执行环境</strong>以及相应的<strong>作用域链</strong>；此时会有一个函数的<strong>活动对象</strong>（变量对象），包含 <strong>arguments</strong> 和其它命名参数。该活动对象会加入到作用域链的前端，并且作用域链的终点是全局执行环境。</p>
<p>在创建函数时，系统会创建一个预先包含全局变量对象的作用域链，这个作用域链被保存在内部的 [[Scope]] 属性中。当调用该函数时，会为函数创建一个执行环境，然后通过复制函数的 [[Scope]] 属性中的对象构建起执行环境的作用域链。</p>
<p>作用域链本质上是一个指向变量对象的指针列表，它只引用但不实际包含变量对象。</p>
<p>函数的执行环境只存在于函数的执行过程中，当执行结束后，活动对象及作用域链被销毁；而全局环境直到程序退出才被销毁。</p>
<p>对于闭包来说情况则不同，由于匿名函数的作用域包含了外部函数，即引用外部函数活动对象；因此，当外部函数执行完毕后，虽然其作用域链被销毁，但是其活动对象仍然留在内存中；直到匿名内部函数被销毁后，此活动对象才会被销毁。</p>
<h3 id="2、闭包与变量"><a href="#2、闭包与变量" class="headerlink" title="2、闭包与变量"></a>2、闭包与变量</h3><p>闭包只能取得包含函数中任意变量的最后一个值。记住闭包保存的是整个变量对象，而不是某个特殊的变量。</p>
<p>先来看一个例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFunctions</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"Create Function"</span>);</div><div class="line">	<span class="keyword">var</span> result = <span class="keyword">new</span> <span class="built_in">Array</span>();</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">"i : "</span> + i);</div><div class="line">		result[i] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">			<span class="built_in">console</span>.log(<span class="string">"Result"</span>);</div><div class="line">			<span class="keyword">return</span> i;</div><div class="line">		&#125;;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 返回的是函数数组</span></div><div class="line"><span class="keyword">var</span> result = createFunctions();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; result.length; i++) &#123;</div><div class="line">	alert(result[i]());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>估计很多人跟我一样以为输出的值应该是 0、1、…、9，然而结果却都是 10。说真的，我一开始也懵逼，不知道为什么，但是经过慢慢地调试，稍微了解原因，简单说下自己的理解吧。</p>
<p>当调用函数 <strong>createFunctions()</strong> 时，for 循环就会被执行，这时数组 result 保存着每次执行后的函数，等到执行完之后，i 的值已经变为 10 了；而由于每个函数的作用域链包含外部函数 <strong>createFunctions()</strong> 的活动对象，即共享外部函数变量；因此，调用函数数组中每个函数时的返回值都是 10。</p>
<p>那么如何才能做到每个函数的返回值是其索引呢？见以下例子（ps：书中例子）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFunctions</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> result = <span class="keyword">new</span> <span class="built_in">Array</span>();</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"Create Function"</span>);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">		result[i] = <span class="function"><span class="keyword">function</span>(<span class="params">num</span>) </span>&#123;</div><div class="line">			<span class="built_in">console</span>.log(<span class="string">"i : "</span> + i);</div><div class="line">			<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">				<span class="built_in">console</span>.log(<span class="string">"Number : "</span> + num);</div><div class="line">				<span class="keyword">return</span> num;</div><div class="line">			&#125;</div><div class="line">		&#125;(i);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> result = createFunctions();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; result.length; i++) &#123;</div><div class="line">	alert(result[i]();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>（ps：由于刚接触闭包这个知识点，对书中的例子还不是很理解，后续补上自己的理解。）</p>
<h3 id="3、关于-this-对象"><a href="#3、关于-this-对象" class="headerlink" title="3、关于 this 对象"></a>3、关于 this 对象</h3><p>this 对象是在运行时基于函数的执行环境绑定的：在全局函数中，this 等于 window，而当函数被作为某个对象的方法调用时，this 等于那个对象。但是匿名函数的执行环境具有全局性，因此其 this 对象通常指向 window。</p>
<p>每个函数被调用时自动取得两个特殊变量：this 和 arguments，那么跟 arguments 跟 this 存在同样的问题。如果想访问作用域中的 arguments 或 this 对象时，必须将该对象的引用保存到另一个闭包能够访问的变量中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> name = <span class="string">"The Window"</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> object = &#123;</div><div class="line">	name : <span class="string">"My Object"</span>,</div><div class="line"></div><div class="line">	getNameFunc : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">var</span> that = <span class="keyword">this</span>;        <span class="comment">// 关键在这行代码</span></div><div class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">			<span class="keyword">return</span> that.name;</div><div class="line">		&#125;;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="三、模仿块级作用域"><a href="#三、模仿块级作用域" class="headerlink" title="三、模仿块级作用域"></a>三、模仿块级作用域</h2><p>在函数中定义的局部变量的生命周期只局限于该函数，函数执行完之后，局部变量也就销毁。但是由于 JavaScript 没有块级作用域的概念，即在函数代码块中定义的变量在代码块之外也能访问到，为了解决这种问题，可以使用<strong>匿名函数模仿块级作用域（私有作用域）</strong>来解决。语法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">// 块级作用域</span></div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>JavaScript 将 function 关键字当作一个<strong>函数声明</strong>的开始，而<strong>函数声明</strong>后面不能跟圆括号。然而，<strong>函数表达式</strong>的后面可以跟圆括号。要将函数声明转换为函数表达式，只需给它加上一对圆括号。</p>
<p>私有作用域这种技术经常在全局作用域中被用在函数外部，从而限制向全局作用域中添加过多的变量和函数。一般来说，我们都应该尽量少向全局作用域中添加变量和函数。</p>
<p>私有作用域这种做法可以减少闭包占用的内存问题，因为没有指向匿名函数的引用。只要函数执行完毕，就可以立即销毁其作用域链。</p>
<p>引用书中例子，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">outputNumbers</span>(<span class="params">count</span>) </span>&#123;</div><div class="line">	(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">			alert(i);     </div><div class="line">		&#125;                                  <span class="comment">// 执行完之后 i 销毁</span></div><div class="line">	&#125;)();</div><div class="line">	</div><div class="line">	alert(i);                            <span class="comment">// 报错</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="四、私有变量"><a href="#四、私有变量" class="headerlink" title="四、私有变量"></a>四、私有变量</h2><p>任何在函数中定义的变量，都可以认为是私有变量，因为不能在函数的外部访问这些变量。私有变量一般包括函数的参数、局部变量和在函数内部定义的其它函数。</p>
<p><strong>特权方法：</strong>有权访问私有变量和私有函数的公有方法。</p>
<h3 id="1、创建特权方法的方式"><a href="#1、创建特权方法的方式" class="headerlink" title="1、创建特权方法的方式"></a>1、创建特权方法的方式</h3><p>第一种方法：在<strong>构造函数</strong>中定义特权方法（之所以能够在构造函数中定义特权方法，是因为特权方法作为闭包有权访问在构造函数中定义的所以变量和函数。）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyObject</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	</div><div class="line">	<span class="comment">// 私有变量和私有函数</span></div><div class="line">	<span class="keyword">var</span> privateVariable = <span class="number">10</span>;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">privateFunction</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// 特权方法</span></div><div class="line">	<span class="keyword">this</span>.publicMethod = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		privateVariable++;</div><div class="line">		<span class="keyword">return</span> privateFunction();</div><div class="line">	&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用该种方法的缺点是构造函数模式针对每个实例都会创建同样一组新方法，而使用静态私有变量来实现特权方法可以避免这个问题。</p>
<p>第二种方法：通过在私有作用域中定义私有变量或函数，也可以创建特权方法。（原型模式）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	</div><div class="line">	<span class="comment">// 私有变量和私有函数</span></div><div class="line">	<span class="keyword">var</span> privateVaribalbe = <span class="number">10</span>;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">privateFunction</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// 构造函数</span></div><div class="line">	MyObject = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	&#125;;</div><div class="line">	</div><div class="line">	<span class="comment">// 特权方法</span></div><div class="line">	MyObject.prototype.publicMethod = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		privateVariable++;</div><div class="line">		<span class="keyword">return</span> privateFunction();</div><div class="line">	&#125;;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>通过这种方式创建静态私有变量会因为使用原型而增进代码复用，但每个实例都没有自己的私有变量。</p>
<p>该方法与第一种方法的区别在于：私有变量和函数是由实例共享的。</p>
<h3 id="2、模块模式（道格拉斯）"><a href="#2、模块模式（道格拉斯）" class="headerlink" title="2、模块模式（道格拉斯）"></a>2、模块模式（道格拉斯）</h3><p>模块模式：为单例创建私有变量和特权方法。</p>
<p>模块模式使用场景：如果必须创建一个对象并以某些数据对其进行初始化，同时还要公开一些能够访问这些私有数据的方法。</p>
<p>JavaScript 是以对象字面量的方式来创建单例对象的。</p>
<p>模块模式模板：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> singleton = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">// 私有变量和私有函数</span></div><div class="line">	<span class="keyword">var</span> privateVariable = <span class="number">10</span>;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">privateFunction</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// 特权方法</span></div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		publicProperty: <span class="literal">true</span>;</div><div class="line">		</div><div class="line">		publicMethod: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">			privateVariable++;</div><div class="line">			<span class="keyword">return</span> privateFunction();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;();</div></pre></td></tr></table></figure>
<p>创建匿名函数并立即调用匿名函数，将对象字面量作为函数返回值，并将其赋值给变量 singleton；由于对象字面量通过特权方法访问匿名函数中私有变量和私有函数，因此变量 singleton 可以其进行访问。以这种方式创建的每个单例都是 Object 的实例。</p>
<h3 id="3、增强的模块模式"><a href="#3、增强的模块模式" class="headerlink" title="3、增强的模块模式"></a>3、增强的模块模式</h3><p>在返回对象之前加入对其增强的代码。这种增强的模块模式适合那些单例必须是<strong>某种类型的实例</strong>，同时还必须添加某些属性和（或）方法对其加以增强的情况。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> singleton = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">// 私有变量和私有函数</span></div><div class="line">	<span class="keyword">var</span> privateVariable = <span class="number">10</span>;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">privateFunction</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// 创建自定义类型对象</span></div><div class="line">	<span class="keyword">var</span> object = <span class="keyword">new</span> CustomType();</div><div class="line">	</div><div class="line">	</div><div class="line">	object.publicProperty: <span class="literal">true</span>;</div><div class="line">		</div><div class="line">	object.publicMethod: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		privateVariable++;</div><div class="line">		<span class="keyword">return</span> privateFunction();</div><div class="line">	&#125;;</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> object;</div><div class="line">&#125;();</div></pre></td></tr></table></figure>
<p>以上是在学习 《JavaScript 高级程序设计》（第 3 版）这本书第七章的学习笔记，主要把书中讲到的要点记录下来，方便自己查找。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://panzeyong.com/2017/07/09/Canvas-用法一-————-绘制图形/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="PANJU">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PANJU's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/09/Canvas-用法一-————-绘制图形/" itemprop="url">Canvas 用法一：绘制图形</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-09T12:19:11+08:00">
                2017-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/09/Canvas-用法一-————-绘制图形/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/07/09/Canvas-用法一-————-绘制图形/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/09/Canvas-用法一-————-绘制图形/" class="leancloud_visitors" data-flag-title="Canvas 用法一：绘制图形">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、Canvas-简介"><a href="#一、Canvas-简介" class="headerlink" title="一、Canvas 简介"></a>一、Canvas 简介</h2><p>Canvas 翻译过来为<strong>画布</strong>意思。这好比我们在学画画时，首先要有一块画板，然后使用各种彩色笔在画板上绘制各种各样的图形，最终会呈现给我们一幅优美的画。在这里，Canvas 就相当于画板，我们可以使用画笔在 Canvas 绘制各种各样的图形，最终画出我们想要的图形。</p>
<p>Canvas 是 Android 2D 绘制图形的继承，提供丰富的 API 接口，功能非常强大。根据官方文档的介绍，要绘制某些东西需要 4 中基本组件：</p>
<ul>
<li><p>持有像素的位图（Bitmap）；</p>
</li>
<li><p>画布（Canvas）；</p>
</li>
<li><p>绘图元素（Rect）；</p>
</li>
<li><p>画笔（Paint）。</p>
</li>
</ul>
<h2 id="二、Canvas-API-简介"><a href="#二、Canvas-API-简介" class="headerlink" title="二、Canvas API 简介"></a>二、Canvas API 简介</h2><table><tr><th width="20%">操作类型</th><th width="40%">相关 API</th><th width="40%">API 解释</th></tr><tr align="center"><td rowspan="4">绘制颜色</td><td>drawARGB(int a, int r, int g, int b)</td><td>使用 ARGB 填充整块画布</td></tr><tr align="center"><td>drawColor(int color)</td><td>使用颜色填充整块画布</td></tr><tr align="center"><td>drawColor(int color, PorterDuff.Mode mode)</td><td>使用颜色和 PorterDuff.Mode 填充整块画布</td></tr><tr align="center"><td>drawRGB(int r, int g, int b)</td><td>使用 RGB 填充整块画布</td></tr><tr align="center"><td rowspan="3">绘制点</td><td>drawPoint(float x, float y, Paint paint)</td><td>绘制单个点</td></tr><tr align="center"><td>drawPoints(float[] pts, Paint paint)</td><td>绘制一组点</td></tr><tr align="center"><td>drawPoints(float[] pts, int offset, int count, Paint paint)</td><td>绘制一系列点</td></tr><tr align="center"><td rowspan="3">绘制直线</td><td>drawLine(float startX, float startY, float stopX, float stopY, Paint paint)</td><td>使用画笔绘制直线</td></tr><tr align="center"><td>drawLines(float[] pts, Paint paint)</td><td>使用画笔绘制一组直线</td></tr><tr align="center"><td>drawLines(float[] pts, int offset, int count, Paint paint)</td><td>使用画笔绘制一系列直线</td></tr><tr align="center"><td rowspan="3">绘制矩形</td><td>drawRect(float left, float top, float right, float bottom, Paint paint)</td><br><td rowspan="3">使用画笔绘制矩形</td></tr><tr align="center"><td>drawRect(Rect r, Paint paint)</td></tr><tr align="center"><td>    drawRect(RectF rect, Paint paint)</td></tr><tr align="center"><td rowspan="2">绘制圆角矩形</td><td>drawRoundRect(RectF rect, float rx, float ry, Paint paint)</td><td rowspan="2">使用画笔绘制圆角矩形</td></tr><tr align="center"><td>drawRoundRect(float left, float top, float right, float bottom, float rx, float ry, Paint paint)（Android 5.0 及以上才有）</td></tr><tr align="center"><td rowspan="2">绘制椭圆</td><td>drawOval(float left, float top, float right, float bottom, Paint paint)（Android 5.0 及以上才有）</td><td rowspan="2">使用画笔绘制椭圆</td></tr><tr align="center"><td>drawOval(RectF oval, Paint paint)</td></tr><tr align="center"><td>绘制圆</td><td>drawCircle(float cx, float cy, float radius, Paint paint)</td><td>使用画笔绘制圆</td></tr><tr align="center"><td rowspan="2">绘制圆弧</td><td>drawArc(RectF oval, float startAngle, float sweepAngle, boolean useCenter, Paint paint)</td><td rowspan="2">使用画笔绘制圆弧</td></tr><tr align="center"><td>drawArc(float left, float top, float right, float bottom, float startAngle, float sweepAngle, boolean useCenter, Paint paint)（Android 5.0 及以上才有）</td></tr></table>

<blockquote>
<p>以上只是部分 API 介绍，随着自己进一步学习，会继续完善。</p>
</blockquote>
<h2 id="三、Canvas-用法"><a href="#三、Canvas-用法" class="headerlink" title="三、Canvas 用法"></a>三、Canvas 用法</h2><p>以上介绍部分 Canvas API，那么接下来的任务是学习如何使用相关 API。</p>
<h3 id="1、绘制颜色"><a href="#1、绘制颜色" class="headerlink" title="1、绘制颜色"></a>1、绘制颜色</h3><p>Canvas API 提供 4 个方法用于绘制颜色，即用某种颜色填充整块画布。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">canvas.drawARGB(<span class="number">225</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">canvas.drawColor(Color.GREEN);</div><div class="line"></div><div class="line">canvas.drawRGB(<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">canvas.drawColor(Color.GREEN, PorterDuff.Mode.LIGHTEN);</div></pre></td></tr></table></figure>
<p>需要注意的是绘制颜色第 4 种方法（即第 7 行代码）中第二个参数 PorterDuff.Mode，具体请参考<a href="https://developer.android.com/reference/android/graphics/PorterDuff.Mode.html" target="_blank" rel="external">官网</a>。（ps：这知识点还不是很了解，有时间再研究。）</p>
<p><img src="/images/canvas/canvas_color.png" alt=""></p>
<p>对于以下各种图形的绘制，都需要画笔，那么就先来创建画笔。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomView</span> <span class="title">extend</span> <span class="title">View</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> Paint mPaint;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomView</span><span class="params">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line"></div><div class="line">        mPaint = <span class="keyword">new</span> Paint();</div><div class="line">        mPaint.setColor(Color.GREEN);        <span class="comment">// 设置画笔颜色</span></div><div class="line">        mPaint.setStrokeWidth(<span class="number">2</span>);            <span class="comment">// 设置画笔宽度</span></div><div class="line">        mPaint.setStyle(Paint.Style.STROKE); <span class="comment">// 设置画笔风格（描边）</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2、绘制点"><a href="#2、绘制点" class="headerlink" title="2、绘制点"></a>2、绘制点</h3><p>Canvas API 提供 3 个方法用于绘制单个点、一组点以及一系列点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 由于点形状比较小，不容易看清，所以将画笔宽度设置大点</span></div><div class="line">mPaint.setStrokeWidth(<span class="number">10</span>);</div><div class="line"></div><div class="line"><span class="comment">// 绘制单个点，画笔颜色为 Color.GREEN</span></div><div class="line">canvas.drawPoint(<span class="number">300</span>, <span class="number">300</span>, mPaint);</div><div class="line"></div><div class="line"><span class="comment">//绘制一组点，画笔颜色为 Color.RED</span></div><div class="line"> mPaint.setColor(Color.RED);</div><div class="line"> canvas.drawPoints(<span class="keyword">new</span> <span class="keyword">float</span>[] &#123;<span class="number">400</span>, <span class="number">400</span>, <span class="number">300</span>, <span class="number">500</span>, <span class="number">500</span>, <span class="number">500</span>&#125;, mPaint);</div></pre></td></tr></table></figure>
<p>有没有发现点的形状是正方形，这是因为 Paint 默认 Paint.Cap 属性是 Paint.Cap.SQUARE。如果要修改该属性，可以调用 Paint 方法 <strong>setStrokeCap(Paint.Cap cap)</strong> 修改。</p>
<p><img src="/images/canvas/canvas_point.png" alt=""></p>
<h3 id="3、绘制直线"><a href="#3、绘制直线" class="headerlink" title="3、绘制直线"></a>3、绘制直线</h3><p>Canvas 提供 3 个方法用于绘制单条直线、一组直线和一系列直线。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mPaint.setStrokeWidth(<span class="number">2</span>);</div><div class="line"></div><div class="line"><span class="comment">// 绘制单条直线，画笔颜色为 Color.GREEN</span></div><div class="line">mPaint.setColor(Color.GREEN);</div><div class="line">canvas.drawPoint(<span class="number">300</span>, <span class="number">300</span>, mPaint);</div><div class="line"></div><div class="line"><span class="comment">// 绘制一组直线，画笔颜色为 Color.RED</span></div><div class="line">mPaint.setColor(Color.RED);</div><div class="line">canvas.drawLines(<span class="keyword">new</span> <span class="keyword">float</span>[] &#123;<span class="number">400</span>, <span class="number">400</span>, <span class="number">300</span>, <span class="number">500</span>, <span class="number">300</span>, <span class="number">500</span>, <span class="number">500</span>, <span class="number">500</span>, <span class="number">500</span>, <span class="number">500</span>, <span class="number">400</span>, <span class="number">400</span>&#125;, mPaint);</div><div class="line"></div><div class="line"><span class="comment">// 绘制一系列直线，画笔颜色为 Color.MAGENTA</span></div><div class="line">mPaint.setColor(Color.MAGENTA);</div><div class="line">canvas.drawLines(<span class="keyword">new</span> <span class="keyword">float</span>[] &#123;<span class="number">400</span>, <span class="number">250</span>, <span class="number">300</span>, <span class="number">350</span>, <span class="number">300</span>, <span class="number">350</span>, <span class="number">500</span>, <span class="number">350</span>, <span class="number">500</span>, <span class="number">350</span>, <span class="number">400</span>, <span class="number">250</span>&#125;, <span class="number">0</span>, <span class="number">12</span>, mPaint);</div></pre></td></tr></table></figure>
<p>看下绘制直线第三种方法，即第 13 行代码，方法原型为：<strong>drawLines(float[] pts, int offset, int count, Paint paint)</strong></p>
<ul>
<li><p>pts：绘制直线所需要的点；</p>
</li>
<li><p>offset：跳过点个数，这些点不参与绘制；</p>
</li>
<li><p>count：实际参与绘制个数；</p>
</li>
<li><p>paint：画笔。</p>
</li>
</ul>
<p>该方法相对比较灵活，可以通过参数 offset、count 设置来决定绘制哪些线段。</p>
<p><img src="/images/canvas/canvas_line.png" alt=""></p>
<h3 id="4、绘制矩形"><a href="#4、绘制矩形" class="headerlink" title="4、绘制矩形"></a>4、绘制矩形</h3><p>Canvas API 提供 3 个方法用于绘制矩形。绘制矩形一般只需要两个点就可以绘制，即左上角和右下角这两个点坐标即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Rect rect = <span class="keyword">new</span> Rect(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">8</span> + <span class="number">500</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getHeight() / <span class="number">8</span> * <span class="number">3</span> + <span class="number">500</span>);</div><div class="line"></div><div class="line">RectF rectF = <span class="keyword">new</span> RectF(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">8</span> + <span class="number">200</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getHeight() / <span class="number">8</span> * <span class="number">3</span> + <span class="number">200</span>);</div><div class="line"></div><div class="line">mPaint.setColor(Color.GREEN);</div><div class="line">canvas.drawRect(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">8</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getWidth() / <span class="number">8</span> * <span class="number">3</span>, mPaint);</div><div class="line"></div><div class="line">mPaint.setColor(Color.MAGENTA);</div><div class="line">canvas.drawRect(rectF, mPaint);</div><div class="line"></div><div class="line">mPaint.setColor(Color.RED);</div><div class="line">canvas.drawRect(rect, mPaint);</div></pre></td></tr></table></figure>
<p><img src="/images/canvas/canvas_rect.png" alt=""></p>
<h3 id="5、绘制圆角矩形"><a href="#5、绘制圆角矩形" class="headerlink" title="5、绘制圆角矩形"></a>5、绘制圆角矩形</h3><p>Canvas API 提供 2 种方法用于绘制圆角矩形，其中有一种方法是 Android 5.0 以上才提供，见以上 API 介绍。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 第一种绘制圆角矩形方法</span></div><div class="line">mPaint.setStrokeWidth(<span class="number">5</span>);</div><div class="line">RectF rect = <span class="keyword">new</span> RectF(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">8</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getHeight() / <span class="number">8</span> * <span class="number">3</span>);</div><div class="line">canvas.drawRoundRect(rect, <span class="number">50</span>, <span class="number">50</span>, mPaint);</div><div class="line"></div><div class="line"><span class="comment">// 第二种绘制圆角矩形方法</span></div><div class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</div><div class="line">	canvas.drawRoundRect(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">8</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getHeight() / <span class="number">8</span> * <span class="number">3</span>, <span class="number">50</span>, <span class="number">50</span>, mPaint);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="/images/canvas/canvas_round_rect.png" alt=""></p>
<h3 id="6、绘制椭圆"><a href="#6、绘制椭圆" class="headerlink" title="6、绘制椭圆"></a>6、绘制椭圆</h3><p>Canvas API 提供 2 种方法用于绘制椭圆，其中有一种方法是 Android 5.0 以上才提供，见以上 API 介绍。其实椭圆是被包裹在矩形内，话句话说，是矩形的内切图形。绘制椭圆也很容易，只需传入矩形 RectF 和绘制图形 Paint 就可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 第一种绘制椭圆方法</span></div><div class="line">RectF rect = <span class="keyword">new</span> RectF(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">8</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getHeight() / <span class="number">8</span> * <span class="number">3</span>);</div><div class="line"></div><div class="line">canvas.drawLine(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">4</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getHeight() / <span class="number">4</span>, mPaint);</div><div class="line">canvas.drawLine(getWidth() / <span class="number">2</span>, getHeight() / <span class="number">8</span>, getWidth() / <span class="number">2</span>, getHeight() / <span class="number">8</span> * <span class="number">3</span>, mPaint);</div><div class="line">canvas.drawRect(rect, mPaint);</div><div class="line">canvas.drawOval(rect, mPaint);</div><div class="line"></div><div class="line"><span class="comment">// 第二种绘制椭圆方法</span></div><div class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</div><div class="line">	canvas.drawOval(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">8</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getHeight() / <span class="number">8</span> * <span class="number">3</span>, mPaint);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上多绘制出矩形和两条直线，主要是为了方便看清。</p>
<p><img src="/images/canvas/canvas_oval.png" alt=""></p>
<h3 id="7、绘制圆形"><a href="#7、绘制圆形" class="headerlink" title="7、绘制圆形"></a>7、绘制圆形</h3><p>Canvas API 提供 1 种方法用于绘制圆形。绘制圆形只需要知道圆心和半径。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">canvas.drawCircle(getWidth() / <span class="number">2</span>, getHeight() / <span class="number">2</span>, <span class="number">200</span>, mPaint);</div><div class="line">mPaint.setStrokeWidth(<span class="number">5</span>);</div><div class="line">mPaint.setStrokeCap(Paint.Cap.ROUND);</div><div class="line">canvas.drawPoint(getWidth() / <span class="number">2</span>, getHeight() / <span class="number">2</span>, mPaint);</div></pre></td></tr></table></figure>
<p>这里我把圆心也给画出来了，画笔的宽度设置为 5，容易看清。</p>
<p><img src="/images/canvas/canvas_circle.png" alt=""></p>
<h3 id="8、绘制圆弧"><a href="#8、绘制圆弧" class="headerlink" title="8、绘制圆弧"></a>8、绘制圆弧</h3><p>Canvas API 提供 2 种方法用于绘制圆弧，其中有一种方法是 Android 5.0 以上才提供，见以上 API 介绍。有必要来解释下这两种方法各个参数的含义，以<strong>drawArc(RectF oval, float startAngle, float sweepAngle, boolean useCenter, Paint paint)</strong> 为例子：</p>
<ul>
<li><p>oval：矩形；</p>
</li>
<li><p>startAngle：起始角度；</p>
</li>
<li><p>sweepAngle：绘制圆弧的角度，即扫描过的角度；</p>
</li>
<li><p>useCenter：true 或者 false，至于区别通过例子来说明。</p>
</li>
<li><p>paint：画笔。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// userCenter 为 true</span></div><div class="line">RectF rectF = <span class="keyword">new</span> RectF(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">8</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getHeight() / <span class="number">8</span> * <span class="number">3</span>);</div><div class="line">canvas.drawRect(rectF, mPaint);</div><div class="line">mPaint.setStyle(Paint.Style.FILL);</div><div class="line">canvas.drawArc(rectF, <span class="number">0</span>, <span class="number">90</span>, <span class="keyword">true</span>, mPaint);</div><div class="line"></div><div class="line">canvas.translate(getWidth() / <span class="number">16</span>, getHeight() / <span class="number">3</span>);</div><div class="line"></div><div class="line"><span class="comment">// userCenter 为 false    </span></div><div class="line">mPaint.setStyle(Paint.Style.STROKE);</div><div class="line">RectF rect = <span class="keyword">new</span> RectF(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">8</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getHeight() / <span class="number">8</span> * <span class="number">3</span>);</div><div class="line">canvas.drawRect(rect, mPaint);</div><div class="line">mPaint.setStyle(Paint.Style.FILL);</div><div class="line">canvas.drawArc(rect, <span class="number">0</span>, <span class="number">90</span>, <span class="keyword">false</span>, mPaint);</div><div class="line"></div><div class="line"><span class="comment">// 第二种方法</span></div><div class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</div><div class="line">	canvas.drawArc(getWidth() / <span class="number">8</span>, getHeight() / <span class="number">8</span>, getWidth() / <span class="number">8</span> * <span class="number">7</span>, getHeight() / <span class="number">8</span> * <span class="number">3</span>, <span class="number">0</span>, <span class="number">90</span>, <span class="keyword">false</span>, mPaint);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第一个图形是 userCenter 为 true 的效果图；第二个图形则是 userCenter 为 false 的效果图。</p>
<p><img src="/images/canvas/canvas_arc.png" alt=""></p>
<h2 id="四、小示例"><a href="#四、小示例" class="headerlink" title="四、小示例"></a>四、小示例</h2><p>学习了 Canvas 绘制图形的基本用法后，通过一个具体的例子来综合运用绘制图形方法。这个具体的例子是画圆饼，相信大家应该经常看到这种图形。这个例子是参考这篇博客：<a href="http://www.gcssloop.com/customview/Canvas_BasicGraphics" target="_blank" rel="external">安卓自定义View进阶-Canvas之绘制图形</a>，先看看自己实现的效果图吧。</p>
<p><img src="/images/canvas/canvas_round_cake.png" alt=""></p>
<p>简单分析下：画这类图最主要的元素是数据，即总共有多少个模块，每个模块的值具体是多少，每个模块在总数中所占的比例以及用某种颜色表示某个模块。因此，这个可以将其封装为数据类，即 Bean。数据有了之后，接下来就根据我们学过的知识点进行绘制，来看下具体代码吧：</p>
<p>用户数据类 Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bean</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> color;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> percentage;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> angle;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> value;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> color;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColor</span><span class="params">(<span class="keyword">int</span> color)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.color = color;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPercentage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> percentage;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPercentage</span><span class="params">(<span class="keyword">float</span> percentage)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.percentage = percentage;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getAngle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> angle;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAngle</span><span class="params">(<span class="keyword">float</span> angle)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.angle = angle;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(<span class="keyword">float</span> value)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.value = value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>自定义 View 绘制圆饼 RoundCakeView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoundCakeView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String TAG = RoundCakeView.class.getCanonicalName();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Paint mPaint;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;Bean&gt; mList;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mStartAngle;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mWidth;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mHeight;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RoundCakeView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RoundCakeView</span><span class="params">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RoundCakeView</span><span class="params">(Context context, @Nullable AttributeSet attrs,</span></span></div><div class="line">                         <span class="keyword">int</span> defStyleAttr) &#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        mPaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">        mPaint.setStyle(Paint.Style.STROKE);</div><div class="line">        mPaint.setColor(Color.GREEN);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSizeChanged</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> oldw, <span class="keyword">int</span> oldh)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onSizeChanged(w, h, oldw, oldh);</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.mWidth = w;</div><div class="line">        <span class="keyword">this</span>.mHeight = h;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDraw(canvas);</div><div class="line"></div><div class="line">        Log.d(TAG, <span class="string">"onDraw()"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> x = mWidth / <span class="number">2</span>;</div><div class="line">        <span class="keyword">int</span> y = mHeight / <span class="number">2</span>;</div><div class="line">        <span class="keyword">int</span> r = <span class="number">200</span>;</div><div class="line"></div><div class="line">        RectF rectF = <span class="keyword">new</span> RectF(x - r, y - r, x + r, y + r);</div><div class="line"></div><div class="line">        <span class="keyword">float</span> currentAngle = mStartAngle;</div><div class="line"></div><div class="line">        <span class="comment">// draw circle point</span></div><div class="line">        mPaint.setStrokeCap(Paint.Cap.ROUND);</div><div class="line">        mPaint.setStrokeWidth(<span class="number">5</span>);</div><div class="line">        canvas.drawPoint(x, y, mPaint);</div><div class="line"></div><div class="line">        <span class="comment">// draw circle</span></div><div class="line">        mPaint.setStrokeWidth(<span class="number">0</span>);</div><div class="line">        mPaint.setColor(Color.RED);</div><div class="line">        canvas.drawCircle(x, y, r, mPaint);</div><div class="line"></div><div class="line">        mPaint.setStyle(Paint.Style.FILL);</div><div class="line"></div><div class="line">        <span class="comment">// draw arc</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mList.size(); i++) &#123;</div><div class="line">            Bean bean = mList.get(i);</div><div class="line">            mPaint.setColor(bean.getColor());</div><div class="line">            canvas.drawArc(rectF, currentAngle, bean.getAngle(), <span class="keyword">true</span>, mPaint);</div><div class="line">            currentAngle += bean.getAngle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setList</span><span class="params">(List&lt;Bean&gt; list)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mList = list;</div><div class="line">        invalidate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStartAngle</span><span class="params">(<span class="keyword">float</span> angle)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mStartAngle = angle;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那么接下来就是显示出效果了，先看下布局文件</p>
<p>activity_main.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">tools:context</span>=<span class="string">"com.pan.canvasdemo.MainActivity"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">com.pan.canvasdemo.RoundCakeView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/rcv"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></div><div class="line">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></div><div class="line">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></div><div class="line">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>MainActivity.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String TAG = MainActivity.class.getCanonicalName();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> RoundCakeView mView;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> [] mColors = &#123;Color.RED, Color.GREEN, Color.BLUE, Color.DKGRAY, Color.MAGENTA&#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> [] mValues = &#123;<span class="number">23</span>, <span class="number">98</span>, <span class="number">122</span>, <span class="number">78</span>, <span class="number">225</span>&#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;Bean&gt; mList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mSum;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        init();</div><div class="line">        initData();</div><div class="line"></div><div class="line">        mView.setStartAngle(<span class="number">0</span>);</div><div class="line">        mView.setList(mList);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        mView = (RoundCakeView) findViewById(R.id.rcv);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mValues.length; i++) &#123;</div><div class="line">            mSum += mValues[i];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">            Bean bean = <span class="keyword">new</span> Bean();</div><div class="line">            bean.setColor(mColors[i]);</div><div class="line">            bean.setValue(mValues[i]);</div><div class="line">            bean.setPercentage(bean.getValue() / mSum);</div><div class="line">            bean.setAngle(bean.getPercentage() * <span class="number">360</span>);</div><div class="line">            bean.setName(i + <span class="string">""</span>);</div><div class="line">            mList.add(bean);</div><div class="line"></div><div class="line">            Log.d(TAG, <span class="string">"Value : "</span> + bean.getValue());</div><div class="line">            Log.d(TAG, <span class="string">"Percentage : "</span> + bean.getPercentage());</div><div class="line">            Log.d(TAG, <span class="string">"Angle : "</span> + bean.getAngle());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下就是画圆饼的具体实现，逻辑不是很难懂，加上部分注释应该很容易理解。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://www.gcssloop.com/customview/Canvas_BasicGraphics" target="_blank" rel="external">安卓自定义View进阶-Canvas之绘制图形</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://panzeyong.com/2017/06/26/第六章-面向对象的程序设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="PANJU">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PANJU's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/26/第六章-面向对象的程序设计/" itemprop="url">第 六 章 面向对象的程序设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-26T07:56:20+08:00">
                2017-06-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/26/第六章-面向对象的程序设计/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/06/26/第六章-面向对象的程序设计/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/06/26/第六章-面向对象的程序设计/" class="leancloud_visitors" data-flag-title="第 六 章 面向对象的程序设计">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、理解对象"><a href="#一、理解对象" class="headerlink" title="一、理解对象"></a>一、理解对象</h2><h3 id="1、属性类型"><a href="#1、属性类型" class="headerlink" title="1、属性类型"></a>1、属性类型</h3><ul>
<li><p>数据属性：数据属性包含一个数据值的位置。在这个位置可以读取和写入值。有以下 4 个描述其行为的特性：</p>
<ul>
<li><p>[[Configurable]]：表示是否通过 delete 删除属性从而重新定义属性，能否修改属性的特性，或者能否把属性修改为访问器属性。一旦该属性定义为不可配置，即 false，那么就再也不可能设置为可配置了，即 true。此时，再调用 <strong>Object.defineProperty()</strong> 方法修改除 writable 之外的属性都会导致错。在非严格模式下什么也不会发生，而在严格模式下会导致错误。（在对象上直接定义的属性，默认值为 true）</p>
</li>
<li><p>[[Enumerable]]：表示能否通过 for-in 循环返回属性。（在对象上直接定义的属性，默认值为 true）</p>
</li>
<li><p>[[Writable]]：表示能否修改属性的值。在非严格模式下，赋值操作将被忽略；在严格模式下，赋值操作将会导致错误。（在对象上直接定义的属性，默认值为 true）</p>
</li>
<li><p>[[Value]]：包含这个属性的数据值。读取属性值的时候，从这个位置读；写入属性的时候，把新值保存在这个位置。这个特性的默认值为 undefined。</p>
<p>  要修改属性默认属性，必须调用 ECMAScript5 的 <strong>Object.defineProperty()</strong> 方法。该方法接收三个参数：属性所在的对象、属性的名字、和一个描述符对象。描述符（descriptor）对象的属性必须是：configurable、enumerable、writable 和 value。例子如下：</p>
<p>  将属性特性 writable 改为只读</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> <span class="built_in">Object</span>();</div><div class="line">person.name = <span class="string">"Julian"</span>;</div><div class="line">person.age = <span class="number">22</span>;</div><div class="line">person.job = <span class="string">"Software Engineer"</span>;</div><div class="line"></div><div class="line">person.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	alert(<span class="keyword">this</span>.name);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">Object</span>.defineProperty(person, <span class="string">"name"</span>, &#123;</div><div class="line">	writable : <span class="literal">false</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">person.sayName();        <span class="comment">// 修改之前：Julian</span></div><div class="line">person.name = <span class="string">"Jack"</span>;</div><div class="line">person.sayName();		 <span class="comment">// 修改之后：Julian</span></div></pre></td></tr></table></figure>
<p>  将属性特性 configurable 改为不可配置（对象 person 使用上面代码）。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.defineProperty(person, <span class="string">"name"</span>, &#123;</div><div class="line">configurable : <span class="literal">false</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">person.sayName();        <span class="comment">// 修改之前：Julian</span></div><div class="line"><span class="keyword">delete</span> persion.name;</div><div class="line">person.sayName();		 <span class="comment">// 修改之后：Julian</span></div></pre></td></tr></table></figure>
<p>  在将属性特性 configurable 改为不可配置时再修改其它属性特性（writable 除外），抛出错误。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Object</span>.defineProperty(person, <span class="string">"name"</span>, &#123;</div><div class="line">	value : <span class="string">"Marry"</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 错误提示</span></div><div class="line">Uncaught <span class="built_in">TypeError</span>: Cannot redefine property: name</div><div class="line">  at <span class="built_in">Function</span>.defineProperty (<span class="xml"><span class="tag">&lt;<span class="name">anonymous</span>&gt;</span>)</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>访问器属性</p>
<ul>
<li><p>[[Configurable]]：表示能否通过 delete 删除属性从而重新定义属性，能否修改属性的特性，或者能否把属性修改为<strong>数据属性</strong>。（在对象上直接定义的属性，默认值为 true）</p>
</li>
<li><p>[[Enumerable]]：表示能否通过 for-in 循环返回属性。（在对象上直接定义的属性，默认值为 true）</p>
</li>
<li><p>[[Get]]：在读取属性时调用的函数。默认值为 undefined。只指定该属性时意味着不能写入，在非严格模式下写入属性会被忽略；在严格模式下写入属性会抛出错误。</p>
</li>
<li><p>[[Set]]：在写入属性时调用的函数。默认值为 undefined。只指定该属性时意味着不能读取，在非严格模式下读取时返回 undefined；在严格模式下会抛出错误。</p>
<p><strong>访问器不能直接定义，必须使用 Object.defineProperty() 定义</strong>。</p>
<p>书中例子，代码如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> book = &#123;</div><div class="line">	_year: <span class="number">2004</span>,</div><div class="line">	edition: <span class="number">1</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">Object</span>.defineProperty(book, <span class="string">"year"</span>, &#123;</div><div class="line">	get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">"get"</span>);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>._year;</div><div class="line">	&#125;,</div><div class="line"></div><div class="line">	set: <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span> (value &gt; <span class="number">2004</span>) &#123;</div><div class="line">			<span class="built_in">console</span>.log(<span class="string">"set"</span>);</div><div class="line">			<span class="keyword">this</span>._year = value;</div><div class="line">			<span class="keyword">this</span>.edition += value - <span class="number">2004</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 调用访问器 set</span></div><div class="line">book.year = <span class="number">2007</span>;  </div><div class="line">alert(book.edition); </div><div class="line"></div><div class="line"><span class="comment">// 调用访问器 get</span></div><div class="line">alert(book.year);</div><div class="line"></div><div class="line"><span class="comment">// 如果将属性名 “year” 改为 "_year"，并设置 book._year = 2007，则会导致无限递归，最终导致错误。</span></div><div class="line"></div><div class="line"><span class="comment">// 注：_year 前面的下划线是一种常用的记号，用于表示只能通过对象方法访问属性。</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="2、定义多个属性"><a href="#2、定义多个属性" class="headerlink" title="2、定义多个属性"></a>2、定义多个属性</h3><p>调用方法 <strong>Object.defineProperties()</strong> 可以为一个对象定义多个属性，该方法接收两个对象参数：第一个对象参数是<strong>要添加和修改其属性的对象</strong>；第二个对象参数是<strong>第二个对象的属性与第一个对象中要添加或修改的属性一一对应</strong>。</p>
<p>书中例子，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> book = &#123;&#125;;</div><div class="line"></div><div class="line"><span class="built_in">Object</span>.defineProperties(book, &#123;</div><div class="line">	<span class="comment">// 数据属性</span></div><div class="line">	_year: &#123;</div><div class="line">		value: <span class="number">2005</span></div><div class="line">	&#125;,</div><div class="line">	</div><div class="line">	<span class="comment">// 数据属性</span></div><div class="line">	edition: &#123;</div><div class="line">		value: <span class="number">1</span></div><div class="line">	&#125;,</div><div class="line">	</div><div class="line">	<span class="comment">// 访问器属性</span></div><div class="line">	year: &#123;</div><div class="line">		get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">this</span>._year;</div><div class="line">		&#125;,</div><div class="line"></div><div class="line">		set: <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">			<span class="keyword">if</span> (value &gt; <span class="number">2005</span>) &#123;</div><div class="line">				<span class="keyword">this</span>._year = value;</div><div class="line">				<span class="keyword">this</span>.edition += value - <span class="number">2005</span>; </div><div class="line">			&#125;	</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="3、读取属性的特性"><a href="#3、读取属性的特性" class="headerlink" title="3、读取属性的特性"></a>3、读取属性的特性</h3><p>调用 <strong>Object.getOwnPropertyDescriptor()</strong> 方法可以取得给定属性的描述符。这个方法接收两个参数：属性所在的对象和要读取器描述符的属性名称。返回一个对象。</p>
<p>书中例子，代码如下：（基于以上代码）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 数据属性</span></div><div class="line"><span class="keyword">var</span> descriptor = <span class="built_in">Object</span>.getOwnPropertyDescriptor(book, <span class="string">"_year"</span>);</div><div class="line">alert(descriptor.value);        <span class="comment">// 2005</span></div><div class="line">alert(descriptor.configurable); <span class="comment">// false</span></div><div class="line">alert(descriptor.writable);     <span class="comment">// false</span></div><div class="line">alert(descriptor.enumerable);   <span class="comment">// false</span></div><div class="line">alert(<span class="keyword">typeof</span> descriptor.get);   <span class="comment">// undefined</span></div><div class="line"></div><div class="line"><span class="comment">// 访问器属性</span></div><div class="line"><span class="keyword">var</span> descriptor = <span class="built_in">Object</span>.getOwnPropertyDescriptor(book, <span class="string">"year"</span>);</div><div class="line">alert(descriptor.value);			 <span class="comment">// undefined  </span></div><div class="line">alert(descriptor.configurable); <span class="comment">// false</span></div><div class="line">alert(descriptor.enumerable);   <span class="comment">// false</span></div><div class="line">alert(<span class="keyword">typeof</span> descriptor.get);   <span class="comment">// function</span></div><div class="line">alert(<span class="keyword">typeof</span> descriptor.set);   <span class="comment">// function</span></div></pre></td></tr></table></figure>
<h2 id="二、创建对象"><a href="#二、创建对象" class="headerlink" title="二、创建对象"></a>二、创建对象</h2><h3 id="1、工厂模式"><a href="#1、工厂模式" class="headerlink" title="1、工厂模式"></a>1、工厂模式</h3><p>用函数来封装以特定接口创建对象的细节，与 Java 中 class 类似，即将对象类型的属性和方法进行封装。</p>
<h3 id="2、构造函数模式"><a href="#2、构造函数模式" class="headerlink" title="2、构造函数模式"></a>2、构造函数模式</h3><p>可用来创建特定类型的对象，用 new 操作符来调用，这是与普通函数唯一的区别。</p>
<h3 id="3、原型模式"><a href="#3、原型模式" class="headerlink" title="3、原型模式"></a>3、原型模式</h3><p>在 JavaScript 中，我们创建的每个函数都包含一个（原型）属性：prototype。prototype 属性是一个指针，指向一个对象，即原型对象，该原型对象包含可由特定类型的所有实例共享的属性和方法。换句话说，该原型对象可以说是调用构造函数而创建的对象实例的原型对象。使用原型对象的好处是让所有对象实例共享它包含的属性和方法。</p>
<p>书中例子，代码如下：（1）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Person.prototype.name = <span class="string">"Marry"</span>;</div><div class="line">Person.prototype.age = <span class="number">22</span>;</div><div class="line">Person.prototype.job = <span class="string">"Software Engineer"</span>;</div><div class="line">Person.prototype.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	alert(<span class="keyword">this</span>.name);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> person1 = <span class="keyword">new</span> Person();</div><div class="line">person1.sayName();</div><div class="line"></div><div class="line"><span class="keyword">var</span> person2 = <span class="keyword">new</span> Person();</div><div class="line">person2.sayName();</div><div class="line"></div><div class="line">alert(person1.sayName == person2.sayName); <span class="comment">// true</span></div></pre></td></tr></table></figure>
<ul>
<li><p>理解原型对象</p>
<ul>
<li><p>每当我们创建新函数时，就会根据特定规则为该函数创建一个 <strong>prototype</strong> 属性，该属性指向函数的原型对象。在默认情况下，所有原型对象都会自动获取 <strong>constructor</strong> （构造函数）属性，该属性包含一个指向 prototype 属性所在函数的指针。</p>
</li>
<li><p>prototype 这个属性连接在于实例与构造函数的原型对象之间，而不是存在于实例与构造函数之间。</p>
</li>
<li><p>读取对象属性的原则：先从对象实例进行搜索，搜索不到的话再从原型对象进行搜索。</p>
</li>
<li><p>虽然可以通过对象实例访问保存在原型对象中的值，但是却不能通过对象实例修改原型对象中的值。如果我们在对象实例定义与原型对象中同名的属性，则对象实例中的属性会屏蔽原型对象中的属性。</p>
</li>
<li><p>使用 delete 操作符可以则可以完全删除实例属性，从而让我们能够重新访问原型中的属性。</p>
</li>
</ul>
</li>
<li><p>原型与 in 操作符</p>
<ul>
<li><p>使用 in 操作符方式：单独使用和在 for-in 循环中使用。</p>
</li>
<li><p>单独使用时， in 操作符会在通过对象能够访问给定属性时返回 true，无论该属性存在于实例中还是原型中。</p>
</li>
<li><p>同时使用 <strong>hasOwnProperty()</strong> 方法和 in 操作符，就可以确定该属性到底是存在于对象，还是存在于原型中。</p>
</li>
<li><p>在 for-in 中，返回的是所有能够通过对象访问的、可枚举的属性，其中既包括存在于实例中的属性，也包括存在于原型中的属性。屏蔽了原型中不可枚举属性（即将 [[Enumerable]]）标记为 false 属性）的实例属性也会在 for-in 循环中返回。（例子如下）</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> object = &#123;</div><div class="line">	toString : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"toString"</span>;</div><div class="line">	&#125;,</div><div class="line"></div><div class="line">	hasOwnProperty : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"hasOwnProperty"</span>;</div><div class="line">	&#125;,</div><div class="line"></div><div class="line">	propertyIsEnumerable : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"propertyIsEnumerable"</span>;</div><div class="line">	&#125;,</div><div class="line"></div><div class="line">	toLocaleString : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"toLocaleString"</span>;</div><div class="line">	&#125;,</div><div class="line"></div><div class="line">	valueOf : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"valueOf"</span>;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> o <span class="keyword">in</span> object) &#123;</div><div class="line">	<span class="keyword">if</span> (o == <span class="string">"toString"</span>) &#123;</div><div class="line">		alert(<span class="string">"toString"</span>);</div><div class="line">		alert(o);</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (o == <span class="string">"toLocaleString"</span>) &#123;</div><div class="line">		alert(<span class="string">"toLocaleString"</span>);</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (o == <span class="string">"valueOf"</span>) &#123;</div><div class="line">		alert(<span class="string">"valueOf"</span>);</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (o == <span class="string">"hasOwnProperty"</span>) &#123;</div><div class="line">		alert(<span class="string">"hasOwnProperty"</span>);</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (o == <span class="string">"propertyIsEnumerable"</span>) &#123;</div><div class="line">		alert(<span class="string">"propertyIsEnumerable"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>更简单的原型语法</p>
<ul>
<li><p>用一个包含所有属性和方法的对象字面量来重写整个原型对象。需要注意的是 <strong>constructor</strong> 属性不再指向 <strong>prototype</strong> 属性所在函数（比如 Person），而是指向 Object 构造函数。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line"></div><div class="line">Person.prototype = &#123;	</div><div class="line">	name : <span class="string">"Jack"</span>,</div><div class="line">	age : <span class="number">22</span>,</div><div class="line">	job : <span class="string">"Software Engineer"</span>,</div><div class="line">	sayName : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		alert(<span class="keyword">this</span>.name);</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>原型的动态性</p>
<ul>
<li><p>对原型对象的任何修改都能够立即从实例上反映出来，原因是<strong>实例与原型之间的松散连接关系</strong>。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">	</div><div class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> Person();</div><div class="line">	</div><div class="line">Person.prototype.sayHi = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	alert(<span class="string">"Hi"</span>);</div><div class="line">&#125;;</div><div class="line">	</div><div class="line">person.sayHi();</div></pre></td></tr></table></figure>
</li>
<li><p>如果对原型对象进行重写，那情况就不一样。这时存在两个对象，并且毫无关联。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">	</div><div class="line"><span class="keyword">var</span> friend = <span class="keyword">new</span> Person();</div><div class="line">	</div><div class="line">Person.prototype = &#123;	</div><div class="line">	<span class="keyword">constructor</span> : Person,</div><div class="line">	name : "Jack",</div><div class="line">	age : 22,</div><div class="line">	job : "Software Engineer",</div><div class="line">	sayName : function() &#123;</div><div class="line">		alert(<span class="keyword">this</span>.name);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line">	</div><div class="line">friend.sayName();    <span class="comment">// error</span></div></pre></td></tr></table></figure>
</li>
<li><p>实例中的指针仅指向原型，而不指向构造函数。</p>
</li>
</ul>
</li>
<li><p>构造函数、原型与实例之间关系</p>
<p>  每个构造函数都有一个原型对象，原型对象都包含一个指向构造函数的指针，而实例都包含一个指向原型对象的内部指针。</p>
</li>
</ul>
<h3 id="4、组合使用构造函数模式和原型模式"><a href="#4、组合使用构造函数模式和原型模式" class="headerlink" title="4、组合使用构造函数模式和原型模式"></a>4、组合使用构造函数模式和原型模式</h3><p>构造函数模式用于定义实例属性，而原型模式用于定义方法和共享的属性。好处是最大限度地节省了内存。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name, age, job</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.name = name;</div><div class="line">	<span class="keyword">this</span>.age = age;</div><div class="line">	<span class="keyword">this</span>.job = job;</div><div class="line">	<span class="keyword">this</span>.language = [<span class="string">"JavaScript"</span>, <span class="string">"Java"</span>, <span class="string">"PHP"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">Person.prototype = &#123;</div><div class="line">	<span class="keyword">constructor</span> : Person,</div><div class="line">	sayName : function() &#123;</div><div class="line">		alert(<span class="keyword">this</span>.name);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> person1 = <span class="keyword">new</span> Person();</div><div class="line"><span class="keyword">var</span> person2 = <span class="keyword">new</span> Person();</div><div class="line"></div><div class="line">person1.language.push(<span class="string">"Python"</span>);</div><div class="line"></div><div class="line">alert(person1.language);    <span class="comment">// "JavaScript, Java, PHP, Python"</span></div><div class="line">alert(person2.language);    <span class="comment">// "JavaScript, Java, PHP"</span></div><div class="line"></div><div class="line">alert(person1.language == person2.language);    <span class="comment">// false</span></div><div class="line">alert(person1.sayName == person2.sayName);      <span class="comment">// true</span></div></pre></td></tr></table></figure>
<h3 id="5、动态原型模式"><a href="#5、动态原型模式" class="headerlink" title="5、动态原型模式"></a>5、动态原型模式</h3><p>把所有信息都封装在了构造函数中，而通过在构造函数中初始化原型（仅在必要的情况下），又保持了同时使用构造函数和原型的优点。换句话说，可以通过检查某个应该存在的方法是否有效，来决定是否需要初始化原型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name, age, job</span>) </span>&#123;</div><div class="line">	<span class="comment">// 属性</span></div><div class="line">	<span class="keyword">this</span>.name = name;</div><div class="line">	<span class="keyword">this</span>.age = age;</div><div class="line">	<span class="keyword">this</span>.job = job;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="keyword">this</span>.sayName != <span class="string">"function"</span>) &#123;</div><div class="line">		Person.prototype.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">			alert(<span class="keyword">this</span>.name);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6、寄生构造函数模式"><a href="#6、寄生构造函数模式" class="headerlink" title="6、寄生构造函数模式"></a>6、寄生构造函数模式</h3><p>创建一个函数，该函数的作用仅仅是封装创建对象的代码，然后再返回新创建的对象。（与工厂模式类似）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">functuon Person(name, age, job) &#123;</div><div class="line">	<span class="keyword">var</span> o = <span class="keyword">new</span> <span class="built_in">Object</span>();</div><div class="line">	o.name = name;</div><div class="line">	o.age = age;</div><div class="line">	o.job = job;</div><div class="line">	o.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		alert(<span class="keyword">this</span>.name);</div><div class="line">	&#125;;</div><div class="line">	retrun o;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="7、稳妥构造函数模式"><a href="#7、稳妥构造函数模式" class="headerlink" title="7、稳妥构造函数模式"></a>7、稳妥构造函数模式</h3><p>稳妥对象：指的是没有公共属性，而且其方法也不引用 this 的对象。</p>
<p>适用场景：一些安全的环境中（这些环境中会禁止使用 this 和 new），或者在防止数据被其它应用程序（如 Mashup 程序）改动时使用。</p>
<p>稳妥构造函数与寄生构造函数模式区别：</p>
<ul>
<li><p>稳妥构造函数新创建对象的实例方法不引用 this；</p>
</li>
<li><p>稳妥构造函数不使用 new 操作符调用构造函数。</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name, age, job</span>) </span>&#123;</div><div class="line">	</div><div class="line">	<span class="comment">// 创建要返回的对象</span></div><div class="line">	<span class="keyword">var</span> o = <span class="keyword">new</span> <span class="built_in">Object</span>();</div><div class="line">	</div><div class="line">	<span class="comment">// 可以在这里定义私有变量和函数</span></div><div class="line">	</div><div class="line">	<span class="comment">// 添加方法</span></div><div class="line">	o.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		alert(name);</div><div class="line">	&#125;;</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> o;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><p>继承有两种方式：接口继承和实现继承。接口继承只继承方法签名，而实现继承则继承实际方法。ECMAScript 只支持实现继承，并且主要依靠<strong>原型链</strong>来实现。</p>
<h3 id="1、原型链"><a href="#1、原型链" class="headerlink" title="1、原型链"></a>1、原型链</h3><p>让一个引用类型继承另一个引用类型的属性和方法。可以简单概括地说：有一个超类，具有属性和方法；通过 new 操作符创建超类实例赋值给子类，即子类的原型指向超类的原型，创建子类实例，指向子类的原型。例子如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">SuperType</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"SuperType"</span>);</div><div class="line">	<span class="keyword">this</span>.property = <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">SuperType.prototype.getSuperValue = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"getSuperValue"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.property;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">SubType</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"SubType"</span>);</div><div class="line">	<span class="keyword">this</span>.subproperty = <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 继承 SuperType</span></div><div class="line">SubType.prototype = <span class="keyword">new</span> SuperType();</div><div class="line"></div><div class="line"><span class="comment">// 使用字面量添加新方法，会导致上一行代码无效（17）</span></div><div class="line">SubType.prototype = &#123;</div><div class="line">	getSubValue: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.subproperty;</div><div class="line">	&#125;,</div><div class="line"></div><div class="line">	someOtherMethod: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 添加新方法</span></div><div class="line">SubType.prototype.getSubValue = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">"getSubValue"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.subproperty;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 覆盖方法</span></div><div class="line">SubType.prototype.getSuperValue = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> instance = <span class="keyword">new</span> SubType();</div><div class="line">alert(instance.getSuperValue());</div><div class="line">alert(instance.getSubValue());</div><div class="line">alert(instance.property);</div></pre></td></tr></table></figure>
<p>需要注意的要点：</p>
<ul>
<li><p>所有引用类型默认继承 Object，而且这个继承也是通过原型链实现的。也就是说，所有函数的默认原型都是 Object 的实例，因此默认原型都会包含一个内部指针，指向 Object.prototype。</p>
</li>
<li><p>在给原型添加新方法或覆盖方法的代码一定要放在替换原型语句之后。</p>
</li>
<li><p>在通过原型链实现继承时，不能使用对象字面量创建原型方法。因为这样做就会重写原型链。（ps：还不是很理解）</p>
</li>
</ul>
<p>原型链存在问题：</p>
<ul>
<li><p>包含引用类型值所带来的问题，即引用类型值的所有属性是被共享的，这就导致一个实例修改其中属性，也会影响到其它实例。</p>
</li>
<li><p>在创建子类型的实例时，不能向超类型的构造函数中传递参数。</p>
</li>
</ul>
<h3 id="2、借用构造函数（伪造对象或经典继承）"><a href="#2、借用构造函数（伪造对象或经典继承）" class="headerlink" title="2、借用构造函数（伪造对象或经典继承）"></a>2、借用构造函数（伪造对象或经典继承）</h3><p>在子类型构造函数的内部调用超类型构造函数。可以这样说，在子类创建新对象时执行超类构造函数中初始化代码，使子类实例各具有自己的一份副本。（ps：纯属自己理解）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">SuperType</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.colors = [<span class="string">"red"</span>, <span class="string">"blue"</span>, <span class="string">"green"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">SubType</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	SuperType.call(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> instance = <span class="keyword">new</span> SubType();</div><div class="line">instance.colors.push(<span class="string">"pink"</span>);</div><div class="line">alert(instance.colors);               <span class="comment">// "red, blue, green, pink"</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> instance = <span class="keyword">new</span> SubType();</div><div class="line">alert(instance.colors);               <span class="comment">// "red, blue, green"</span></div></pre></td></tr></table></figure>
<p>相对于原型链优势：在子类构造函数中向超类型构造函数传递参数。</p>
<p>借用构造函数存在问题：方法都在构造函数中定义，函数复用无从谈起。</p>
<h3 id="3、组合继承（伪经典继承）"><a href="#3、组合继承（伪经典继承）" class="headerlink" title="3、组合继承（伪经典继承）"></a>3、组合继承（伪经典继承）</h3><p>使用原型链实现对原型属性和方法的继承，通过借用构造函数来实现对实例属性的继承。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">SuperType</span>(<span class="params">name</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.name = name;</div><div class="line">	<span class="keyword">this</span>.colors = [<span class="string">"red"</span>, <span class="string">"blue"</span>, <span class="string">"green"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">SuperType.prototype.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	alert(<span class="keyword">this</span>.name);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">SubType</span>(<span class="params">name, age</span>) </span>&#123;</div><div class="line">	SuperType.call(<span class="keyword">this</span>, name);</div><div class="line"></div><div class="line">	<span class="keyword">this</span>.age = age;</div><div class="line">&#125;</div><div class="line"></div><div class="line">SubType.prototype = <span class="keyword">new</span> SuperType();</div><div class="line">SubType.prototype.constructor = SubType;</div><div class="line">SubType.prototype.sayAge = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	alert(<span class="keyword">this</span>.age);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> instance = <span class="keyword">new</span> SubType(<span class="string">"Jack"</span>, <span class="number">22</span>);</div><div class="line">instance.colors.push(<span class="string">"black"</span>);</div><div class="line">alert(instance.colors);       <span class="comment">// "red, blue, green, pink" </span></div><div class="line">instance.sayName();           <span class="comment">// Jack</span></div><div class="line">instance.sayAge();            <span class="comment">// 22</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> instance = <span class="keyword">new</span> SubType(<span class="string">"John"</span>, <span class="number">21</span>);     </div><div class="line">alert(instance.colors);      <span class="comment">// "red, blue, green"</span></div><div class="line">instance.sayAge();           <span class="comment">// John</span></div><div class="line">instance.sayName();          <span class="comment">// 21</span></div></pre></td></tr></table></figure>
<h3 id="4、原型式继承"><a href="#4、原型式继承" class="headerlink" title="4、原型式继承"></a>4、原型式继承</h3><p>在函数先创建一个临时构造函数，将传入的对象作为这个构造函数的原型，最终返回该类型的新实例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">object</span>(<span class="params">o</span>) </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">F</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">	F.prototype = o;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> F();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5、寄生式继承（parasitic）"><a href="#5、寄生式继承（parasitic）" class="headerlink" title="5、寄生式继承（parasitic）"></a>5、寄生式继承（parasitic）</h3><p>创建一个仅用于封装继承过程的函数，该函数在内部以某种方式来<strong>增强</strong>对象，最后返回对象。与寄生构造函数和工厂模式类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">original</span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> clone = object(original);        <span class="comment">// object() 原型式继承函数</span></div><div class="line">	clone.sayHi = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		alert(<span class="string">"hi"</span>);</div><div class="line">	&#125;;</div><div class="line">	<span class="keyword">return</span> clone;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6、寄生组合式继承"><a href="#6、寄生组合式继承" class="headerlink" title="6、寄生组合式继承"></a>6、寄生组合式继承</h3><p>通过借用构造函数来继承属性，通过原型链的混成形式来继承方法。基本思路是：不必为了指定子类型的原型而调用超类型的构造函数，所需要的无非就是超类型原型的副本而已。本质上，就是使用寄生式继承来继承超类型的原型，然后再将结果指定给子类型的原型。(主要是为了避免调用两次超类型构造函数)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">inheritPrototype</span>(<span class="params">subType, superType</span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> prototype = object(superType.prototype);    <span class="comment">// 创建对象</span></div><div class="line">	prototype.constructor = subType;                <span class="comment">// 增强对象</span></div><div class="line">	subType.prototype = prototype;                 <span class="comment">// 指定对象</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><ul>
<li><p><strong>isPrototypeOf()：</strong>确定对象之间是否存在关系，即如果 [[Prototype]] 指向调用 <strong>isPrototypeOf()</strong> 方法的对象，则返回 true。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">alert(Person.prototype.isPrototypeOf(person1));    <span class="comment">// true</span></div><div class="line">alert(Person.prototype.isPrototypeOf(person2));    <span class="comment">// true</span></div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p><strong>Object.getPrototypeOf()</strong>：返回 [[Prototype]] 的值。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">alert(<span class="built_in">Object</span>.getPrototypeOf(person1) == Person.prototype);    <span class="comment">// true</span></div><div class="line">alert(<span class="built_in">Object</span>.getPrototypeOf(person1).name);    <span class="comment">// Marry</span></div></pre></td></tr></table></figure>
</li>
<li><p><strong>hasOwnProperty()</strong>：可以检测一个属性是存在于实例中，还是存在于原型中。如果给定属性存在于实例对象中，则返回 true；否则返回 false。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">alert(person1.hasOwnProperty(<span class="string">"name"</span>));    <span class="comment">// false</span></div><div class="line">alert(person2.hasOwnProperty(<span class="string">"name"</span>));    <span class="comment">// false</span></div><div class="line"></div><div class="line">person2.name = <span class="string">"John"</span>;</div><div class="line">person1.sayName();    <span class="comment">// Marry</span></div><div class="line">person2.sayName();    <span class="comment">// John</span></div><div class="line"></div><div class="line">alert(person1.hasOwnProperty(<span class="string">"name"</span>));    <span class="comment">// false</span></div><div class="line">alert(person2.hasOwnProperty(<span class="string">"name"</span>));    <span class="comment">// true</span></div><div class="line"></div><div class="line"><span class="keyword">delete</span> person2.name</div><div class="line">alert(person2.name);  <span class="comment">// Mary</span></div><div class="line">alert(person2.hasOwnProperty(<span class="string">"name"</span>));    <span class="comment">// false</span></div></pre></td></tr></table></figure>
</li>
<li><p><strong>Object.keys()：</strong>获取对象上所有可枚举的实例属性。该方法接收一个对象作为参数，返回一个包含所有可枚举属性的<strong>字符串数组</strong>。</p>
</li>
<li><p><strong>Object.getOwnPropertyNames()：</strong>获取所有实例属性，无论是否可枚举。</p>
</li>
<li><p><strong>Object.create()：</strong>该方法用于规范化原型式继承。接收两个参数：一个用作新对象原型的对象和（可选的）一个为新对象定义额外属性的对象。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> person = &#123;</div><div class="line">	name : <span class="string">"Julian"</span>,</div><div class="line">	friends : [<span class="string">"Ruby"</span>, <span class="string">"Java"</span>, <span class="string">"JavaScript"</span>, <span class="string">"Python"</span>]</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> person1 = <span class="built_in">Object</span>.create(person, &#123;</div><div class="line">	name : &#123;</div><div class="line">		value : <span class="string">"John"</span></div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>以上是在学习 《JavaScript 高级程序设计》（第 3 版）这本书第六章的学习笔记，主要把书中讲到的要点记录下来，方便自己查找。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://panzeyong.com/2017/06/07/Picasso-用法及源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="PANJU">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PANJU's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/07/Picasso-用法及源码解析/" itemprop="url">Picasso 用法及源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-07T07:47:21+08:00">
                2017-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/07/Picasso-用法及源码解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/06/07/Picasso-用法及源码解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/06/07/Picasso-用法及源码解析/" class="leancloud_visitors" data-flag-title="Picasso 用法及源码解析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Picasso 是 Square 公司开源的一个 Android 平台优秀图片加载框架，易用、代码简洁、可读性高。自己接触的第一个开源图片加载框架也是 Picasso，以前只停留在会用阶段，根本不知道是如何实现的，最近花了点时间看了 Picasso 源码，学到的东西还是蛮多；大概理解实现基本流程。</p>
<p>对于看源码这事，一开始真不知从哪里下手。于是 Google 了，发现很多都是从使用方法入手，理清方法间是如何调用，最后形成自己的线索。本文也是按照这种方式来分析 Picasso 源码。</p>
<h3 id="Picasso-使用方法"><a href="#Picasso-使用方法" class="headerlink" title="Picasso 使用方法"></a>Picasso 使用方法</h3><ul>
<li>使用 Picasso 加载一张图片很简单，一行代码就搞定</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Picasso.whth(context)</div><div class="line">	.load(R.mipmap.ic_default)</div><div class="line">	.placeholder(R.mipmap.ic_default)</div><div class="line">	.error(R.mipmap.ic_default)</div><div class="line">	.into(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>加载一张图片并且按照指定尺寸以 <strong>centerCrop</strong> 形式对图片进行缩放</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">	.load(R.mipmap.ic_default)</div><div class="line">	.resize(<span class="number">200</span>, <span class="number">200</span>)</div><div class="line">	.centerCrop()</div><div class="line">	.into(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>加载一张图片并且按照指定尺寸以 <strong>centerInside</strong> 形式图片进行缩放（注：对图片进行处理时，<strong>centerCrop</strong> 或  <strong>centerInside</strong> 只能选择一种方式，并且必须调用方法 <strong>resize(targetWidth, targetHeight)</strong> 或者 <strong>resizeDimen(targetWidthResId, targetHeightResId)</strong>  设置大小）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">	.load(R.mipmap.ic_default)</div><div class="line">	.resizeDimen(R.dimen.width, R.dimen.height)</div><div class="line">	.centerInside()</div><div class="line">	.into(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>加载一张图片并且按照一定角度对其进行旋转</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">	.load(R.mipmap.ic_launcher)</div><div class="line">	.rotate(<span class="number">20</span>)</div><div class="line">	.into(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>加载一张图片自适应目标视图（由于调整大小适应目标视图，结果导致请求被延迟，直到调整完毕才会发送请求；目标视图只能是 ImageView）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">	.load(R.mipmap.ic_launcher)</div><div class="line">	.fit()</div><div class="line">	.into(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>加载一张图片并设置回调接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">	.load(R.mipmap.ic_launcher)</div><div class="line">	.into(mImageView, <span class="keyword">new</span> Callback() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;&#125;);</div></pre></td></tr></table></figure>
<p>以上只是 Picasso 简单的用法，至于其它用法看API；接下来分析下源码。</p>
<h3 id="Picasso-源码解析"><a href="#Picasso-源码解析" class="headerlink" title="Picasso 源码解析"></a>Picasso 源码解析</h3><h4 id="Picasso-with-方法解析"><a href="#Picasso-with-方法解析" class="headerlink" title="Picasso.with() 方法解析"></a>Picasso.with() 方法解析</h4><p>为了探究 Picasso.with() 方法如何实现，唯独从源代码找答案。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * The global default &#123;<span class="doctag">@link</span> Picasso&#125; instance.</div><div class="line">    * &lt;p&gt;</div><div class="line">    * This instance is automatically initialized with defaults that are suitable to most</div><div class="line">    * implementations.</div><div class="line">    * &lt;ul&gt;</div><div class="line">    * &lt;li&gt;LRU memory cache of 15% the available application RAM&lt;/li&gt;</div><div class="line">    * &lt;li&gt;Disk cache of 2% storage space up to 50MB but no less than 5MB. (Note: this is only</div><div class="line">    * available on API 14+ &lt;em&gt;or&lt;/em&gt; if you are using a standalone library that provides a disk</div><div class="line">    * cache on all API levels like OkHttp)&lt;/li&gt;</div><div class="line">    * &lt;li&gt;Three download threads for disk and network access.&lt;/li&gt;</div><div class="line">    * &lt;/ul&gt;</div><div class="line">    * &lt;p&gt;</div><div class="line">    * If these settings do not meet the requirements of your application you can construct your own</div><div class="line">    * with full control over the configuration by using &#123;<span class="doctag">@link</span> Picasso.Builder&#125; to create a</div><div class="line">    * &#123;<span class="doctag">@link</span> Picasso&#125; instance. You can either use this directly or by setting it as the global</div><div class="line">    * instance with &#123;<span class="doctag">@link</span> #setSingletonInstance&#125;.</div><div class="line">    */</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Picasso <span class="title">with</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line"> </div><div class="line">     <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">synchronized</span> (Picasso.class) &#123;</div><div class="line">             <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</div><div class="line">                 singleton = <span class="keyword">new</span> Builder(context).build();</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     </div><div class="line">     <span class="keyword">return</span> singleton;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从注释中可以得到以下几点：</p>
<ul>
<li><p>全局默认实例，也就是说只有一个实例存在，从使用单例模式可以看出。</p>
</li>
<li><p>Picasso 采用两级缓存：内存缓存和磁盘缓存。</p>
</li>
<li><p>LRU 内存缓存大小占整个应用可用 RAM 容量的 15%。</p>
</li>
<li><p>磁盘缓存大小占存储空间的 2%，不少于 5 MB，不超过 50 MB。（注：仅适于 API 14+ 或者所使用的第三方库包含 API，比如 OkHttp）。</p>
</li>
<li><p>为磁盘访问和网络访问提供 <strong>3</strong> 个线程。</p>
</li>
<li><p>这些配置是 Picasso 默认配置的，如果不满足自己的需求，可以自己定制。通过 Picasso.Builder 创建 Picasson 实例，根据自己需要配置相关属性，并调用方法 setSingletonInstance(picasso) 设置为全局实例。</p>
</li>
</ul>
<p>很明显可以看到，使用单例模式来创建 Picasso 实例，保证全局只有一个实例存在。简单说下 with() 方法的实现，singleton 为 null 时调用 Builder 类中 build() 方法创建 singleton 实例并返回，那么接下来就来看 Builder 类中 build() 方法是如何实现的？</p>
<h5 id="Picasso-Builder-中-build-方法解析"><a href="#Picasso-Builder-中-build-方法解析" class="headerlink" title="Picasso.Builder 中 build() 方法解析"></a>Picasso.Builder 中 build() 方法解析</h5><p>源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Picasso <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">	Context context = <span class="keyword">this</span>.context;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (downloader == <span class="keyword">null</span>) &#123;</div><div class="line">		downloader = Utils.createDefaultDownloader(context);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</div><div class="line">		cache = <span class="keyword">new</span> LruCache(context);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</div><div class="line">		service = <span class="keyword">new</span> PicassoExecutorService();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (transformer == <span class="keyword">null</span>) &#123;</div><div class="line">		transformer = RequestTransformer.IDENTITY;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	Stats stats = <span class="keyword">new</span> Stats(cache);</div><div class="line">	</div><div class="line">	Dispatcher dispatcher = <span class="keyword">new</span> Dispatcher(context, service, HANDLER, downloader, cache, stats);</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Picasso(context, dispatcher, cache, listener, transformer, requestHandlers, stats,          defaultBitmapConfig, indicatorsEnabled, loggingEnabled);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Builder 类是 Picasso 这个类中的静态内部类，而 build() 方法是 Builder 类中的成员方法，可以看出采用<strong>建造者模式</strong>。那么 build() 方法实现的功能主要有：</p>
<ul>
<li><p>创建默认下载器 Downloader</p>
</li>
<li><p>创建默认内存缓存 LruCache （由于接口 Cache 支持多线程访问，所以实现该接口时需确保线程安全）</p>
</li>
<li><p>创建默认线程池 PicassoExecutorService </p>
</li>
<li><p>创建默认请求转发器 RequestTransformer</p>
</li>
<li><p>创建默认统计 Stats</p>
</li>
<li><p>创建默认调度器 Dispatcher</p>
</li>
<li><p>创建 Picasso 实例</p>
</li>
</ul>
<p>那么这些实例是如何创建的，下面主要通过流程图来解析（主要是方法间的调用以及方法内部部分细节）。</p>
<ul>
<li>Downloader 是一个接口，无法实例化，需要通过实现类创建实例，该接口的功能主要从磁盘缓存加载图片或网络下载图片。OkHttpDownloader 和 UrlConnectionDownloader 分别实现该接口，那么创建实例也是通过这两个实现类来创建的，那么来看下实例化 Downloader 流程。</li>
</ul>
<p><img src="/images/picasso/downloader.png" alt=""></p>
<ul>
<li>LruCache 是内存缓存类，实现接口 Cache，采用最近最少使用算法。</li>
</ul>
<p><img src="/images/picasso/cache.png" alt=""></p>
<ul>
<li><p>PicassoExecutorService 继承 ThreadPoolExecutor，是线程池，供图片下载，线程数根据不同网络类型设置，默认的线程数是 3 个，直接通过 new 操作符实例化对象。</p>
</li>
<li><p>RequestTransformer 是一个接口，功能是在发送请求之前对图片进行转换处理。从源码中可以看出，这是一个测试功能，在后续版本可能不兼容，使用该功能时得谨慎。</p>
</li>
<li><p>对于 Stats 实例的创建，直接 new 一个对象，那么主要来看该构造方法做了哪些操作？代码如下：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Stats(Cache cache) &#123;</div><div class="line">    <span class="keyword">this</span>.cache = cache;</div><div class="line">    <span class="keyword">this</span>.statsThread = <span class="keyword">new</span> HandlerThread(STATS_THREAD_NAME, THREAD_PRIORITY_BACKGROUND);</div><div class="line">    <span class="keyword">this</span>.statsThread.start();</div><div class="line">    Utils.flushStackLocalLeaks(statsThread.getLooper());</div><div class="line">    <span class="keyword">this</span>.handler = <span class="keyword">new</span> StatsHandler(statsThread.getLooper(), <span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要是实例化对象，结合注释应该不难理解。</p>
<p>Dispatcher 实例的创建与 Stats 类似，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Dispatcher(Context context, ExecutorService service, Handler mainThreadHandler,      Downloader downloader, Cache cache, Stats stats) &#123;</div><div class="line">      </div><div class="line">      <span class="comment">// dispatcherThread 是子线程，注意记得调用 start() 方法  </span></div><div class="line">      <span class="keyword">this</span>.dispatcherThread = <span class="keyword">new</span> DispatcherThread();</div><div class="line">      <span class="keyword">this</span>.dispatcherThread.start();</div><div class="line">      Utils.flushStackLocalLeaks(dispatcherThread.getLooper());</div><div class="line">      <span class="keyword">this</span>.context = context;</div><div class="line">      <span class="keyword">this</span>.service = service;</div><div class="line">      <span class="keyword">this</span>.hunterMap = <span class="keyword">new</span> LinkedHashMap&lt;String, BitmapHunter&gt;();</div><div class="line">      <span class="keyword">this</span>.failedActions = <span class="keyword">new</span> WeakHashMap&lt;Object, Action&gt;();</div><div class="line">      <span class="keyword">this</span>.pausedActions = <span class="keyword">new</span> WeakHashMap&lt;Object, Action&gt;();</div><div class="line">      <span class="keyword">this</span>.pausedTags = <span class="keyword">new</span> HashSet&lt;Object&gt;();</div><div class="line">      <span class="comment">// 注意该 handler 是在子线程的</span></div><div class="line">      <span class="keyword">this</span>.handler = <span class="keyword">new</span> DispatcherHandler(dispatcherThread.getLooper(), <span class="keyword">this</span>);</div><div class="line">      <span class="keyword">this</span>.downloader = downloader;</div><div class="line">      <span class="comment">// 在主线程</span></div><div class="line">      <span class="keyword">this</span>.mainThreadHandler = mainThreadHandler;</div><div class="line">      <span class="keyword">this</span>.cache = cache;</div><div class="line">      <span class="keyword">this</span>.stats = stats;</div><div class="line">      <span class="keyword">this</span>.batch = <span class="keyword">new</span> ArrayList&lt;BitmapHunter&gt;(<span class="number">4</span>);</div><div class="line">      <span class="keyword">this</span>.airplaneMode = Utils.isAirplaneModeOn(<span class="keyword">this</span>.context);</div><div class="line">      <span class="keyword">this</span>.scansNetworkChanges = hasPermission(context, Manifest.permission.ACCESS_NETWORK_STATE);</div><div class="line">      <span class="keyword">this</span>.receiver = <span class="keyword">new</span> NetworkBroadcastReceiver(<span class="keyword">this</span>);</div><div class="line">      receiver.register();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，也是最重要的一点，那就是 Picasso 实例的创建，先看下代码吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">Picasso(Context context, Dispatcher dispatcher, Cache cache, Listener listener,      RequestTransformer requestTransformer, List&lt;RequestHandler&gt; extraRequestHandlers, Stats stats,      Bitmap.Config defaultBitmapConfig, <span class="keyword">boolean</span> indicatorsEnabled, <span class="keyword">boolean</span> loggingEnabled) &#123;</div><div class="line">      </div><div class="line">      </div><div class="line">    <span class="keyword">this</span>.context = context;</div><div class="line">    <span class="keyword">this</span>.dispatcher = dispatcher;</div><div class="line">    <span class="keyword">this</span>.cache = cache;</div><div class="line">    <span class="keyword">this</span>.listener = listener;</div><div class="line">    <span class="keyword">this</span>.requestTransformer = requestTransformer;</div><div class="line">    <span class="keyword">this</span>.defaultBitmapConfig = defaultBitmapConfig;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> builtInHandlers = <span class="number">7</span>; <span class="comment">// Adjust this as internal handlers are added or removed.</span></div><div class="line">    <span class="keyword">int</span> extraCount = (extraRequestHandlers != <span class="keyword">null</span> ? extraRequestHandlers.size() : <span class="number">0</span>);</div><div class="line">    List&lt;RequestHandler&gt; allRequestHandlers =        <span class="keyword">new</span> ArrayList&lt;RequestHandler&gt;(builtInHandlers + extraCount);</div><div class="line">        </div><div class="line">    <span class="comment">// ResourceRequestHandler needs to be the first in the list to avoid</span></div><div class="line">    <span class="comment">// forcing other RequestHandlers to perform null checks on request.uri</span></div><div class="line">    <span class="comment">// to cover the (request.resourceId != 0) case.</span></div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> ResourceRequestHandler(context));</div><div class="line">    <span class="keyword">if</span> (extraRequestHandlers != <span class="keyword">null</span>) &#123;</div><div class="line">    	allRequestHandlers.addAll(extraRequestHandlers);</div><div class="line">    &#125;</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> ContactsPhotoRequestHandler(context));</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> MediaStoreRequestHandler(context));</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> ContentStreamRequestHandler(context));</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> AssetRequestHandler(context));</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> FileRequestHandler(context));</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> NetworkRequestHandler(dispatcher.downloader, stats));</div><div class="line">    requestHandlers = Collections.unmodifiableList(allRequestHandlers);</div><div class="line">    </div><div class="line">    <span class="keyword">this</span>.stats = stats;</div><div class="line">    <span class="keyword">this</span>.targetToAction = <span class="keyword">new</span> WeakHashMap&lt;Object, Action&gt;();</div><div class="line">    <span class="keyword">this</span>.targetToDeferredRequestCreator = <span class="keyword">new</span> WeakHashMap&lt;ImageView, DeferredRequestCreator&gt;();</div><div class="line">    <span class="keyword">this</span>.indicatorsEnabled = indicatorsEnabled;</div><div class="line">    <span class="keyword">this</span>.loggingEnabled = loggingEnabled;</div><div class="line">    <span class="keyword">this</span>.referenceQueue = <span class="keyword">new</span> ReferenceQueue&lt;Object&gt;();</div><div class="line">    <span class="keyword">this</span>.cleanupThread = <span class="keyword">new</span> CleanupThread(referenceQueue, HANDLER);</div><div class="line">    <span class="keyword">this</span>.cleanupThread.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除了对一些对象赋值外，重要的一点就是创建和添加 RequestHandler，代码主要在 19 ~ 29 行，比如文件、网络、资源等处理器。至此，Picasso 实例也就创建完毕了，那么接下来看 load() 方法是如何实现的。</p>
<h4 id="Picasso-load-方法解析"><a href="#Picasso-load-方法解析" class="headerlink" title="Picasso.load() 方法解析"></a>Picasso.load() 方法解析</h4><p>load() 有多个重载方法，可以传入 resourceId、string、file、uri，但是最后都是返回 RequestCreator 实例，接下来就来看该方法如何实现？代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> RequestCreator <span class="title">load</span><span class="params">(<span class="keyword">int</span> resourceId)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (resourceId == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Resource ID must not be zero."</span>);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestCreator(<span class="keyword">this</span>, <span class="keyword">null</span>, resourceId);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很明显地看出，调用 load() 方法后返回的是 RequestCreator 实例，那么来看下 RequestCreator 构造方法是咋样的，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">RequestCreator(Picasso picasso, Uri uri, <span class="keyword">int</span> resourceId) &#123;</div><div class="line">    <span class="keyword">if</span> (picasso.shutdown) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Picasso instance already shut down. Cannot submit new requests."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.picasso = picasso;</div><div class="line">    <span class="keyword">this</span>.data = <span class="keyword">new</span> Request.Builder(uri, resourceId, picasso.defaultBitmapConfig);&#125;</div></pre></td></tr></table></figure>
<p>创建 Request.Builder 对象，并将需要加载图片信息封装到该对象里，采用建造者模式。对于一些操作比如 rotate、centerCrop、centerInside、resize 等，其实只是修改其状态，真正执行操作是方法 into，该方法是核心方法，以下重点分析。</p>
<h4 id="into-方法解析"><a href="#into-方法解析" class="headerlink" title="into() 方法解析"></a>into() 方法解析</h4><p>into() 有 5 个重载方法，每个方法实现的主要功能基本相同，但是稍微还是有点不一样的。以常用 <strong>into(ImageView target)</strong> 这个方法为例子来讲解下内部是如何实现的？由于个人比较喜欢画流程图来理清方法之间调用关系，于是就有下面的流程图：</p>
<p><img src="/images/picasso/into.png" alt=""></p>
<p>结合流程图再来看源码应该会比较好理解，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">into</span><span class="params">(ImageView target)</span> </span>&#123;</div><div class="line">    into(target, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法所持有的 ImageView 实例是一个弱引用，内存不足情况下可以自动被垃圾回收器回收。很明显，该方法调用重载方法 <strong>into(target, null)</strong>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">into</span><span class="params">(ImageView target, Callback callback)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> started = System.nanoTime();</div><div class="line">    checkMain();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Target must not be null."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!data.hasImage()) &#123;</div><div class="line">      picasso.cancelRequest(target);</div><div class="line">      <span class="keyword">if</span> (setPlaceholder) &#123;</div><div class="line">        setPlaceholder(target, getPlaceholderDrawable());</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (deferred) &#123;</div><div class="line">      <span class="keyword">if</span> (data.hasSize()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fit cannot be used with resize."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">int</span> width = target.getWidth();</div><div class="line">      <span class="keyword">int</span> height = target.getHeight();</div><div class="line">      <span class="keyword">if</span> (width == <span class="number">0</span> || height == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (setPlaceholder) &#123;</div><div class="line">          setPlaceholder(target, getPlaceholderDrawable());</div><div class="line">        &#125;</div><div class="line">        picasso.defer(target, <span class="keyword">new</span> DeferredRequestCreator(<span class="keyword">this</span>, target, callback));</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      data.resize(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Request request = createRequest(started);</div><div class="line">    String requestKey = createKey(request);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (shouldReadFromMemoryCache(memoryPolicy)) &#123;</div><div class="line">      Bitmap bitmap = picasso.quickMemoryCacheCheck(requestKey);</div><div class="line">      <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">        picasso.cancelRequest(target);</div><div class="line">        setBitmap(target, picasso.context, bitmap, MEMORY, noFade, picasso.indicatorsEnabled);</div><div class="line">        <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">          log(OWNER_MAIN, VERB_COMPLETED, request.plainId(), <span class="string">"from "</span> + MEMORY);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</div><div class="line">          callback.onSuccess();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (setPlaceholder) &#123;</div><div class="line">      setPlaceholder(target, getPlaceholderDrawable());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Action action =</div><div class="line">        <span class="keyword">new</span> ImageViewAction(picasso, target, request, memoryPolicy, networkPolicy, errorResId,</div><div class="line">            errorDrawable, requestKey, tag, callback, noFade);</div><div class="line"></div><div class="line">    picasso.enqueueAndSubmit(action);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参数 Callback 是一个强引用，将会阻止 Activity 或者 Fragment 被回收，从而导致内存泄漏。如果使用该方法，在释放资源时最好调用 Picasso 类 <strong>cancelRequest(android.widget.ImageView)</strong> 方法取消请求，以免造成内存泄漏。从源码可以清晰地看出该方法实现的主要功能：</p>
<ul>
<li><p>检查当前线程是否为主线程；如果是主线程，则继续执行；否则抛出异常。</p>
</li>
<li><p>判断目标组件 ImageView 是否为 null；如果不为 null，则继续执行；否则抛出异常。</p>
</li>
<li><p>检查发送请求是否包含要加载图片 uri 或 resourceId；如果没有，则调用Picasso 类 <strong>cancelRequest(android.widget.ImageView)</strong> 方法取消请求（后面讲解该方法），并检查是否设置默认图片；否则继续执行。</p>
</li>
<li><p>检查是否调用方法 fit()，即 deferred 是否为 true，true 表示调用，false 表示调用 unfit() 方法；调用该方法意味着延迟加载图片，并且不能与方法 resize() 同时使用。</p>
</li>
<li><p>为加载图片创建请求。</p>
</li>
<li><p>为每个请求创建 key，主要是为了方便存储。</p>
</li>
<li><p>根据缓存策略判断是否从内存缓存读取。</p>
</li>
<li><p>是否设置默认图片。</p>
</li>
<li><p>创建对应的 Action 实例，在这里是 ImageViewAction。</p>
</li>
<li><p>入队和提交 action。</p>
</li>
</ul>
<p>以上是总体概括，接下来逐一看具体实现。</p>
<p>那么先来看下 <strong>cancelRequest(android.widget.ImageView)</strong> 具体实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelRequest</span><span class="params">(ImageView view)</span> </span>&#123;</div><div class="line">    cancelExistingRequest(view);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>只有一行代码，调用 <strong>cancelExistingRequest(view)</strong> 方法，看下具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelExistingRequest</span><span class="params">(Object target)</span> </span>&#123;</div><div class="line">    checkMain();</div><div class="line">    Action action = targetToAction.remove(target);</div><div class="line">    <span class="keyword">if</span> (action != <span class="keyword">null</span>) &#123;</div><div class="line">      action.cancel();</div><div class="line">      dispatcher.dispatchCancel(action);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (target <span class="keyword">instanceof</span> ImageView) &#123;</div><div class="line">      ImageView targetImageView = (ImageView) target;</div><div class="line">      DeferredRequestCreator deferredRequestCreator =</div><div class="line">          targetToDeferredRequestCreator.remove(targetImageView);</div><div class="line">      <span class="keyword">if</span> (deferredRequestCreator != <span class="keyword">null</span>) &#123;</div><div class="line">        deferredRequestCreator.cancel();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>按照惯例，先列出该方法实现的主要功能：</p>
<ul>
<li><p>检查当前线程是否为主线程；如果是主线程，则继续执行；否则抛出异常。</p>
</li>
<li><p>通过 key 从 targetToAction 移除对应 action。</p>
</li>
<li><p>如果 action 不为 null，执行一些取消操作，相当于释放资源。</p>
</li>
<li><p>如果目标组件是 ImageView，则检查是否调用 fit() 方法，是的话就执行一些取消操作。</p>
</li>
</ul>
<p>接着来看下取消操作方法 <strong>dispatcher.dispatchCancel(action)</strong> 具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchCancel</span><span class="params">(Action action)</span> </span>&#123;</div><div class="line">    handler.sendMessage(handler.obtainMessage(REQUEST_CANCEL, action));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很明显是通过 Handler 消息机制来处理的。即 Dispatcher 类中 DispatcherHandler 发送消息 <strong>REQUEST_CANCEL</strong>，并在其回调方法 <strong>handleMessage(final Message msg)</strong> 实现具体逻辑，注意是在子线程执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</div><div class="line">	<span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">		<span class="keyword">case</span> REQUEST_CANCEL: &#123;</div><div class="line">			Action action = (Action) msg.obj;</div><div class="line">			dispatcher.performCancel(action);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			Picasso.HANDLER.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">				<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unknown handler message received: "</span> + msg.what);</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着来看下 <strong>dispatcher.performCancel(action)</strong> 具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">performCancel</span><span class="params">(Action action)</span> </span>&#123;</div><div class="line">    String key = action.getKey();</div><div class="line">    BitmapHunter hunter = hunterMap.get(key);</div><div class="line">    <span class="keyword">if</span> (hunter != <span class="keyword">null</span>) &#123;</div><div class="line">      hunter.detach(action);</div><div class="line">      <span class="keyword">if</span> (hunter.cancel()) &#123;</div><div class="line">        hunterMap.remove(key);</div><div class="line">        <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</div><div class="line">          log(OWNER_DISPATCHER, VERB_CANCELED, action.getRequest().logId());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pausedTags.contains(action.getTag())) &#123;</div><div class="line">      pausedActions.remove(action.getTarget());</div><div class="line">      <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</div><div class="line">        log(OWNER_DISPATCHER, VERB_CANCELED, action.getRequest().logId(),</div><div class="line">            <span class="string">"because paused request got canceled"</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Action remove = failedActions.remove(action.getTarget());</div><div class="line">    <span class="keyword">if</span> (remove != <span class="keyword">null</span> &amp;&amp; remove.getPicasso().loggingEnabled) &#123;</div><div class="line">      log(OWNER_DISPATCHER, VERB_CANCELED, remove.getRequest().logId(), <span class="string">"from replaying"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从以上代码很清晰地看出该方法主要做一些取消、移除操作，即释放资源。以上就是 <strong>cancelExistingRequest(view)</strong> 内部实现解析。</p>
<p>回到 <strong>into(target, null)</strong> 内部实现，看下创建请求 <strong>createRequest(started)</strong> 具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">createRequest</span><span class="params">(<span class="keyword">long</span> started)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> id = nextId.getAndIncrement();</div><div class="line"></div><div class="line">    Request request = data.build();</div><div class="line">    request.id = id;</div><div class="line">    request.started = started;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> loggingEnabled = picasso.loggingEnabled;</div><div class="line">    <span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">      log(OWNER_MAIN, VERB_CREATED, request.plainId(), request.toString());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Request transformed = picasso.transformRequest(request);</div><div class="line">    <span class="keyword">if</span> (transformed != request) &#123;</div><div class="line">      <span class="comment">// If the request was changed, copy over the id and timestamp from the original.</span></div><div class="line">      transformed.id = id;</div><div class="line">      transformed.started = started;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">        log(OWNER_MAIN, VERB_CHANGED, transformed.logId(), <span class="string">"into "</span> + transformed);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> transformed;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实实现逻辑很简单，对要加载图片的具体信息封装成 Request；通过 Request 创建对应 key，那么来看下是如何创建的，即 <strong>createKey(request)</strong> 方法具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">createKey</span><span class="params">(Request data)</span> </span>&#123;</div><div class="line">	String result = createKey(data, MAIN_THREAD_KEY_BUILDER);</div><div class="line">    MAIN_THREAD_KEY_BUILDER.setLength(<span class="number">0</span>);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>逻辑很简单，调用方法 <strong>createKey(data, MAIN_THREAD_KEY_BUILDER)</strong>，看下具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">createKey</span><span class="params">(Request data, StringBuilder builder)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (data.stableKey != <span class="keyword">null</span>) &#123;</div><div class="line">      builder.ensureCapacity(data.stableKey.length() + KEY_PADDING);</div><div class="line">      builder.append(data.stableKey);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.uri != <span class="keyword">null</span>) &#123;</div><div class="line">      String path = data.uri.toString();</div><div class="line">      builder.ensureCapacity(path.length() + KEY_PADDING);</div><div class="line">      builder.append(path);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      builder.ensureCapacity(KEY_PADDING);</div><div class="line">      builder.append(data.resourceId);</div><div class="line">    &#125;</div><div class="line">    builder.append(KEY_SEPARATOR);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.rotationDegrees != <span class="number">0</span>) &#123;</div><div class="line">      builder.append(<span class="string">"rotation:"</span>).append(data.rotationDegrees);</div><div class="line">      <span class="keyword">if</span> (data.hasRotationPivot) &#123;</div><div class="line">        builder.append(<span class="string">'@'</span>).append(data.rotationPivotX).append(<span class="string">'x'</span>).append(data.rotationPivotY);</div><div class="line">      &#125;</div><div class="line">      builder.append(KEY_SEPARATOR);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (data.hasSize()) &#123;</div><div class="line">      builder.append(<span class="string">"resize:"</span>).append(data.targetWidth).append(<span class="string">'x'</span>).append(data.targetHeight);</div><div class="line">      builder.append(KEY_SEPARATOR);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (data.centerCrop) &#123;</div><div class="line">      builder.append(<span class="string">"centerCrop"</span>).append(KEY_SEPARATOR);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.centerInside) &#123;</div><div class="line">      builder.append(<span class="string">"centerInside"</span>).append(KEY_SEPARATOR);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.transformations != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">//noinspection ForLoopReplaceableByForEach</span></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = data.transformations.size(); i &lt; count; i++) &#123;</div><div class="line">        builder.append(data.transformations.get(i).key());</div><div class="line">        builder.append(KEY_SEPARATOR);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> builder.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很简单，根据 Request 设置的属性拼接为字符串，作为最终的 key 并返回。</p>
<p>当我们调用不同 <strong>into()</strong> 方法时，Picasso 就会实例化不同的 Action，而这里我们是以 <strong>into(ImageView)</strong> 为例子，因此会实例化 ImageViewAction，在 ImageView 有回调方法，供我们使用，后续会看到。一切都准备就绪，那么就可以入队和提交 action。那么是如何实现的呢？来看下具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueueAndSubmit</span><span class="params">(Action action)</span> </span>&#123;</div><div class="line">	Object target = action.getTarget();</div><div class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span> &amp;&amp; targetToAction.get(target) != action) &#123;</div><div class="line">      <span class="comment">// This will also check we are on the main thread.</span></div><div class="line">      cancelExistingRequest(target);</div><div class="line">      targetToAction.put(target, action);</div><div class="line">    &#125;</div><div class="line">    submit(action);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 key 从 targetToAction 获取 action，不存在的话就执行检查操作并将 action 插入到 targetToAction，最后调用 <strong>submit(action)</strong>，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(Action action)</span> </span>&#123;</div><div class="line">    dispatcher.dispatchSubmit(action);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后还是回到 Dispatcher，通过 DispatcherHandler 消息机制发送消息 <strong>REQUEST_SUBMIT</strong>，并在其回调方法 并在其回调方法 <strong>handleMessage(final Message msg)</strong> 实现具体逻辑，注意是在子线程执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">        <span class="keyword">case</span> REQUEST_SUBMIT: &#123;</div><div class="line">          Action action = (Action) msg.obj;</div><div class="line">          dispatcher.performSubmit(action);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            Picasso.HANDLER.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unknown handler message received: "</span> + msg.what);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着来看下 <strong>dispatcher.performSubmit(action)</strong> 具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">performSubmit</span><span class="params">(Action action)</span> </span>&#123;</div><div class="line">    performSubmit(action, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>只有一行代码，调用方法 <strong>performSubmit(action, true)</strong>，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">performSubmit</span><span class="params">(Action action, <span class="keyword">boolean</span> dismissFailed)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (pausedTags.contains(action.getTag())) &#123;</div><div class="line">      pausedActions.put(action.getTarget(), action);</div><div class="line">      <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</div><div class="line">        log(OWNER_DISPATCHER, VERB_PAUSED, action.request.logId(),</div><div class="line">            <span class="string">"because tag '"</span> + action.getTag() + <span class="string">"' is paused"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    BitmapHunter hunter = hunterMap.get(action.getKey());</div><div class="line">    <span class="keyword">if</span> (hunter != <span class="keyword">null</span>) &#123;</div><div class="line">      hunter.attach(action);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (service.isShutdown()) &#123;</div><div class="line">      <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</div><div class="line">        log(OWNER_DISPATCHER, VERB_IGNORED, action.request.logId(), <span class="string">"because shut down"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    hunter = forRequest(action.getPicasso(), <span class="keyword">this</span>, cache, stats, action);</div><div class="line">    hunter.future = service.submit(hunter);</div><div class="line">    hunterMap.put(action.getKey(), hunter);</div><div class="line">    <span class="keyword">if</span> (dismissFailed) &#123;</div><div class="line">      failedActions.remove(action.getTarget());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</div><div class="line">      log(OWNER_DISPATCHER, VERB_ENQUEUED, action.request.logId());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简要概括下该方法实现的主要功能：</p>
<ul>
<li><p>检查标记 tag 请求是否被取消，如果被取消，则将对应 action 插入到 pausedActions 并退出程序；否则继续执行。</p>
</li>
<li><p>通过 key 从 hunterMap 获取相应 BitmapHunter 并判断其是否为 null，如果不为 null，则调用其方法 <strong>attach(Action)</strong> 并结束退出程序；否则继续执行。简要说明下，BitmapHunter 实现接口 Runnable，意味着开启线程在后台执行任务。</p>
</li>
<li><p>检查线程池是否停止工作。</p>
</li>
<li><p>创建 BitmapHunter 实例，即调用方法 <strong>forRequest(action.getPicasso(), this, cache, stats, action)</strong></p>
</li>
<li><p>将 hunter 提交到线程池并执行，即调用 <strong>service.submit(hunter)</strong></p>
</li>
</ul>
<p>看下 <strong>forRequest()</strong> 方法具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> BitmapHunter <span class="title">forRequest</span><span class="params">(Picasso picasso, Dispatcher dispatcher, Cache cache, Stats stats,</span></span></div><div class="line">      Action action) &#123;</div><div class="line">    Request request = action.getRequest();</div><div class="line">    List&lt;RequestHandler&gt; requestHandlers = picasso.getRequestHandlers();</div><div class="line"></div><div class="line">    <span class="comment">// Index-based loop to avoid allocating an iterator.</span></div><div class="line">    <span class="comment">//noinspection ForLoopReplaceableByForEach</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = requestHandlers.size(); i &lt; count; i++) &#123;</div><div class="line">      RequestHandler requestHandler = requestHandlers.get(i);</div><div class="line">      <span class="keyword">if</span> (requestHandler.canHandleRequest(request)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BitmapHunter(picasso, dispatcher, cache, stats, action, requestHandler);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BitmapHunter(picasso, dispatcher, cache, stats, action, ERRORING_HANDLER);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过调用 RequestHandler 中 <strong>canHandleRequest(Request)</strong> 方法逐一检查对应 RequestHandler，并创建 BitmapHunter 对象返回。然后将 hunter 提交到线程池并执行。<strong>submit(Runnable)</strong> 是接口 ExecutorService 里的方法，PicassoExecutorService 实现接口 ExecutorService，因此 <strong>submit(Runnable)</strong> 方法的实现逻辑在 PicassoExecutorService 类里面，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</div><div class="line">    PicassoFutureTask ftask = <span class="keyword">new</span> PicassoFutureTask((BitmapHunter) task);</div><div class="line">    execute(ftask);</div><div class="line">    <span class="keyword">return</span> ftask;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>execute(ftask)</strong> 执行任务，由于 BitmapHunter 实现接口 Runnable，意味着开启线程在后台执行任务；而在该方法里会调用线程 <strong>start()</strong> 方法，意味着 BtimapHunter 中 <strong>run()</strong> 会被调用，真正执行任务逻辑在该方法里面实现，接下来的重点肯定是来研究该方法内部实现逻辑，在研究源代码之前，先来看该方法内部实现流程图：</p>
<p><img src="/images/picasso/run.png" alt=""></p>
<p>同样结合流程图来解析 <strong>run()</strong> 内部实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		updateThreadName(data);</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">			log(OWNER_HUNTER, VERB_EXECUTING, getLogIdsForHunter(<span class="keyword">this</span>));</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		result = hunt();</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">			dispatcher.dispatchFailed(<span class="keyword">this</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			dispatcher.dispatchComplete(<span class="keyword">this</span>);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">catch</span> (Downloader.ResponseException e) &#123;</div><div class="line">		<span class="keyword">if</span> (!e.localCacheOnly || e.responseCode != <span class="number">504</span>) &#123;</div><div class="line">        	exception = e;</div><div class="line">       	&#125;</div><div class="line">       	dispatcher.dispatchFailed(<span class="keyword">this</span>);</div><div class="line">       	&#125; <span class="keyword">catch</span> (NetworkRequestHandler.ContentLengthException e) &#123;</div><div class="line">       		exception = e;</div><div class="line">      		dispatcher.dispatchRetry(<span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      		exception = e;</div><div class="line">      		dispatcher.dispatchRetry(<span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</div><div class="line">      		StringWriter writer = <span class="keyword">new</span> StringWriter();</div><div class="line">      		stats.createSnapshot().dump(<span class="keyword">new</span> PrintWriter(writer));</div><div class="line">      		exception = <span class="keyword">new</span> RuntimeException(writer.toString(), e);</div><div class="line">      		dispatcher.dispatchFailed(<span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      		exception = e;</div><div class="line">      		dispatcher.dispatchFailed(<span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      		Thread.currentThread().setName(Utils.THREAD_IDLE_NAME);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简要概括下该方法实现的主要功能：</p>
<ul>
<li><p>更新线程名字。</p>
</li>
<li><p>返回 Bitmap 对象并赋值给 result。</p>
</li>
<li><p>判断返回结果 result 是否为 null，如果为 null，则调用 <strong>dispatcher.dispatchFailed(this)</strong>；否则调用 <strong>dispatcher.dispatchComplete(this)</strong></p>
</li>
<li><p>各种异常处理。</p>
</li>
</ul>
<p>从源代码可以看出，核心的逻辑在方法 <strong>hunt()</strong>，那么它的内部实现又是怎么呢？具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function">Bitmap <span class="title">hunt</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (shouldReadFromMemoryCache(memoryPolicy)) &#123;</div><div class="line">      bitmap = cache.get(key);</div><div class="line">      <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">        stats.dispatchCacheHit();</div><div class="line">        loadedFrom = MEMORY;</div><div class="line">        <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">          log(OWNER_HUNTER, VERB_DECODED, data.logId(), <span class="string">"from cache"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> bitmap;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    data.networkPolicy = retryCount == <span class="number">0</span> ? NetworkPolicy.OFFLINE.index : networkPolicy;</div><div class="line">    RequestHandler.Result result = requestHandler.load(data, networkPolicy);</div><div class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line">      loadedFrom = result.getLoadedFrom();</div><div class="line">      exifRotation = result.getExifOrientation();</div><div class="line"></div><div class="line">      bitmap = result.getBitmap();</div><div class="line"></div><div class="line">      <span class="comment">// If there was no Bitmap then we need to decode it from the stream.</span></div><div class="line">      <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</div><div class="line">        InputStream is = result.getStream();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          bitmap = decodeStream(is, data);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          Utils.closeQuietly(is);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">        log(OWNER_HUNTER, VERB_DECODED, data.logId());</div><div class="line">      &#125;</div><div class="line">      stats.dispatchBitmapDecoded(bitmap);</div><div class="line">      <span class="keyword">if</span> (data.needsTransformation() || exifRotation != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (DECODE_LOCK) &#123;</div><div class="line">          <span class="keyword">if</span> (data.needsMatrixTransform() || exifRotation != <span class="number">0</span>) &#123;</div><div class="line">            bitmap = transformResult(data, bitmap, exifRotation);</div><div class="line">            <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">              log(OWNER_HUNTER, VERB_TRANSFORMED, data.logId());</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (data.hasCustomTransformations()) &#123;</div><div class="line">            bitmap = applyCustomTransformations(data.transformations, bitmap);</div><div class="line">            <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">              log(OWNER_HUNTER, VERB_TRANSFORMED, data.logId(), <span class="string">"from custom transformations"</span>);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">          stats.dispatchBitmapTransformed(bitmap);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> bitmap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码实现确实很复杂，没事，先概括下其实现的主要小功能，再逐一解析：</p>
<ul>
<li><p>根据缓存策略判断是否从内存缓存读取 bitmap，true 表示直接读取并返回 bitmap；否则继续执行。</p>
</li>
<li><p>根据不同请求资源调用相应 RequestHandler 中 <strong>load()</strong> 方法下载图片，这里以网络请求资源为例子来讲解，即 NetworkRequestHandler。</p>
</li>
<li><p>从下载返回结果 RequestHandler.Result 获取 bitmap，判断是否为 null   做出相应的处理。</p>
</li>
</ul>
<p>重点来 NetworkRequestHandler 类 <strong>load()</strong> 方法具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">load</span><span class="params">(Request request, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Response response = downloader.load(request.uri, request.networkPolicy);</div><div class="line">    <span class="keyword">if</span> (response == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Picasso.LoadedFrom loadedFrom = response.cached ? DISK : NETWORK;</div><div class="line"></div><div class="line">    Bitmap bitmap = response.getBitmap();</div><div class="line">    <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Result(bitmap, loadedFrom);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    InputStream is = response.getInputStream();</div><div class="line">    <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Sometimes response content length is zero when requests are being replayed. Haven't found</span></div><div class="line">    <span class="comment">// root cause to this but retrying the request seems safe to do so.</span></div><div class="line">    <span class="keyword">if</span> (loadedFrom == DISK &amp;&amp; response.getContentLength() == <span class="number">0</span>) &#123;</div><div class="line">      Utils.closeQuietly(is);</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ContentLengthException(<span class="string">"Received response with 0 content-length header."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (loadedFrom == NETWORK &amp;&amp; response.getContentLength() &gt; <span class="number">0</span>) &#123;</div><div class="line">      stats.dispatchDownloadFinished(response.getContentLength());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(is, loadedFrom);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>第 3 行代码实现图片下载，即客户端发送网络请求，服务端对客户端的请求作出响应，客户端根据服务端返回的结果作出处理。那么是如何实现下载的呢？downloader 是 Downloader 实例，而 Downloader 是接口，无法实例化，需要在子类实例化，而该接口有两个实现类：OkHttpDownloader 和 UrlConnectionDownloader。至于调用哪个类 <strong>load()</strong> 方法，取决于当前 sdk 最低版本是否在 API 14及以上。这里以 OkHttpDownloader 类 <strong>load()</strong> 方法为例来讲解是如何实现下载的，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">load</span><span class="params">(Uri uri, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    CacheControl cacheControl = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (networkPolicy != <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (NetworkPolicy.isOfflineOnly(networkPolicy)) &#123;</div><div class="line">        cacheControl = CacheControl.FORCE_CACHE;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        CacheControl.Builder builder = <span class="keyword">new</span> CacheControl.Builder();</div><div class="line">        <span class="keyword">if</span> (!NetworkPolicy.shouldReadFromDiskCache(networkPolicy)) &#123;</div><div class="line">          builder.noCache();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!NetworkPolicy.shouldWriteToDiskCache(networkPolicy)) &#123;</div><div class="line">          builder.noStore();</div><div class="line">        &#125;</div><div class="line">        cacheControl = builder.build();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Request.Builder builder = <span class="keyword">new</span> Request.Builder().url(uri.toString());</div><div class="line">    <span class="keyword">if</span> (cacheControl != <span class="keyword">null</span>) &#123;</div><div class="line">      builder.cacheControl(cacheControl);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    com.squareup.okhttp.Response response = client.newCall(builder.build()).execute();</div><div class="line">    <span class="keyword">int</span> responseCode = response.code();</div><div class="line">    <span class="keyword">if</span> (responseCode &gt;= <span class="number">300</span>) &#123;</div><div class="line">      response.body().close();</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResponseException(responseCode + <span class="string">" "</span> + response.message(), networkPolicy,</div><div class="line">          responseCode);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> fromCache = response.cacheResponse() != <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    ResponseBody responseBody = response.body();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Response(responseBody.byteStream(), fromCache, responseBody.contentLength());</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>第 3 - 17 行代码主要是设置缓存策略；第 24 行通过调用 OkHttp 库 API 实现图片下载任务，并返回响应结果 com.squareup.okhttp.Response；最后对响应结果作出相应处理并创建 Response 对象返回。</p>
<p>再回到 NetworkRequestHandler 类 <strong>load()</strong> 方法，从返回 Response 对象调用 <strong>getBitmap()</strong> 方法获取 Bitmap 对象并判断其是否为 null，如果不为 null，则将 bitmap 和 loadedfrom 传入 Result 构造器方法中，创建 Result 对象并返回；否则调用 <strong>getInputStream()</strong> 方法获取输入流，不为 null 的话则创建 Result 对象并返回。</p>
<p>回到 <strong>hunt()</strong> 方法，从返回结果 result 获取数据类型为 Bitmap 对象 bitmap，并判断其是否为 null 作出不同的处理。如果 bitmap 不为 null，则判断原先发送加载图片请求 Request 是否需要对图片进行转换处理，即裁剪、缩放、重置大小等；不需要的话直接返回 bitmap；需要的话做转换处理后再返回 bitmap；如果 bitmap 为 null，则从 result 获取输入流 InputStream，并对 is 进行解析转换成 Bitmap 类型，将获取到的结果返回。</p>
<p><strong>hunt()</strong> 方法解析完了，回到 <strong>run()</strong> 方法。根据调用方法 <strong>hunt()</strong> 返回结果 result，类型为 Bitmap，判断其是否为 null 并作出相应的处理。那么就来看下不为 null 的情况下又做了什么操作，即第 14 行代码，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchComplete</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</div><div class="line">    handler.sendMessage(handler.obtainMessage(HUNTER_COMPLETE, hunter));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很明显，又采用 Handler 消息机制处理，即 Dispatcher 类中 DispatcherHandler 发送消息 HUNTER_COMPLETE，其回调方法 <strong>handleMessage(final Message msg)</strong> 收到消息后并处理。说明一下，DispatcherHandler 所在的线程为子线程，即 DispatcherThread。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">        <span class="keyword">case</span> HUNTER_COMPLETE: &#123;</div><div class="line">          BitmapHunter hunter = (BitmapHunter) msg.obj;</div><div class="line">          dispatcher.performComplete(hunter);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            Picasso.HANDLER.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unknown handler message received: "</span> + msg.what);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在其回调方法中，核心代码是第 6 行，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">performComplete</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (shouldWriteToMemoryCache(hunter.getMemoryPolicy())) &#123;</div><div class="line">      cache.set(hunter.getKey(), hunter.getResult());</div><div class="line">    &#125;</div><div class="line">    hunterMap.remove(hunter.getKey());</div><div class="line">    batch(hunter);</div><div class="line">    <span class="keyword">if</span> (hunter.getPicasso().loggingEnabled) &#123;</div><div class="line">      log(OWNER_DISPATCHER, VERB_BATCHED, getLogIdsForHunter(hunter), <span class="string">"for completion"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据发送请求设置的内存缓存策略判断是否将其结果写入到内存中，并通过 key 从 hunterMap 移除 hunter，最后再对 hunter 作出处理，即 第 6 行代码，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">batch</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (hunter.isCancelled()) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    batch.add(hunter);</div><div class="line">    <span class="keyword">if</span> (!handler.hasMessages(HUNTER_DELAY_NEXT_BATCH)) &#123;</div><div class="line">      handler.sendEmptyMessageDelayed(HUNTER_DELAY_NEXT_BATCH, BATCH_DELAY);</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>看第 7 行代码，同时采用 Handler 消息机制发送消息，跟上面一样。最终会转到 Dispatcher 类 <strong>performBatchComplete()</strong> 方法，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">performBatchComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;BitmapHunter&gt; copy = <span class="keyword">new</span> ArrayList&lt;BitmapHunter&gt;(batch);</div><div class="line">    batch.clear();</div><div class="line">    mainThreadHandler.sendMessage(mainThreadHandler.obtainMessage(HUNTER_BATCH_COMPLETE, copy));</div><div class="line">    logBatch(copy);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>核心代码是第 4 行，同样才 Handler 消息机制发送消息，但是此时与之上有所不一样，即 mainThreadHandler 所在线程是主线程，也就是说，此时将任务从子线程切换到主线程，以便可以进行 UI 更新操作，那么赶快来看下在主线程是如何实现的？代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">        <span class="keyword">case</span> HUNTER_BATCH_COMPLETE: </div><div class="line">          <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) List&lt;BitmapHunter&gt; batch = (List&lt;BitmapHunter&gt;) msg.obj;</div><div class="line">          <span class="comment">//noinspection ForLoopReplaceableByForEach</span></div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = batch.size(); i &lt; n; i++) &#123;</div><div class="line">            BitmapHunter hunter = batch.get(i);</div><div class="line">            hunter.picasso.complete(hunter);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        </div><div class="line">         <span class="keyword">default</span>:</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unknown handler message received: "</span> + msg.what);        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据获取到 BitmapHunter 列表大小依次调用 Picasso 中 <strong>complete(BitmapHunter)</strong> 方法，那么又是怎样实现的呢，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">complete</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</div><div class="line">    Action single = hunter.getAction();</div><div class="line">    List&lt;Action&gt; joined = hunter.getActions();</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> hasMultiple = joined != <span class="keyword">null</span> &amp;&amp; !joined.isEmpty();</div><div class="line">    <span class="keyword">boolean</span> shouldDeliver = single != <span class="keyword">null</span> || hasMultiple;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!shouldDeliver) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Uri uri = hunter.getData().uri;</div><div class="line">    Exception exception = hunter.getException();</div><div class="line">    Bitmap result = hunter.getResult();</div><div class="line">    LoadedFrom from = hunter.getLoadedFrom();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (single != <span class="keyword">null</span>) &#123;</div><div class="line">      deliverAction(result, from, single);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasMultiple) &#123;</div><div class="line">      <span class="comment">//noinspection ForLoopReplaceableByForEach</span></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = joined.size(); i &lt; n; i++) &#123;</div><div class="line">        Action join = joined.get(i);</div><div class="line">        deliverAction(result, from, join);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (listener != <span class="keyword">null</span> &amp;&amp; exception != <span class="keyword">null</span>) &#123;</div><div class="line">      listener.onImageLoadFailed(<span class="keyword">this</span>, uri, exception);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从 hunter 获取单个 action、合并 actions 以及其它信息，比如 uri、exception 等。如果获取到的 action 不为空，则派发 action，即第 18 行代码，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deliverAction</span><span class="params">(Bitmap result, LoadedFrom from, Action action)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (action.isCancelled()) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!action.willReplay()) &#123;</div><div class="line">      targetToAction.remove(action.getTarget());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (from == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"LoadedFrom cannot be null."</span>);</div><div class="line">      &#125;</div><div class="line">      action.complete(result, from);</div><div class="line">      <span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">        log(OWNER_MAIN, VERB_COMPLETED, action.request.logId(), <span class="string">"from "</span> + from);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      action.error();</div><div class="line">      <span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">        log(OWNER_MAIN, VERB_ERRORED, action.request.logId());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从以上代码可以清晰地看出，根据 result 是否为空分别调用 Action 的回调方法，即 <strong>complete()</strong> 与 <strong>error()</strong>。先来看下 <strong>complete()</strong> 具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(Bitmap result, Picasso.LoadedFrom from)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(</div><div class="line">          String.format(<span class="string">"Attempted to complete action with no result!\n%s"</span>, <span class="keyword">this</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ImageView target = <span class="keyword">this</span>.target.get();</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Context context = picasso.context;</div><div class="line">    <span class="keyword">boolean</span> indicatorsEnabled = picasso.indicatorsEnabled;</div><div class="line">    PicassoDrawable.setBitmap(target, context, result, from, noFade, indicatorsEnabled);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</div><div class="line">      callback.onSuccess();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>逻辑很简单，前部分主要是做一些检查操作，真正核心代码是第 15 行代码，即将下载获取到的图片渲染到 UI 上，意味着成功地加载一张图片。那么 <strong>error()</strong> 方法又做了什么操作呢？具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">()</span> </span>&#123;</div><div class="line">    ImageView target = <span class="keyword">this</span>.target.get();</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (errorResId != <span class="number">0</span>) &#123;</div><div class="line">      target.setImageResource(errorResId);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (errorDrawable != <span class="keyword">null</span>) &#123;</div><div class="line">      target.setImageDrawable(errorDrawable);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</div><div class="line">      callback.onError();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>逻辑也很简单，如果我们有设置错误时显示图片的话，该方法就将错误时显示图片渲染出来。</p>
<p>那么这是单个 action 的处理逻辑，如果有合并 actions 的，执行的逻辑也一样，即对其进行遍历，获取单个 action，再派发 action，实现的代码在 <strong>complete(BitmapHunter)</strong> 方法第 21 - 27 行。</p>
<p>好吧， 使用 Picasso 开源框架成功加载一张图片的具体流程大概就这样了。由于自己能力水平有限，在讲解过程中难免有错误，如果您看到了，欢迎指正出来，大家一起学习，共同进步 ！！！</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://skykai521.github.io/2016/02/25/Picasso%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="external">http://skykai521.github.io/2016/02/25/Picasso%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="PANJU" />
          <p class="site-author-name" itemprop="name">PANJU</p>
           
              <p class="site-description motion-element" itemprop="description">笔记——记录工作和学习中的点点滴滴</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/PanZeYong" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PANJU</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://panzeyong.disqus.com/count.js" async></script>
    

    

  













  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("b3EUStGjBwcKOJcOMeQXheDT-gzGzoHsz", "xvVsWacpT435FHV1QCcUpx9I");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
