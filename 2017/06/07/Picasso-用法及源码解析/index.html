<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="优秀开源框架," />





  <link rel="alternate" href="/atom.xml" title="PANJU's Note" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="Picasso 是 Square 公司开源的一个 Android 平台优秀图片加载框架，易用、代码简洁、可读性高。自己接触的第一个开源图片加载框架也是 Picasso，以前只停留在会用阶段，根本不知道是如何实现的，最近花了点时间看了 Picasso 源码，学到的东西还是蛮多；大概理解实现基本流程。
对于看源码这事，一开始真不知从哪里下手。于是 Google 了，发现很多都是从使用方法入手，理清方法">
<meta property="og:type" content="article">
<meta property="og:title" content="Picasso 用法及源码解析">
<meta property="og:url" content="https://panzeyong.github.io/2017/06/07/Picasso-用法及源码解析/index.html">
<meta property="og:site_name" content="PANJU's Note">
<meta property="og:description" content="Picasso 是 Square 公司开源的一个 Android 平台优秀图片加载框架，易用、代码简洁、可读性高。自己接触的第一个开源图片加载框架也是 Picasso，以前只停留在会用阶段，根本不知道是如何实现的，最近花了点时间看了 Picasso 源码，学到的东西还是蛮多；大概理解实现基本流程。
对于看源码这事，一开始真不知从哪里下手。于是 Google 了，发现很多都是从使用方法入手，理清方法">
<meta property="og:image" content="https://panzeyong.github.io/images/picasso/downloader.png">
<meta property="og:image" content="https://panzeyong.github.io/images/picasso/cache.png">
<meta property="og:image" content="https://panzeyong.github.io/images/picasso/into.png">
<meta property="og:image" content="https://panzeyong.github.io/images/picasso/run.png">
<meta property="og:updated_time" content="2017-06-19T15:22:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Picasso 用法及源码解析">
<meta name="twitter:description" content="Picasso 是 Square 公司开源的一个 Android 平台优秀图片加载框架，易用、代码简洁、可读性高。自己接触的第一个开源图片加载框架也是 Picasso，以前只停留在会用阶段，根本不知道是如何实现的，最近花了点时间看了 Picasso 源码，学到的东西还是蛮多；大概理解实现基本流程。
对于看源码这事，一开始真不知从哪里下手。于是 Google 了，发现很多都是从使用方法入手，理清方法">
<meta name="twitter:image" content="https://panzeyong.github.io/images/picasso/downloader.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://panzeyong.github.io/2017/06/07/Picasso-用法及源码解析/"/>





  <title>Picasso 用法及源码解析 | PANJU's Note</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">PANJU's Note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">故不积跬步，无以至千里；不积小流，无以成江海。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://panzeyong.github.io/2017/06/07/Picasso-用法及源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="PANJU">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PANJU's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Picasso 用法及源码解析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-07T07:47:21+08:00">
                2017-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/07/Picasso-用法及源码解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/06/07/Picasso-用法及源码解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/06/07/Picasso-用法及源码解析/" class="leancloud_visitors" data-flag-title="Picasso 用法及源码解析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Picasso 是 Square 公司开源的一个 Android 平台优秀图片加载框架，易用、代码简洁、可读性高。自己接触的第一个开源图片加载框架也是 Picasso，以前只停留在会用阶段，根本不知道是如何实现的，最近花了点时间看了 Picasso 源码，学到的东西还是蛮多；大概理解实现基本流程。</p>
<p>对于看源码这事，一开始真不知从哪里下手。于是 Google 了，发现很多都是从使用方法入手，理清方法间是如何调用，最后形成自己的线索。本文也是按照这种方式来分析 Picasso 源码。</p>
<h3 id="Picasso-使用方法"><a href="#Picasso-使用方法" class="headerlink" title="Picasso 使用方法"></a>Picasso 使用方法</h3><ul>
<li>使用 Picasso 加载一张图片很简单，一行代码就搞定</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Picasso.whth(context)</div><div class="line">	.load(R.mipmap.ic_default)</div><div class="line">	.placeholder(R.mipmap.ic_default)</div><div class="line">	.error(R.mipmap.ic_default)</div><div class="line">	.into(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>加载一张图片并且按照指定尺寸以 <strong>centerCrop</strong> 形式对图片进行缩放</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">	.load(R.mipmap.ic_default)</div><div class="line">	.resize(<span class="number">200</span>, <span class="number">200</span>)</div><div class="line">	.centerCrop()</div><div class="line">	.into(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>加载一张图片并且按照指定尺寸以 <strong>centerInside</strong> 形式图片进行缩放（注：对图片进行处理时，<strong>centerCrop</strong> 或  <strong>centerInside</strong> 只能选择一种方式，并且必须调用方法 <strong>resize(targetWidth, targetHeight)</strong> 或者 <strong>resizeDimen(targetWidthResId, targetHeightResId)</strong>  设置大小）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">	.load(R.mipmap.ic_default)</div><div class="line">	.resizeDimen(R.dimen.width, R.dimen.height)</div><div class="line">	.centerInside()</div><div class="line">	.into(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>加载一张图片并且按照一定角度对其进行旋转</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">	.load(R.mipmap.ic_launcher)</div><div class="line">	.rotate(<span class="number">20</span>)</div><div class="line">	.into(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>加载一张图片自适应目标视图（由于调整大小适应目标视图，结果导致请求被延迟，直到调整完毕才会发送请求；目标视图只能是 ImageView）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">	.load(R.mipmap.ic_launcher)</div><div class="line">	.fit()</div><div class="line">	.into(imageView);</div></pre></td></tr></table></figure>
<ul>
<li>加载一张图片并设置回调接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Picasso.with(<span class="keyword">this</span>)</div><div class="line">	.load(R.mipmap.ic_launcher)</div><div class="line">	.into(mImageView, <span class="keyword">new</span> Callback() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;&#125;);</div></pre></td></tr></table></figure>
<p>以上只是 Picasso 简单的用法，至于其它用法看API；接下来分析下源码。</p>
<h3 id="Picasso-源码解析"><a href="#Picasso-源码解析" class="headerlink" title="Picasso 源码解析"></a>Picasso 源码解析</h3><h4 id="Picasso-with-方法解析"><a href="#Picasso-with-方法解析" class="headerlink" title="Picasso.with() 方法解析"></a>Picasso.with() 方法解析</h4><p>为了探究 Picasso.with() 方法如何实现，唯独从源代码找答案。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * The global default &#123;<span class="doctag">@link</span> Picasso&#125; instance.</div><div class="line">    * &lt;p&gt;</div><div class="line">    * This instance is automatically initialized with defaults that are suitable to most</div><div class="line">    * implementations.</div><div class="line">    * &lt;ul&gt;</div><div class="line">    * &lt;li&gt;LRU memory cache of 15% the available application RAM&lt;/li&gt;</div><div class="line">    * &lt;li&gt;Disk cache of 2% storage space up to 50MB but no less than 5MB. (Note: this is only</div><div class="line">    * available on API 14+ &lt;em&gt;or&lt;/em&gt; if you are using a standalone library that provides a disk</div><div class="line">    * cache on all API levels like OkHttp)&lt;/li&gt;</div><div class="line">    * &lt;li&gt;Three download threads for disk and network access.&lt;/li&gt;</div><div class="line">    * &lt;/ul&gt;</div><div class="line">    * &lt;p&gt;</div><div class="line">    * If these settings do not meet the requirements of your application you can construct your own</div><div class="line">    * with full control over the configuration by using &#123;<span class="doctag">@link</span> Picasso.Builder&#125; to create a</div><div class="line">    * &#123;<span class="doctag">@link</span> Picasso&#125; instance. You can either use this directly or by setting it as the global</div><div class="line">    * instance with &#123;<span class="doctag">@link</span> #setSingletonInstance&#125;.</div><div class="line">    */</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Picasso <span class="title">with</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line"> </div><div class="line">     <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">synchronized</span> (Picasso.class) &#123;</div><div class="line">             <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</div><div class="line">                 singleton = <span class="keyword">new</span> Builder(context).build();</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     </div><div class="line">     <span class="keyword">return</span> singleton;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从注释中可以得到以下几点：</p>
<ul>
<li><p>全局默认实例，也就是说只有一个实例存在，从使用单例模式可以看出。</p>
</li>
<li><p>Picasso 采用两级缓存：内存缓存和磁盘缓存。</p>
</li>
<li><p>LRU 内存缓存大小占整个应用可用 RAM 容量的 15%。</p>
</li>
<li><p>磁盘缓存大小占存储空间的 2%，不少于 5 MB，不超过 50 MB。（注：仅适于 API 14+ 或者所使用的第三方库包含 API，比如 OkHttp）。</p>
</li>
<li><p>为磁盘访问和网络访问提供 <strong>3</strong> 个线程。</p>
</li>
<li><p>这些配置是 Picasso 默认配置的，如果不满足自己的需求，可以自己定制。通过 Picasso.Builder 创建 Picasson 实例，根据自己需要配置相关属性，并调用方法 setSingletonInstance(picasso) 设置为全局实例。</p>
</li>
</ul>
<p>很明显可以看到，使用单例模式来创建 Picasso 实例，保证全局只有一个实例存在。简单说下 with() 方法的实现，singleton 为 null 时调用 Builder 类中 build() 方法创建 singleton 实例并返回，那么接下来就来看 Builder 类中 build() 方法是如何实现的？</p>
<h5 id="Picasso-Builder-中-build-方法解析"><a href="#Picasso-Builder-中-build-方法解析" class="headerlink" title="Picasso.Builder 中 build() 方法解析"></a>Picasso.Builder 中 build() 方法解析</h5><p>源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Picasso <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">	Context context = <span class="keyword">this</span>.context;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (downloader == <span class="keyword">null</span>) &#123;</div><div class="line">		downloader = Utils.createDefaultDownloader(context);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</div><div class="line">		cache = <span class="keyword">new</span> LruCache(context);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</div><div class="line">		service = <span class="keyword">new</span> PicassoExecutorService();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (transformer == <span class="keyword">null</span>) &#123;</div><div class="line">		transformer = RequestTransformer.IDENTITY;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	Stats stats = <span class="keyword">new</span> Stats(cache);</div><div class="line">	</div><div class="line">	Dispatcher dispatcher = <span class="keyword">new</span> Dispatcher(context, service, HANDLER, downloader, cache, stats);</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Picasso(context, dispatcher, cache, listener, transformer, requestHandlers, stats,          defaultBitmapConfig, indicatorsEnabled, loggingEnabled);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Builder 类是 Picasso 这个类中的静态内部类，而 build() 方法是 Builder 类中的成员方法，可以看出采用<strong>建造者模式</strong>。那么 build() 方法实现的功能主要有：</p>
<ul>
<li><p>创建默认下载器 Downloader</p>
</li>
<li><p>创建默认内存缓存 LruCache （由于接口 Cache 支持多线程访问，所以实现该接口时需确保线程安全）</p>
</li>
<li><p>创建默认线程池 PicassoExecutorService </p>
</li>
<li><p>创建默认请求转发器 RequestTransformer</p>
</li>
<li><p>创建默认统计 Stats</p>
</li>
<li><p>创建默认调度器 Dispatcher</p>
</li>
<li><p>创建 Picasso 实例</p>
</li>
</ul>
<p>那么这些实例是如何创建的，下面主要通过流程图来解析（主要是方法间的调用以及方法内部部分细节）。</p>
<ul>
<li>Downloader 是一个接口，无法实例化，需要通过实现类创建实例，该接口的功能主要从磁盘缓存加载图片或网络下载图片。OkHttpDownloader 和 UrlConnectionDownloader 分别实现该接口，那么创建实例也是通过这两个实现类来创建的，那么来看下实例化 Downloader 流程。</li>
</ul>
<p><img src="/images/picasso/downloader.png" alt=""></p>
<ul>
<li>LruCache 是内存缓存类，实现接口 Cache，采用最近最少使用算法。</li>
</ul>
<p><img src="/images/picasso/cache.png" alt=""></p>
<ul>
<li><p>PicassoExecutorService 继承 ThreadPoolExecutor，是线程池，供图片下载，线程数根据不同网络类型设置，默认的线程数是 3 个，直接通过 new 操作符实例化对象。</p>
</li>
<li><p>RequestTransformer 是一个接口，功能是在发送请求之前对图片进行转换处理。从源码中可以看出，这是一个测试功能，在后续版本可能不兼容，使用该功能时得谨慎。</p>
</li>
<li><p>对于 Stats 实例的创建，直接 new 一个对象，那么主要来看该构造方法做了哪些操作？代码如下：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Stats(Cache cache) &#123;</div><div class="line">    <span class="keyword">this</span>.cache = cache;</div><div class="line">    <span class="keyword">this</span>.statsThread = <span class="keyword">new</span> HandlerThread(STATS_THREAD_NAME, THREAD_PRIORITY_BACKGROUND);</div><div class="line">    <span class="keyword">this</span>.statsThread.start();</div><div class="line">    Utils.flushStackLocalLeaks(statsThread.getLooper());</div><div class="line">    <span class="keyword">this</span>.handler = <span class="keyword">new</span> StatsHandler(statsThread.getLooper(), <span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要是实例化对象，结合注释应该不难理解。</p>
<p>Dispatcher 实例的创建与 Stats 类似，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Dispatcher(Context context, ExecutorService service, Handler mainThreadHandler,      Downloader downloader, Cache cache, Stats stats) &#123;</div><div class="line">      </div><div class="line">      <span class="comment">// dispatcherThread 是子线程，注意记得调用 start() 方法  </span></div><div class="line">      <span class="keyword">this</span>.dispatcherThread = <span class="keyword">new</span> DispatcherThread();</div><div class="line">      <span class="keyword">this</span>.dispatcherThread.start();</div><div class="line">      Utils.flushStackLocalLeaks(dispatcherThread.getLooper());</div><div class="line">      <span class="keyword">this</span>.context = context;</div><div class="line">      <span class="keyword">this</span>.service = service;</div><div class="line">      <span class="keyword">this</span>.hunterMap = <span class="keyword">new</span> LinkedHashMap&lt;String, BitmapHunter&gt;();</div><div class="line">      <span class="keyword">this</span>.failedActions = <span class="keyword">new</span> WeakHashMap&lt;Object, Action&gt;();</div><div class="line">      <span class="keyword">this</span>.pausedActions = <span class="keyword">new</span> WeakHashMap&lt;Object, Action&gt;();</div><div class="line">      <span class="keyword">this</span>.pausedTags = <span class="keyword">new</span> HashSet&lt;Object&gt;();</div><div class="line">      <span class="comment">// 注意该 handler 是在子线程的</span></div><div class="line">      <span class="keyword">this</span>.handler = <span class="keyword">new</span> DispatcherHandler(dispatcherThread.getLooper(), <span class="keyword">this</span>);</div><div class="line">      <span class="keyword">this</span>.downloader = downloader;</div><div class="line">      <span class="comment">// 在主线程</span></div><div class="line">      <span class="keyword">this</span>.mainThreadHandler = mainThreadHandler;</div><div class="line">      <span class="keyword">this</span>.cache = cache;</div><div class="line">      <span class="keyword">this</span>.stats = stats;</div><div class="line">      <span class="keyword">this</span>.batch = <span class="keyword">new</span> ArrayList&lt;BitmapHunter&gt;(<span class="number">4</span>);</div><div class="line">      <span class="keyword">this</span>.airplaneMode = Utils.isAirplaneModeOn(<span class="keyword">this</span>.context);</div><div class="line">      <span class="keyword">this</span>.scansNetworkChanges = hasPermission(context, Manifest.permission.ACCESS_NETWORK_STATE);</div><div class="line">      <span class="keyword">this</span>.receiver = <span class="keyword">new</span> NetworkBroadcastReceiver(<span class="keyword">this</span>);</div><div class="line">      receiver.register();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，也是最重要的一点，那就是 Picasso 实例的创建，先看下代码吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">Picasso(Context context, Dispatcher dispatcher, Cache cache, Listener listener,      RequestTransformer requestTransformer, List&lt;RequestHandler&gt; extraRequestHandlers, Stats stats,      Bitmap.Config defaultBitmapConfig, <span class="keyword">boolean</span> indicatorsEnabled, <span class="keyword">boolean</span> loggingEnabled) &#123;</div><div class="line">      </div><div class="line">      </div><div class="line">    <span class="keyword">this</span>.context = context;</div><div class="line">    <span class="keyword">this</span>.dispatcher = dispatcher;</div><div class="line">    <span class="keyword">this</span>.cache = cache;</div><div class="line">    <span class="keyword">this</span>.listener = listener;</div><div class="line">    <span class="keyword">this</span>.requestTransformer = requestTransformer;</div><div class="line">    <span class="keyword">this</span>.defaultBitmapConfig = defaultBitmapConfig;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> builtInHandlers = <span class="number">7</span>; <span class="comment">// Adjust this as internal handlers are added or removed.</span></div><div class="line">    <span class="keyword">int</span> extraCount = (extraRequestHandlers != <span class="keyword">null</span> ? extraRequestHandlers.size() : <span class="number">0</span>);</div><div class="line">    List&lt;RequestHandler&gt; allRequestHandlers =        <span class="keyword">new</span> ArrayList&lt;RequestHandler&gt;(builtInHandlers + extraCount);</div><div class="line">        </div><div class="line">    <span class="comment">// ResourceRequestHandler needs to be the first in the list to avoid</span></div><div class="line">    <span class="comment">// forcing other RequestHandlers to perform null checks on request.uri</span></div><div class="line">    <span class="comment">// to cover the (request.resourceId != 0) case.</span></div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> ResourceRequestHandler(context));</div><div class="line">    <span class="keyword">if</span> (extraRequestHandlers != <span class="keyword">null</span>) &#123;</div><div class="line">    	allRequestHandlers.addAll(extraRequestHandlers);</div><div class="line">    &#125;</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> ContactsPhotoRequestHandler(context));</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> MediaStoreRequestHandler(context));</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> ContentStreamRequestHandler(context));</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> AssetRequestHandler(context));</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> FileRequestHandler(context));</div><div class="line">    allRequestHandlers.add(<span class="keyword">new</span> NetworkRequestHandler(dispatcher.downloader, stats));</div><div class="line">    requestHandlers = Collections.unmodifiableList(allRequestHandlers);</div><div class="line">    </div><div class="line">    <span class="keyword">this</span>.stats = stats;</div><div class="line">    <span class="keyword">this</span>.targetToAction = <span class="keyword">new</span> WeakHashMap&lt;Object, Action&gt;();</div><div class="line">    <span class="keyword">this</span>.targetToDeferredRequestCreator = <span class="keyword">new</span> WeakHashMap&lt;ImageView, DeferredRequestCreator&gt;();</div><div class="line">    <span class="keyword">this</span>.indicatorsEnabled = indicatorsEnabled;</div><div class="line">    <span class="keyword">this</span>.loggingEnabled = loggingEnabled;</div><div class="line">    <span class="keyword">this</span>.referenceQueue = <span class="keyword">new</span> ReferenceQueue&lt;Object&gt;();</div><div class="line">    <span class="keyword">this</span>.cleanupThread = <span class="keyword">new</span> CleanupThread(referenceQueue, HANDLER);</div><div class="line">    <span class="keyword">this</span>.cleanupThread.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除了对一些对象赋值外，重要的一点就是创建和添加 RequestHandler，代码主要在 19 ~ 29 行，比如文件、网络、资源等处理器。至此，Picasso 实例也就创建完毕了，那么接下来看 load() 方法是如何实现的。</p>
<h4 id="Picasso-load-方法解析"><a href="#Picasso-load-方法解析" class="headerlink" title="Picasso.load() 方法解析"></a>Picasso.load() 方法解析</h4><p>load() 有多个重载方法，可以传入 resourceId、string、file、uri，但是最后都是返回 RequestCreator 实例，接下来就来看该方法如何实现？代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> RequestCreator <span class="title">load</span><span class="params">(<span class="keyword">int</span> resourceId)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (resourceId == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Resource ID must not be zero."</span>);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestCreator(<span class="keyword">this</span>, <span class="keyword">null</span>, resourceId);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很明显地看出，调用 load() 方法后返回的是 RequestCreator 实例，那么来看下 RequestCreator 构造方法是咋样的，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">RequestCreator(Picasso picasso, Uri uri, <span class="keyword">int</span> resourceId) &#123;</div><div class="line">    <span class="keyword">if</span> (picasso.shutdown) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Picasso instance already shut down. Cannot submit new requests."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.picasso = picasso;</div><div class="line">    <span class="keyword">this</span>.data = <span class="keyword">new</span> Request.Builder(uri, resourceId, picasso.defaultBitmapConfig);&#125;</div></pre></td></tr></table></figure>
<p>创建 Request.Builder 对象，并将需要加载图片信息封装到该对象里，采用建造者模式。对于一些操作比如 rotate、centerCrop、centerInside、resize 等，其实只是修改其状态，真正执行操作是方法 into，该方法是核心方法，以下重点分析。</p>
<h4 id="into-方法解析"><a href="#into-方法解析" class="headerlink" title="into() 方法解析"></a>into() 方法解析</h4><p>into() 有 5 个重载方法，每个方法实现的主要功能基本相同，但是稍微还是有点不一样的。以常用 <strong>into(ImageView target)</strong> 这个方法为例子来讲解下内部是如何实现的？由于个人比较喜欢画流程图来理清方法之间调用关系，于是就有下面的流程图：</p>
<p><img src="/images/picasso/into.png" alt=""></p>
<p>结合流程图再来看源码应该会比较好理解，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">into</span><span class="params">(ImageView target)</span> </span>&#123;</div><div class="line">    into(target, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法所持有的 ImageView 实例是一个弱引用，内存不足情况下可以自动被垃圾回收器回收。很明显，该方法调用重载方法 <strong>into(target, null)</strong>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">into</span><span class="params">(ImageView target, Callback callback)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> started = System.nanoTime();</div><div class="line">    checkMain();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Target must not be null."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!data.hasImage()) &#123;</div><div class="line">      picasso.cancelRequest(target);</div><div class="line">      <span class="keyword">if</span> (setPlaceholder) &#123;</div><div class="line">        setPlaceholder(target, getPlaceholderDrawable());</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (deferred) &#123;</div><div class="line">      <span class="keyword">if</span> (data.hasSize()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fit cannot be used with resize."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">int</span> width = target.getWidth();</div><div class="line">      <span class="keyword">int</span> height = target.getHeight();</div><div class="line">      <span class="keyword">if</span> (width == <span class="number">0</span> || height == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (setPlaceholder) &#123;</div><div class="line">          setPlaceholder(target, getPlaceholderDrawable());</div><div class="line">        &#125;</div><div class="line">        picasso.defer(target, <span class="keyword">new</span> DeferredRequestCreator(<span class="keyword">this</span>, target, callback));</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      data.resize(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Request request = createRequest(started);</div><div class="line">    String requestKey = createKey(request);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (shouldReadFromMemoryCache(memoryPolicy)) &#123;</div><div class="line">      Bitmap bitmap = picasso.quickMemoryCacheCheck(requestKey);</div><div class="line">      <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">        picasso.cancelRequest(target);</div><div class="line">        setBitmap(target, picasso.context, bitmap, MEMORY, noFade, picasso.indicatorsEnabled);</div><div class="line">        <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">          log(OWNER_MAIN, VERB_COMPLETED, request.plainId(), <span class="string">"from "</span> + MEMORY);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</div><div class="line">          callback.onSuccess();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (setPlaceholder) &#123;</div><div class="line">      setPlaceholder(target, getPlaceholderDrawable());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Action action =</div><div class="line">        <span class="keyword">new</span> ImageViewAction(picasso, target, request, memoryPolicy, networkPolicy, errorResId,</div><div class="line">            errorDrawable, requestKey, tag, callback, noFade);</div><div class="line"></div><div class="line">    picasso.enqueueAndSubmit(action);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参数 Callback 是一个强引用，将会阻止 Activity 或者 Fragment 被回收，从而导致内存泄漏。如果使用该方法，在释放资源时最好调用 Picasso 类 <strong>cancelRequest(android.widget.ImageView)</strong> 方法取消请求，以免造成内存泄漏。从源码可以清晰地看出该方法实现的主要功能：</p>
<ul>
<li><p>检查当前线程是否为主线程；如果是主线程，则继续执行；否则抛出异常。</p>
</li>
<li><p>判断目标组件 ImageView 是否为 null；如果不为 null，则继续执行；否则抛出异常。</p>
</li>
<li><p>检查发送请求是否包含要加载图片 uri 或 resourceId；如果没有，则调用Picasso 类 <strong>cancelRequest(android.widget.ImageView)</strong> 方法取消请求（后面讲解该方法），并检查是否设置默认图片；否则继续执行。</p>
</li>
<li><p>检查是否调用方法 fit()，即 deferred 是否为 true，true 表示调用，false 表示调用 unfit() 方法；调用该方法意味着延迟加载图片，并且不能与方法 resize() 同时使用。</p>
</li>
<li><p>为加载图片创建请求。</p>
</li>
<li><p>为每个请求创建 key，主要是为了方便存储。</p>
</li>
<li><p>根据缓存策略判断是否从内存缓存读取。</p>
</li>
<li><p>是否设置默认图片。</p>
</li>
<li><p>创建对应的 Action 实例，在这里是 ImageViewAction。</p>
</li>
<li><p>入队和提交 action。</p>
</li>
</ul>
<p>以上是总体概括，接下来逐一看具体实现。</p>
<p>那么先来看下 <strong>cancelRequest(android.widget.ImageView)</strong> 具体实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelRequest</span><span class="params">(ImageView view)</span> </span>&#123;</div><div class="line">    cancelExistingRequest(view);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>只有一行代码，调用 <strong>cancelExistingRequest(view)</strong> 方法，看下具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelExistingRequest</span><span class="params">(Object target)</span> </span>&#123;</div><div class="line">    checkMain();</div><div class="line">    Action action = targetToAction.remove(target);</div><div class="line">    <span class="keyword">if</span> (action != <span class="keyword">null</span>) &#123;</div><div class="line">      action.cancel();</div><div class="line">      dispatcher.dispatchCancel(action);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (target <span class="keyword">instanceof</span> ImageView) &#123;</div><div class="line">      ImageView targetImageView = (ImageView) target;</div><div class="line">      DeferredRequestCreator deferredRequestCreator =</div><div class="line">          targetToDeferredRequestCreator.remove(targetImageView);</div><div class="line">      <span class="keyword">if</span> (deferredRequestCreator != <span class="keyword">null</span>) &#123;</div><div class="line">        deferredRequestCreator.cancel();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>按照惯例，先列出该方法实现的主要功能：</p>
<ul>
<li><p>检查当前线程是否为主线程；如果是主线程，则继续执行；否则抛出异常。</p>
</li>
<li><p>通过 key 从 targetToAction 移除对应 action。</p>
</li>
<li><p>如果 action 不为 null，执行一些取消操作，相当于释放资源。</p>
</li>
<li><p>如果目标组件是 ImageView，则检查是否调用 fit() 方法，是的话就执行一些取消操作。</p>
</li>
</ul>
<p>接着来看下取消操作方法 <strong>dispatcher.dispatchCancel(action)</strong> 具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchCancel</span><span class="params">(Action action)</span> </span>&#123;</div><div class="line">    handler.sendMessage(handler.obtainMessage(REQUEST_CANCEL, action));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很明显是通过 Handler 消息机制来处理的。即 Dispatcher 类中 DispatcherHandler 发送消息 <strong>REQUEST_CANCEL</strong>，并在其回调方法 <strong>handleMessage(final Message msg)</strong> 实现具体逻辑，注意是在子线程执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</div><div class="line">	<span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">		<span class="keyword">case</span> REQUEST_CANCEL: &#123;</div><div class="line">			Action action = (Action) msg.obj;</div><div class="line">			dispatcher.performCancel(action);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			Picasso.HANDLER.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">				<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unknown handler message received: "</span> + msg.what);</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着来看下 <strong>dispatcher.performCancel(action)</strong> 具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">performCancel</span><span class="params">(Action action)</span> </span>&#123;</div><div class="line">    String key = action.getKey();</div><div class="line">    BitmapHunter hunter = hunterMap.get(key);</div><div class="line">    <span class="keyword">if</span> (hunter != <span class="keyword">null</span>) &#123;</div><div class="line">      hunter.detach(action);</div><div class="line">      <span class="keyword">if</span> (hunter.cancel()) &#123;</div><div class="line">        hunterMap.remove(key);</div><div class="line">        <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</div><div class="line">          log(OWNER_DISPATCHER, VERB_CANCELED, action.getRequest().logId());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pausedTags.contains(action.getTag())) &#123;</div><div class="line">      pausedActions.remove(action.getTarget());</div><div class="line">      <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</div><div class="line">        log(OWNER_DISPATCHER, VERB_CANCELED, action.getRequest().logId(),</div><div class="line">            <span class="string">"because paused request got canceled"</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Action remove = failedActions.remove(action.getTarget());</div><div class="line">    <span class="keyword">if</span> (remove != <span class="keyword">null</span> &amp;&amp; remove.getPicasso().loggingEnabled) &#123;</div><div class="line">      log(OWNER_DISPATCHER, VERB_CANCELED, remove.getRequest().logId(), <span class="string">"from replaying"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从以上代码很清晰地看出该方法主要做一些取消、移除操作，即释放资源。以上就是 <strong>cancelExistingRequest(view)</strong> 内部实现解析。</p>
<p>回到 <strong>into(target, null)</strong> 内部实现，看下创建请求 <strong>createRequest(started)</strong> 具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">createRequest</span><span class="params">(<span class="keyword">long</span> started)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> id = nextId.getAndIncrement();</div><div class="line"></div><div class="line">    Request request = data.build();</div><div class="line">    request.id = id;</div><div class="line">    request.started = started;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> loggingEnabled = picasso.loggingEnabled;</div><div class="line">    <span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">      log(OWNER_MAIN, VERB_CREATED, request.plainId(), request.toString());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Request transformed = picasso.transformRequest(request);</div><div class="line">    <span class="keyword">if</span> (transformed != request) &#123;</div><div class="line">      <span class="comment">// If the request was changed, copy over the id and timestamp from the original.</span></div><div class="line">      transformed.id = id;</div><div class="line">      transformed.started = started;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">        log(OWNER_MAIN, VERB_CHANGED, transformed.logId(), <span class="string">"into "</span> + transformed);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> transformed;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实实现逻辑很简单，对要加载图片的具体信息封装成 Request；通过 Request 创建对应 key，那么来看下是如何创建的，即 <strong>createKey(request)</strong> 方法具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">createKey</span><span class="params">(Request data)</span> </span>&#123;</div><div class="line">	String result = createKey(data, MAIN_THREAD_KEY_BUILDER);</div><div class="line">    MAIN_THREAD_KEY_BUILDER.setLength(<span class="number">0</span>);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>逻辑很简单，调用方法 <strong>createKey(data, MAIN_THREAD_KEY_BUILDER)</strong>，看下具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">createKey</span><span class="params">(Request data, StringBuilder builder)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (data.stableKey != <span class="keyword">null</span>) &#123;</div><div class="line">      builder.ensureCapacity(data.stableKey.length() + KEY_PADDING);</div><div class="line">      builder.append(data.stableKey);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.uri != <span class="keyword">null</span>) &#123;</div><div class="line">      String path = data.uri.toString();</div><div class="line">      builder.ensureCapacity(path.length() + KEY_PADDING);</div><div class="line">      builder.append(path);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      builder.ensureCapacity(KEY_PADDING);</div><div class="line">      builder.append(data.resourceId);</div><div class="line">    &#125;</div><div class="line">    builder.append(KEY_SEPARATOR);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.rotationDegrees != <span class="number">0</span>) &#123;</div><div class="line">      builder.append(<span class="string">"rotation:"</span>).append(data.rotationDegrees);</div><div class="line">      <span class="keyword">if</span> (data.hasRotationPivot) &#123;</div><div class="line">        builder.append(<span class="string">'@'</span>).append(data.rotationPivotX).append(<span class="string">'x'</span>).append(data.rotationPivotY);</div><div class="line">      &#125;</div><div class="line">      builder.append(KEY_SEPARATOR);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (data.hasSize()) &#123;</div><div class="line">      builder.append(<span class="string">"resize:"</span>).append(data.targetWidth).append(<span class="string">'x'</span>).append(data.targetHeight);</div><div class="line">      builder.append(KEY_SEPARATOR);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (data.centerCrop) &#123;</div><div class="line">      builder.append(<span class="string">"centerCrop"</span>).append(KEY_SEPARATOR);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.centerInside) &#123;</div><div class="line">      builder.append(<span class="string">"centerInside"</span>).append(KEY_SEPARATOR);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (data.transformations != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">//noinspection ForLoopReplaceableByForEach</span></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = data.transformations.size(); i &lt; count; i++) &#123;</div><div class="line">        builder.append(data.transformations.get(i).key());</div><div class="line">        builder.append(KEY_SEPARATOR);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> builder.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很简单，根据 Request 设置的属性拼接为字符串，作为最终的 key 并返回。</p>
<p>当我们调用不同 <strong>into()</strong> 方法时，Picasso 就会实例化不同的 Action，而这里我们是以 <strong>into(ImageView)</strong> 为例子，因此会实例化 ImageViewAction，在 ImageView 有回调方法，供我们使用，后续会看到。一切都准备就绪，那么就可以入队和提交 action。那么是如何实现的呢？来看下具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueueAndSubmit</span><span class="params">(Action action)</span> </span>&#123;</div><div class="line">	Object target = action.getTarget();</div><div class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span> &amp;&amp; targetToAction.get(target) != action) &#123;</div><div class="line">      <span class="comment">// This will also check we are on the main thread.</span></div><div class="line">      cancelExistingRequest(target);</div><div class="line">      targetToAction.put(target, action);</div><div class="line">    &#125;</div><div class="line">    submit(action);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 key 从 targetToAction 获取 action，不存在的话就执行检查操作并将 action 插入到 targetToAction，最后调用 <strong>submit(action)</strong>，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(Action action)</span> </span>&#123;</div><div class="line">    dispatcher.dispatchSubmit(action);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后还是回到 Dispatcher，通过 DispatcherHandler 消息机制发送消息 <strong>REQUEST_SUBMIT</strong>，并在其回调方法 并在其回调方法 <strong>handleMessage(final Message msg)</strong> 实现具体逻辑，注意是在子线程执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">        <span class="keyword">case</span> REQUEST_SUBMIT: &#123;</div><div class="line">          Action action = (Action) msg.obj;</div><div class="line">          dispatcher.performSubmit(action);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            Picasso.HANDLER.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unknown handler message received: "</span> + msg.what);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着来看下 <strong>dispatcher.performSubmit(action)</strong> 具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">performSubmit</span><span class="params">(Action action)</span> </span>&#123;</div><div class="line">    performSubmit(action, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>只有一行代码，调用方法 <strong>performSubmit(action, true)</strong>，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">performSubmit</span><span class="params">(Action action, <span class="keyword">boolean</span> dismissFailed)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (pausedTags.contains(action.getTag())) &#123;</div><div class="line">      pausedActions.put(action.getTarget(), action);</div><div class="line">      <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</div><div class="line">        log(OWNER_DISPATCHER, VERB_PAUSED, action.request.logId(),</div><div class="line">            <span class="string">"because tag '"</span> + action.getTag() + <span class="string">"' is paused"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    BitmapHunter hunter = hunterMap.get(action.getKey());</div><div class="line">    <span class="keyword">if</span> (hunter != <span class="keyword">null</span>) &#123;</div><div class="line">      hunter.attach(action);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (service.isShutdown()) &#123;</div><div class="line">      <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</div><div class="line">        log(OWNER_DISPATCHER, VERB_IGNORED, action.request.logId(), <span class="string">"because shut down"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    hunter = forRequest(action.getPicasso(), <span class="keyword">this</span>, cache, stats, action);</div><div class="line">    hunter.future = service.submit(hunter);</div><div class="line">    hunterMap.put(action.getKey(), hunter);</div><div class="line">    <span class="keyword">if</span> (dismissFailed) &#123;</div><div class="line">      failedActions.remove(action.getTarget());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</div><div class="line">      log(OWNER_DISPATCHER, VERB_ENQUEUED, action.request.logId());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简要概括下该方法实现的主要功能：</p>
<ul>
<li><p>检查标记 tag 请求是否被取消，如果被取消，则将对应 action 插入到 pausedActions 并退出程序；否则继续执行。</p>
</li>
<li><p>通过 key 从 hunterMap 获取相应 BitmapHunter 并判断其是否为 null，如果不为 null，则调用其方法 <strong>attach(Action)</strong> 并结束退出程序；否则继续执行。简要说明下，BitmapHunter 实现接口 Runnable，意味着开启线程在后台执行任务。</p>
</li>
<li><p>检查线程池是否停止工作。</p>
</li>
<li><p>创建 BitmapHunter 实例，即调用方法 <strong>forRequest(action.getPicasso(), this, cache, stats, action)</strong></p>
</li>
<li><p>将 hunter 提交到线程池并执行，即调用 <strong>service.submit(hunter)</strong></p>
</li>
</ul>
<p>看下 <strong>forRequest()</strong> 方法具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> BitmapHunter <span class="title">forRequest</span><span class="params">(Picasso picasso, Dispatcher dispatcher, Cache cache, Stats stats,</span></span></div><div class="line">      Action action) &#123;</div><div class="line">    Request request = action.getRequest();</div><div class="line">    List&lt;RequestHandler&gt; requestHandlers = picasso.getRequestHandlers();</div><div class="line"></div><div class="line">    <span class="comment">// Index-based loop to avoid allocating an iterator.</span></div><div class="line">    <span class="comment">//noinspection ForLoopReplaceableByForEach</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = requestHandlers.size(); i &lt; count; i++) &#123;</div><div class="line">      RequestHandler requestHandler = requestHandlers.get(i);</div><div class="line">      <span class="keyword">if</span> (requestHandler.canHandleRequest(request)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BitmapHunter(picasso, dispatcher, cache, stats, action, requestHandler);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BitmapHunter(picasso, dispatcher, cache, stats, action, ERRORING_HANDLER);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过调用 RequestHandler 中 <strong>canHandleRequest(Request)</strong> 方法逐一检查对应 RequestHandler，并创建 BitmapHunter 对象返回。然后将 hunter 提交到线程池并执行。<strong>submit(Runnable)</strong> 是接口 ExecutorService 里的方法，PicassoExecutorService 实现接口 ExecutorService，因此 <strong>submit(Runnable)</strong> 方法的实现逻辑在 PicassoExecutorService 类里面，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</div><div class="line">    PicassoFutureTask ftask = <span class="keyword">new</span> PicassoFutureTask((BitmapHunter) task);</div><div class="line">    execute(ftask);</div><div class="line">    <span class="keyword">return</span> ftask;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>execute(ftask)</strong> 执行任务，由于 BitmapHunter 实现接口 Runnable，意味着开启线程在后台执行任务；而在该方法里会调用线程 <strong>start()</strong> 方法，意味着 BtimapHunter 中 <strong>run()</strong> 会被调用，真正执行任务逻辑在该方法里面实现，接下来的重点肯定是来研究该方法内部实现逻辑，在研究源代码之前，先来看该方法内部实现流程图：</p>
<p><img src="/images/picasso/run.png" alt=""></p>
<p>同样结合流程图来解析 <strong>run()</strong> 内部实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		updateThreadName(data);</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">			log(OWNER_HUNTER, VERB_EXECUTING, getLogIdsForHunter(<span class="keyword">this</span>));</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		result = hunt();</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">			dispatcher.dispatchFailed(<span class="keyword">this</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			dispatcher.dispatchComplete(<span class="keyword">this</span>);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">catch</span> (Downloader.ResponseException e) &#123;</div><div class="line">		<span class="keyword">if</span> (!e.localCacheOnly || e.responseCode != <span class="number">504</span>) &#123;</div><div class="line">        	exception = e;</div><div class="line">       	&#125;</div><div class="line">       	dispatcher.dispatchFailed(<span class="keyword">this</span>);</div><div class="line">       	&#125; <span class="keyword">catch</span> (NetworkRequestHandler.ContentLengthException e) &#123;</div><div class="line">       		exception = e;</div><div class="line">      		dispatcher.dispatchRetry(<span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      		exception = e;</div><div class="line">      		dispatcher.dispatchRetry(<span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</div><div class="line">      		StringWriter writer = <span class="keyword">new</span> StringWriter();</div><div class="line">      		stats.createSnapshot().dump(<span class="keyword">new</span> PrintWriter(writer));</div><div class="line">      		exception = <span class="keyword">new</span> RuntimeException(writer.toString(), e);</div><div class="line">      		dispatcher.dispatchFailed(<span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      		exception = e;</div><div class="line">      		dispatcher.dispatchFailed(<span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      		Thread.currentThread().setName(Utils.THREAD_IDLE_NAME);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简要概括下该方法实现的主要功能：</p>
<ul>
<li><p>更新线程名字。</p>
</li>
<li><p>返回 Bitmap 对象并赋值给 result。</p>
</li>
<li><p>判断返回结果 result 是否为 null，如果为 null，则调用 <strong>dispatcher.dispatchFailed(this)</strong>；否则调用 <strong>dispatcher.dispatchComplete(this)</strong></p>
</li>
<li><p>各种异常处理。</p>
</li>
</ul>
<p>从源代码可以看出，核心的逻辑在方法 <strong>hunt()</strong>，那么它的内部实现又是怎么呢？具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function">Bitmap <span class="title">hunt</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (shouldReadFromMemoryCache(memoryPolicy)) &#123;</div><div class="line">      bitmap = cache.get(key);</div><div class="line">      <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">        stats.dispatchCacheHit();</div><div class="line">        loadedFrom = MEMORY;</div><div class="line">        <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">          log(OWNER_HUNTER, VERB_DECODED, data.logId(), <span class="string">"from cache"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> bitmap;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    data.networkPolicy = retryCount == <span class="number">0</span> ? NetworkPolicy.OFFLINE.index : networkPolicy;</div><div class="line">    RequestHandler.Result result = requestHandler.load(data, networkPolicy);</div><div class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line">      loadedFrom = result.getLoadedFrom();</div><div class="line">      exifRotation = result.getExifOrientation();</div><div class="line"></div><div class="line">      bitmap = result.getBitmap();</div><div class="line"></div><div class="line">      <span class="comment">// If there was no Bitmap then we need to decode it from the stream.</span></div><div class="line">      <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</div><div class="line">        InputStream is = result.getStream();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          bitmap = decodeStream(is, data);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          Utils.closeQuietly(is);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">        log(OWNER_HUNTER, VERB_DECODED, data.logId());</div><div class="line">      &#125;</div><div class="line">      stats.dispatchBitmapDecoded(bitmap);</div><div class="line">      <span class="keyword">if</span> (data.needsTransformation() || exifRotation != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (DECODE_LOCK) &#123;</div><div class="line">          <span class="keyword">if</span> (data.needsMatrixTransform() || exifRotation != <span class="number">0</span>) &#123;</div><div class="line">            bitmap = transformResult(data, bitmap, exifRotation);</div><div class="line">            <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">              log(OWNER_HUNTER, VERB_TRANSFORMED, data.logId());</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (data.hasCustomTransformations()) &#123;</div><div class="line">            bitmap = applyCustomTransformations(data.transformations, bitmap);</div><div class="line">            <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</div><div class="line">              log(OWNER_HUNTER, VERB_TRANSFORMED, data.logId(), <span class="string">"from custom transformations"</span>);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">          stats.dispatchBitmapTransformed(bitmap);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> bitmap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码实现确实很复杂，没事，先概括下其实现的主要小功能，再逐一解析：</p>
<ul>
<li><p>根据缓存策略判断是否从内存缓存读取 bitmap，true 表示直接读取并返回 bitmap；否则继续执行。</p>
</li>
<li><p>根据不同请求资源调用相应 RequestHandler 中 <strong>load()</strong> 方法下载图片，这里以网络请求资源为例子来讲解，即 NetworkRequestHandler。</p>
</li>
<li><p>从下载返回结果 RequestHandler.Result 获取 bitmap，判断是否为 null   做出相应的处理。</p>
</li>
</ul>
<p>重点来 NetworkRequestHandler 类 <strong>load()</strong> 方法具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">load</span><span class="params">(Request request, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Response response = downloader.load(request.uri, request.networkPolicy);</div><div class="line">    <span class="keyword">if</span> (response == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Picasso.LoadedFrom loadedFrom = response.cached ? DISK : NETWORK;</div><div class="line"></div><div class="line">    Bitmap bitmap = response.getBitmap();</div><div class="line">    <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Result(bitmap, loadedFrom);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    InputStream is = response.getInputStream();</div><div class="line">    <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Sometimes response content length is zero when requests are being replayed. Haven't found</span></div><div class="line">    <span class="comment">// root cause to this but retrying the request seems safe to do so.</span></div><div class="line">    <span class="keyword">if</span> (loadedFrom == DISK &amp;&amp; response.getContentLength() == <span class="number">0</span>) &#123;</div><div class="line">      Utils.closeQuietly(is);</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ContentLengthException(<span class="string">"Received response with 0 content-length header."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (loadedFrom == NETWORK &amp;&amp; response.getContentLength() &gt; <span class="number">0</span>) &#123;</div><div class="line">      stats.dispatchDownloadFinished(response.getContentLength());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(is, loadedFrom);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>第 3 行代码实现图片下载，即客户端发送网络请求，服务端对客户端的请求作出响应，客户端根据服务端返回的结果作出处理。那么是如何实现下载的呢？downloader 是 Downloader 实例，而 Downloader 是接口，无法实例化，需要在子类实例化，而该接口有两个实现类：OkHttpDownloader 和 UrlConnectionDownloader。至于调用哪个类 <strong>load()</strong> 方法，取决于当前 sdk 最低版本是否在 API 14及以上。这里以 OkHttpDownloader 类 <strong>load()</strong> 方法为例来讲解是如何实现下载的，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">load</span><span class="params">(Uri uri, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    CacheControl cacheControl = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (networkPolicy != <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (NetworkPolicy.isOfflineOnly(networkPolicy)) &#123;</div><div class="line">        cacheControl = CacheControl.FORCE_CACHE;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        CacheControl.Builder builder = <span class="keyword">new</span> CacheControl.Builder();</div><div class="line">        <span class="keyword">if</span> (!NetworkPolicy.shouldReadFromDiskCache(networkPolicy)) &#123;</div><div class="line">          builder.noCache();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!NetworkPolicy.shouldWriteToDiskCache(networkPolicy)) &#123;</div><div class="line">          builder.noStore();</div><div class="line">        &#125;</div><div class="line">        cacheControl = builder.build();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Request.Builder builder = <span class="keyword">new</span> Request.Builder().url(uri.toString());</div><div class="line">    <span class="keyword">if</span> (cacheControl != <span class="keyword">null</span>) &#123;</div><div class="line">      builder.cacheControl(cacheControl);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    com.squareup.okhttp.Response response = client.newCall(builder.build()).execute();</div><div class="line">    <span class="keyword">int</span> responseCode = response.code();</div><div class="line">    <span class="keyword">if</span> (responseCode &gt;= <span class="number">300</span>) &#123;</div><div class="line">      response.body().close();</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ResponseException(responseCode + <span class="string">" "</span> + response.message(), networkPolicy,</div><div class="line">          responseCode);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> fromCache = response.cacheResponse() != <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    ResponseBody responseBody = response.body();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Response(responseBody.byteStream(), fromCache, responseBody.contentLength());</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>第 3 - 17 行代码主要是设置缓存策略；第 24 行通过调用 OkHttp 库 API 实现图片下载任务，并返回响应结果 com.squareup.okhttp.Response；最后对响应结果作出相应处理并创建 Response 对象返回。</p>
<p>再回到 NetworkRequestHandler 类 <strong>load()</strong> 方法，从返回 Response 对象调用 <strong>getBitmap()</strong> 方法获取 Bitmap 对象并判断其是否为 null，如果不为 null，则将 bitmap 和 loadedfrom 传入 Result 构造器方法中，创建 Result 对象并返回；否则调用 <strong>getInputStream()</strong> 方法获取输入流，不为 null 的话则创建 Result 对象并返回。</p>
<p>回到 <strong>hunt()</strong> 方法，从返回结果 result 获取数据类型为 Bitmap 对象 bitmap，并判断其是否为 null 作出不同的处理。如果 bitmap 不为 null，则判断原先发送加载图片请求 Request 是否需要对图片进行转换处理，即裁剪、缩放、重置大小等；不需要的话直接返回 bitmap；需要的话做转换处理后再返回 bitmap；如果 bitmap 为 null，则从 result 获取输入流 InputStream，并对 is 进行解析转换成 Bitmap 类型，将获取到的结果返回。</p>
<p><strong>hunt()</strong> 方法解析完了，回到 <strong>run()</strong> 方法。根据调用方法 <strong>hunt()</strong> 返回结果 result，类型为 Bitmap，判断其是否为 null 并作出相应的处理。那么就来看下不为 null 的情况下又做了什么操作，即第 14 行代码，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchComplete</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</div><div class="line">    handler.sendMessage(handler.obtainMessage(HUNTER_COMPLETE, hunter));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很明显，又采用 Handler 消息机制处理，即 Dispatcher 类中 DispatcherHandler 发送消息 HUNTER_COMPLETE，其回调方法 <strong>handleMessage(final Message msg)</strong> 收到消息后并处理。说明一下，DispatcherHandler 所在的线程为子线程，即 DispatcherThread。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">        <span class="keyword">case</span> HUNTER_COMPLETE: &#123;</div><div class="line">          BitmapHunter hunter = (BitmapHunter) msg.obj;</div><div class="line">          dispatcher.performComplete(hunter);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            Picasso.HANDLER.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unknown handler message received: "</span> + msg.what);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在其回调方法中，核心代码是第 6 行，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">performComplete</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (shouldWriteToMemoryCache(hunter.getMemoryPolicy())) &#123;</div><div class="line">      cache.set(hunter.getKey(), hunter.getResult());</div><div class="line">    &#125;</div><div class="line">    hunterMap.remove(hunter.getKey());</div><div class="line">    batch(hunter);</div><div class="line">    <span class="keyword">if</span> (hunter.getPicasso().loggingEnabled) &#123;</div><div class="line">      log(OWNER_DISPATCHER, VERB_BATCHED, getLogIdsForHunter(hunter), <span class="string">"for completion"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据发送请求设置的内存缓存策略判断是否将其结果写入到内存中，并通过 key 从 hunterMap 移除 hunter，最后再对 hunter 作出处理，即 第 6 行代码，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">batch</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (hunter.isCancelled()) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    batch.add(hunter);</div><div class="line">    <span class="keyword">if</span> (!handler.hasMessages(HUNTER_DELAY_NEXT_BATCH)) &#123;</div><div class="line">      handler.sendEmptyMessageDelayed(HUNTER_DELAY_NEXT_BATCH, BATCH_DELAY);</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>看第 7 行代码，同时采用 Handler 消息机制发送消息，跟上面一样。最终会转到 Dispatcher 类 <strong>performBatchComplete()</strong> 方法，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">performBatchComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">    List&lt;BitmapHunter&gt; copy = <span class="keyword">new</span> ArrayList&lt;BitmapHunter&gt;(batch);</div><div class="line">    batch.clear();</div><div class="line">    mainThreadHandler.sendMessage(mainThreadHandler.obtainMessage(HUNTER_BATCH_COMPLETE, copy));</div><div class="line">    logBatch(copy);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>核心代码是第 4 行，同样才 Handler 消息机制发送消息，但是此时与之上有所不一样，即 mainThreadHandler 所在线程是主线程，也就是说，此时将任务从子线程切换到主线程，以便可以进行 UI 更新操作，那么赶快来看下在主线程是如何实现的？代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">        <span class="keyword">case</span> HUNTER_BATCH_COMPLETE: </div><div class="line">          <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) List&lt;BitmapHunter&gt; batch = (List&lt;BitmapHunter&gt;) msg.obj;</div><div class="line">          <span class="comment">//noinspection ForLoopReplaceableByForEach</span></div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = batch.size(); i &lt; n; i++) &#123;</div><div class="line">            BitmapHunter hunter = batch.get(i);</div><div class="line">            hunter.picasso.complete(hunter);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        </div><div class="line">         <span class="keyword">default</span>:</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unknown handler message received: "</span> + msg.what);        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据获取到 BitmapHunter 列表大小依次调用 Picasso 中 <strong>complete(BitmapHunter)</strong> 方法，那么又是怎样实现的呢，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">complete</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</div><div class="line">    Action single = hunter.getAction();</div><div class="line">    List&lt;Action&gt; joined = hunter.getActions();</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> hasMultiple = joined != <span class="keyword">null</span> &amp;&amp; !joined.isEmpty();</div><div class="line">    <span class="keyword">boolean</span> shouldDeliver = single != <span class="keyword">null</span> || hasMultiple;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!shouldDeliver) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Uri uri = hunter.getData().uri;</div><div class="line">    Exception exception = hunter.getException();</div><div class="line">    Bitmap result = hunter.getResult();</div><div class="line">    LoadedFrom from = hunter.getLoadedFrom();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (single != <span class="keyword">null</span>) &#123;</div><div class="line">      deliverAction(result, from, single);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasMultiple) &#123;</div><div class="line">      <span class="comment">//noinspection ForLoopReplaceableByForEach</span></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = joined.size(); i &lt; n; i++) &#123;</div><div class="line">        Action join = joined.get(i);</div><div class="line">        deliverAction(result, from, join);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (listener != <span class="keyword">null</span> &amp;&amp; exception != <span class="keyword">null</span>) &#123;</div><div class="line">      listener.onImageLoadFailed(<span class="keyword">this</span>, uri, exception);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从 hunter 获取单个 action、合并 actions 以及其它信息，比如 uri、exception 等。如果获取到的 action 不为空，则派发 action，即第 18 行代码，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deliverAction</span><span class="params">(Bitmap result, LoadedFrom from, Action action)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (action.isCancelled()) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!action.willReplay()) &#123;</div><div class="line">      targetToAction.remove(action.getTarget());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (from == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"LoadedFrom cannot be null."</span>);</div><div class="line">      &#125;</div><div class="line">      action.complete(result, from);</div><div class="line">      <span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">        log(OWNER_MAIN, VERB_COMPLETED, action.request.logId(), <span class="string">"from "</span> + from);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      action.error();</div><div class="line">      <span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">        log(OWNER_MAIN, VERB_ERRORED, action.request.logId());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从以上代码可以清晰地看出，根据 result 是否为空分别调用 Action 的回调方法，即 <strong>complete()</strong> 与 <strong>error()</strong>。先来看下 <strong>complete()</strong> 具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(Bitmap result, Picasso.LoadedFrom from)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(</div><div class="line">          String.format(<span class="string">"Attempted to complete action with no result!\n%s"</span>, <span class="keyword">this</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ImageView target = <span class="keyword">this</span>.target.get();</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Context context = picasso.context;</div><div class="line">    <span class="keyword">boolean</span> indicatorsEnabled = picasso.indicatorsEnabled;</div><div class="line">    PicassoDrawable.setBitmap(target, context, result, from, noFade, indicatorsEnabled);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</div><div class="line">      callback.onSuccess();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>逻辑很简单，前部分主要是做一些检查操作，真正核心代码是第 15 行代码，即将下载获取到的图片渲染到 UI 上，意味着成功地加载一张图片。那么 <strong>error()</strong> 方法又做了什么操作呢？具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">()</span> </span>&#123;</div><div class="line">    ImageView target = <span class="keyword">this</span>.target.get();</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (errorResId != <span class="number">0</span>) &#123;</div><div class="line">      target.setImageResource(errorResId);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (errorDrawable != <span class="keyword">null</span>) &#123;</div><div class="line">      target.setImageDrawable(errorDrawable);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</div><div class="line">      callback.onError();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>逻辑也很简单，如果我们有设置错误时显示图片的话，该方法就将错误时显示图片渲染出来。</p>
<p>那么这是单个 action 的处理逻辑，如果有合并 actions 的，执行的逻辑也一样，即对其进行遍历，获取单个 action，再派发 action，实现的代码在 <strong>complete(BitmapHunter)</strong> 方法第 21 - 27 行。</p>
<p>好吧， 使用 Picasso 开源框架成功加载一张图片的具体流程大概就这样了。由于自己能力水平有限，在讲解过程中难免有错误，如果您看到了，欢迎指正出来，大家一起学习，共同进步 ！！！</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://skykai521.github.io/2016/02/25/Picasso%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="external">http://skykai521.github.io/2016/02/25/Picasso%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/优秀开源框架/" rel="tag"># 优秀开源框架</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/21/JobScheduler-用法/" rel="next" title="JobScheduler 用法">
                <i class="fa fa-chevron-left"></i> JobScheduler 用法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/26/第-6-章-面向对象的程序设计/" rel="prev" title="第 6 章 面向对象的程序设计">
                第 6 章 面向对象的程序设计 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="PANJU" />
          <p class="site-author-name" itemprop="name">PANJU</p>
           
              <p class="site-description motion-element" itemprop="description">笔记——记录工作和学习中的点点滴滴</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/PanZeYong" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Picasso-使用方法"><span class="nav-number">1.</span> <span class="nav-text">Picasso 使用方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Picasso-源码解析"><span class="nav-number">2.</span> <span class="nav-text">Picasso 源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Picasso-with-方法解析"><span class="nav-number">2.1.</span> <span class="nav-text">Picasso.with() 方法解析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Picasso-Builder-中-build-方法解析"><span class="nav-number">2.1.1.</span> <span class="nav-text">Picasso.Builder 中 build() 方法解析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Picasso-load-方法解析"><span class="nav-number">2.2.</span> <span class="nav-text">Picasso.load() 方法解析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#into-方法解析"><span class="nav-number">2.3.</span> <span class="nav-text">into() 方法解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考资料"><span class="nav-number">3.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PANJU</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://panzeyong.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://panzeyong.github.io/2017/06/07/Picasso-用法及源码解析/';
          this.page.identifier = '2017/06/07/Picasso-用法及源码解析/';
          this.page.title = 'Picasso 用法及源码解析';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://panzeyong.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  













  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("b3EUStGjBwcKOJcOMeQXheDT-gzGzoHsz", "xvVsWacpT435FHV1QCcUpx9I");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
